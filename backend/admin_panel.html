<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulLink Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a; color: #e2e8f0; min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1e1b4b, #312e81);
            padding: 20px 32px; border-bottom: 1px solid #334155;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header h1 { font-size: 1.4rem; font-weight: 700; }
        .header h1 span { color: #a78bfa; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; }
        .status-text { font-size: 0.8rem; color: #94a3b8; }

        .auth-gate {
            max-width: 400px; margin: 80px auto; padding: 32px;
            background: #1e293b; border-radius: 16px; border: 1px solid #334155;
        }
        .auth-gate h2 { margin-bottom: 16px; font-size: 1.1rem; }
        .auth-input {
            width: 100%; padding: 10px 14px; background: #0f172a; border: 1px solid #334155;
            border-radius: 8px; color: #e2e8f0; font-size: 0.9rem; margin-bottom: 12px;
        }
        .auth-input:focus { outline: none; border-color: #7c3aed; }
        .auth-btn {
            width: 100%; padding: 10px; background: #7c3aed; color: white;
            border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600;
            cursor: pointer; transition: background 0.2s;
        }
        .auth-btn:hover { background: #6d28d9; }

        .container { max-width: 960px; margin: 0 auto; padding: 24px; }

        /* Stats Cards */
        .stats-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;
            margin-bottom: 28px;
        }
        .stat-card {
            background: #1e293b; border-radius: 12px; padding: 20px;
            border: 1px solid #334155;
        }
        .stat-card .label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card .value { font-size: 2rem; font-weight: 700; color: #a78bfa; margin-top: 4px; }

        /* API Section */
        .section { margin-bottom: 24px; }
        .section-title {
            font-size: 0.85rem; color: #94a3b8; text-transform: uppercase;
            letter-spacing: 1px; margin-bottom: 12px; padding-bottom: 8px;
            border-bottom: 1px solid #1e293b;
        }

        .api-card {
            background: #1e293b; border-radius: 12px; padding: 20px;
            border: 1px solid #334155; margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        .api-card:hover { border-color: #475569; }
        .api-card-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 8px;
        }
        .api-card-left { display: flex; align-items: center; gap: 10px; }
        .method-badge {
            padding: 3px 10px; border-radius: 6px; font-size: 0.7rem;
            font-weight: 700; letter-spacing: 0.5px;
        }
        .method-GET { background: #064e3b; color: #34d399; }
        .method-POST { background: #1e1b4b; color: #a78bfa; }
        .method-PUT { background: #78350f; color: #fbbf24; }
        .method-DELETE { background: #7f1d1d; color: #f87171; }
        .api-path { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.85rem; color: #e2e8f0; }
        .api-desc { font-size: 0.8rem; color: #94a3b8; margin-bottom: 12px; }

        .api-card-body { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #334155; }
        .api-card.open .api-card-body { display: block; }

        .param-group { margin-bottom: 12px; }
        .param-label { font-size: 0.75rem; color: #94a3b8; margin-bottom: 4px; }
        .param-input {
            width: 100%; padding: 8px 12px; background: #0f172a; border: 1px solid #334155;
            border-radius: 6px; color: #e2e8f0; font-size: 0.85rem;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }
        .param-input:focus { outline: none; border-color: #7c3aed; }
        textarea.param-input { min-height: 80px; resize: vertical; }

        .send-btn {
            padding: 8px 20px; background: #7c3aed; color: white; border: none;
            border-radius: 8px; font-size: 0.85rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .send-btn:hover { background: #6d28d9; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .send-btn.loading { background: #4c1d95; }

        .response-box {
            margin-top: 12px; background: #0f172a; border-radius: 8px;
            padding: 14px; font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.8rem; line-height: 1.5; overflow-x: auto;
            max-height: 400px; overflow-y: auto; display: none;
            border: 1px solid #334155;
        }
        .response-box.visible { display: block; }
        .response-box .status { margin-bottom: 8px; font-weight: 600; }
        .response-box .status.ok { color: #34d399; }
        .response-box .status.err { color: #f87171; }
        .response-box pre { white-space: pre-wrap; word-break: break-all; color: #cbd5e1; }

        .toggle-btn {
            background: none; border: 1px solid #475569; color: #94a3b8;
            padding: 4px 12px; border-radius: 6px; font-size: 0.75rem;
            cursor: pointer; transition: all 0.2s;
        }
        .toggle-btn:hover { border-color: #7c3aed; color: #a78bfa; }

        .hidden { display: none !important; }

        @media (max-width: 640px) {
            .stats-grid { grid-template-columns: 1fr; }
            .container { padding: 16px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>âš¡ <span>SoulLink</span> Admin Panel</h1>
        <div class="header-right">
            <div class="status-dot" id="status-dot"></div>
            <span class="status-text" id="status-text">Checking...</span>
        </div>
    </div>

    <!-- Auth Gate -->
    <div id="auth-gate" class="auth-gate">
        <h2>ğŸ” Admin Authentication</h2>
        <input type="password" class="auth-input" id="admin-secret" placeholder="Enter Admin Secret" onkeydown="if(event.key==='Enter')authenticate()">
        <button class="auth-btn" onclick="authenticate()">Enter</button>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="container hidden">

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">Users</div>
                <div class="value" id="stat-users">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Workspaces</div>
                <div class="value" id="stat-workspaces">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Feedbacks</div>
                <div class="value" id="stat-feedbacks">-</div>
            </div>
        </div>

        <!-- Admin APIs -->
        <div class="section">
            <div class="section-title">ğŸ›  Admin Operations</div>

            <div class="api-card" id="card-sync-all">
                <div class="api-card-header" onclick="toggleCard('card-sync-all')">
                    <div class="api-card-left">
                        <span class="method-badge method-POST">POST</span>
                        <span class="api-path">/api/admin/sync-all</span>
                    </div>
                    <button class="toggle-btn">Test</button>
                </div>
                <div class="api-desc">ä¸€é”®åŒæ­¥æ‰€æœ‰ç”¨æˆ·çš„ System Prompt + çŸ¥è¯†åº“æ–‡æ¡£</div>
                <div class="api-card-body">
                    <button class="send-btn" onclick="sendRequest('POST', '/api/admin/sync-all', null, this)">ğŸš€ Execute</button>
                    <div class="response-box" id="resp-sync-all"></div>
                </div>
            </div>

            <div class="api-card" id="card-sync-prompts">
                <div class="api-card-header" onclick="toggleCard('card-sync-prompts')">
                    <div class="api-card-left">
                        <span class="method-badge method-POST">POST</span>
                        <span class="api-path">/api/admin/sync-prompts</span>
                    </div>
                    <button class="toggle-btn">Test</button>
                </div>
                <div class="api-desc">åªåŒæ­¥ System Promptï¼ˆä¿ç•™ç”¨æˆ·æ€§æ ¼ã€è¯­è¨€ã€AIæ˜µç§°ï¼‰</div>
                <div class="api-card-body">
                    <button class="send-btn" onclick="sendRequest('POST', '/api/admin/sync-prompts', null, this)">ğŸš€ Execute</button>
                    <div class="response-box" id="resp-sync-prompts"></div>
                </div>
            </div>

            <div class="api-card" id="card-sync-docs">
                <div class="api-card-header" onclick="toggleCard('card-sync-docs')">
                    <div class="api-card-left">
                        <span class="method-badge method-POST">POST</span>
                        <span class="api-path">/api/admin/sync-documents</span>
                    </div>
                    <button class="toggle-btn">Test</button>
                </div>
                <div class="api-desc">å¢é‡åŒæ­¥çŸ¥è¯†åº“æ–‡æ¡£ï¼ˆåªæ·»åŠ ç¼ºå¤±æ–‡æ¡£ï¼Œä¸åˆ é™¤ï¼‰</div>
                <div class="api-card-body">
                    <button class="send-btn" onclick="sendRequest('POST', '/api/admin/sync-documents', null, this)">ğŸš€ Execute</button>
                    <div class="response-box" id="resp-sync-docs"></div>
                </div>
            </div>

            <div class="api-card" id="card-stats">
                <div class="api-card-header" onclick="toggleCard('card-stats')">
                    <div class="api-card-left">
                        <span class="method-badge method-GET">GET</span>
                        <span class="api-path">/api/admin/stats</span>
                    </div>
                    <button class="toggle-btn">Test</button>
                </div>
                <div class="api-desc">è·å–ç³»ç»Ÿç»Ÿè®¡æ•°æ®</div>
                <div class="api-card-body">
                    <button class="send-btn" onclick="sendRequest('GET', '/api/admin/stats', null, this)">ğŸš€ Execute</button>
                    <div class="response-box" id="resp-stats"></div>
                </div>
            </div>
        </div>

        <!-- Public APIs -->
        <div class="section">
            <div class="section-title">ğŸ“¡ Public API Endpoints</div>

            <div class="api-card" id="card-health">
                <div class="api-card-header" onclick="toggleCard('card-health')">
                    <div class="api-card-left">
                        <span class="method-badge method-GET">GET</span>
                        <span class="api-path">/health</span>
                    </div>
                    <button class="toggle-btn">Test</button>
                </div>
                <div class="api-desc">æœåŠ¡å¥åº·æ£€æŸ¥</div>
                <div class="api-card-body">
                    <button class="send-btn" onclick="sendRequest('GET', '/health', null, this, false)">ğŸš€ Execute</button>
                    <div class="response-box" id="resp-health"></div>
                </div>
            </div>

            <div class="api-card" id="card-models">
                <div class="api-card-header" onclick="toggleCard('card-models')">
                    <div class="api-card-left">
                        <span class="method-badge method-GET">GET</span>
                        <span class="api-path">/api/models</span>
                    </div>
                    <button class="toggle-btn">Test</button>
                </div>
                <div class="api-desc">è·å–å¯ç”¨ AI æ¨¡å‹åˆ—è¡¨</div>
                <div class="api-card-body">
                    <button class="send-btn" onclick="sendRequest('GET', '/api/models', null, this, false)">ğŸš€ Execute</button>
                    <div class="response-box" id="resp-models"></div>
                </div>
            </div>

            <div class="api-card" id="card-chat">
                <div class="api-card-header" onclick="toggleCard('card-chat')">
                    <div class="api-card-left">
                        <span class="method-badge method-POST">POST</span>
                        <span class="api-path">/api/chat</span>
                    </div>
                    <button class="toggle-btn">Test</button>
                </div>
                <div class="api-desc">å‘é€èŠå¤©æ¶ˆæ¯ï¼ˆéœ€è¦ç”¨æˆ· Tokenï¼‰</div>
                <div class="api-card-body">
                    <div class="param-group">
                        <div class="param-label">Authorization Token</div>
                        <input class="param-input" id="chat-token" placeholder="Bearer eyJ...">
                    </div>
                    <div class="param-group">
                        <div class="param-label">Message</div>
                        <input class="param-input" id="chat-message" placeholder="hello">
                    </div>
                    <button class="send-btn" onclick="sendChat(this)">ğŸš€ Execute</button>
                    <div class="response-box" id="resp-chat"></div>
                </div>
            </div>

            <div class="api-card" id="card-feedback">
                <div class="api-card-header" onclick="toggleCard('card-feedback')">
                    <div class="api-card-left">
                        <span class="method-badge method-POST">POST</span>
                        <span class="api-path">/api/feedback</span>
                    </div>
                    <button class="toggle-btn">Test</button>
                </div>
                <div class="api-desc">æäº¤ç”¨æˆ·åé¦ˆï¼ˆéœ€è¦ç”¨æˆ· Tokenï¼‰</div>
                <div class="api-card-body">
                    <div class="param-group">
                        <div class="param-label">Authorization Token</div>
                        <input class="param-input" id="feedback-token" placeholder="Bearer eyJ...">
                    </div>
                    <div class="param-group">
                        <div class="param-label">Body (JSON)</div>
                        <textarea class="param-input" id="feedback-body">{"type": "suggestion", "content": "test feedback"}</textarea>
                    </div>
                    <button class="send-btn" onclick="sendCustom('POST', '/api/feedback', 'feedback-token', 'feedback-body', this)">ğŸš€ Execute</button>
                    <div class="response-box" id="resp-feedback"></div>
                </div>
            </div>

            <div class="api-card" id="card-custom">
                <div class="api-card-header" onclick="toggleCard('card-custom')">
                    <div class="api-card-left">
                        <span class="method-badge method-POST" id="custom-method-badge">POST</span>
                        <span class="api-path">Custom Request</span>
                    </div>
                    <button class="toggle-btn">Test</button>
                </div>
                <div class="api-desc">è‡ªå®šä¹‰ API è¯·æ±‚</div>
                <div class="api-card-body">
                    <div class="param-group">
                        <div class="param-label">Method</div>
                        <select class="param-input" id="custom-method" onchange="document.getElementById('custom-method-badge').textContent=this.value;document.getElementById('custom-method-badge').className='method-badge method-'+this.value">
                            <option>GET</option><option selected>POST</option><option>PUT</option><option>DELETE</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <div class="param-label">Path</div>
                        <input class="param-input" id="custom-path" placeholder="/api/...">
                    </div>
                    <div class="param-group">
                        <div class="param-label">Authorization Token (optional)</div>
                        <input class="param-input" id="custom-token" placeholder="Bearer eyJ...">
                    </div>
                    <div class="param-group">
                        <div class="param-label">Body JSON (optional)</div>
                        <textarea class="param-input" id="custom-body" placeholder='{"key": "value"}'></textarea>
                    </div>
                    <button class="send-btn" onclick="sendCustomRequest(this)">ğŸš€ Execute</button>
                    <div class="response-box" id="resp-custom"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE = window.location.origin;
        let adminSecret = '';

        function authenticate() {
            adminSecret = document.getElementById('admin-secret').value;
            if (!adminSecret) return;
            // Verify by calling stats
            fetch(BASE + '/api/admin/stats', {
                headers: { 'X-Admin-Secret': adminSecret }
            }).then(r => {
                if (r.ok) {
                    document.getElementById('auth-gate').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    loadStats();
                    checkHealth();
                } else {
                    alert('Invalid admin secret');
                }
            }).catch(() => alert('Connection failed'));
        }

        function loadStats() {
            fetch(BASE + '/api/admin/stats', {
                headers: { 'X-Admin-Secret': adminSecret }
            }).then(r => r.json()).then(data => {
                document.getElementById('stat-users').textContent = data.users || 0;
                document.getElementById('stat-workspaces').textContent = data.workspaces || 0;
                document.getElementById('stat-feedbacks').textContent = data.feedbacks || 0;
            });
        }

        function checkHealth() {
            fetch(BASE + '/health').then(r => r.json()).then(data => {
                document.getElementById('status-dot').style.background = '#22c55e';
                document.getElementById('status-text').textContent = 'Online';
            }).catch(() => {
                document.getElementById('status-dot').style.background = '#f87171';
                document.getElementById('status-text').textContent = 'Offline';
            });
        }

        function toggleCard(id) {
            document.getElementById(id).classList.toggle('open');
        }

        async function sendRequest(method, path, body, btn, useAdmin = true) {
            const respId = 'resp-' + path.split('/').pop();
            const respBox = btn.parentElement.querySelector('.response-box');
            btn.disabled = true; btn.classList.add('loading'); btn.textContent = 'â³ Loading...';
            respBox.classList.add('visible');
            respBox.innerHTML = '<div class="status">Sending...</div>';

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (useAdmin) headers['X-Admin-Secret'] = adminSecret;

                const opts = { method, headers };
                if (body && method !== 'GET') opts.body = JSON.stringify(body);

                const start = Date.now();
                const resp = await fetch(BASE + path, opts);
                const ms = Date.now() - start;
                const data = await resp.json();

                const statusClass = resp.ok ? 'ok' : 'err';
                respBox.innerHTML = `<div class="status ${statusClass}">HTTP ${resp.status} â€” ${ms}ms</div><pre>${JSON.stringify(data, null, 2)}</pre>`;

                if (path.includes('stats') || path.includes('sync')) loadStats();
            } catch (e) {
                respBox.innerHTML = `<div class="status err">Error: ${e.message}</div>`;
            }
            btn.disabled = false; btn.classList.remove('loading'); btn.textContent = 'ğŸš€ Execute';
        }

        async function sendChat(btn) {
            const token = document.getElementById('chat-token').value;
            const message = document.getElementById('chat-message').value;
            const respBox = document.getElementById('resp-chat');
            if (!message) { alert('Enter a message'); return; }

            btn.disabled = true; btn.classList.add('loading'); btn.textContent = 'â³ Loading...';
            respBox.classList.add('visible');
            respBox.innerHTML = '<div class="status">Sending...</div>';

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = token.startsWith('Bearer') ? token : 'Bearer ' + token;

                const start = Date.now();
                const resp = await fetch(BASE + '/api/chat', {
                    method: 'POST', headers,
                    body: JSON.stringify({ message })
                });
                const ms = Date.now() - start;
                const data = await resp.json();
                const statusClass = resp.ok ? 'ok' : 'err';
                respBox.innerHTML = `<div class="status ${statusClass}">HTTP ${resp.status} â€” ${ms}ms</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (e) {
                respBox.innerHTML = `<div class="status err">Error: ${e.message}</div>`;
            }
            btn.disabled = false; btn.classList.remove('loading'); btn.textContent = 'ğŸš€ Execute';
        }

        async function sendCustom(method, path, tokenId, bodyId, btn) {
            const token = document.getElementById(tokenId).value;
            const bodyStr = document.getElementById(bodyId).value;
            const respBox = btn.parentElement.querySelector('.response-box');

            btn.disabled = true; btn.classList.add('loading'); btn.textContent = 'â³ Loading...';
            respBox.classList.add('visible');

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = token.startsWith('Bearer') ? token : 'Bearer ' + token;

                const start = Date.now();
                const resp = await fetch(BASE + path, {
                    method, headers,
                    body: bodyStr ? bodyStr : undefined
                });
                const ms = Date.now() - start;
                const data = await resp.json();
                const statusClass = resp.ok ? 'ok' : 'err';
                respBox.innerHTML = `<div class="status ${statusClass}">HTTP ${resp.status} â€” ${ms}ms</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (e) {
                respBox.innerHTML = `<div class="status err">Error: ${e.message}</div>`;
            }
            btn.disabled = false; btn.classList.remove('loading'); btn.textContent = 'ğŸš€ Execute';
        }

        async function sendCustomRequest(btn) {
            const method = document.getElementById('custom-method').value;
            const path = document.getElementById('custom-path').value;
            const token = document.getElementById('custom-token').value;
            const bodyStr = document.getElementById('custom-body').value;
            const respBox = document.getElementById('resp-custom');

            if (!path) { alert('Enter an API path'); return; }

            btn.disabled = true; btn.classList.add('loading'); btn.textContent = 'â³ Loading...';
            respBox.classList.add('visible');

            try {
                const headers = { 'Content-Type': 'application/json', 'X-Admin-Secret': adminSecret };
                if (token) headers['Authorization'] = token.startsWith('Bearer') ? token : 'Bearer ' + token;

                const opts = { method, headers };
                if (bodyStr && method !== 'GET') opts.body = bodyStr;

                const start = Date.now();
                const resp = await fetch(BASE + path, opts);
                const ms = Date.now() - start;
                let data;
                try { data = await resp.json(); } catch { data = await resp.text(); }
                const statusClass = resp.ok ? 'ok' : 'err';
                respBox.innerHTML = `<div class="status ${statusClass}">HTTP ${resp.status} â€” ${ms}ms</div><pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>`;
            } catch (e) {
                respBox.innerHTML = `<div class="status err">Error: ${e.message}</div>`;
            }
            btn.disabled = false; btn.classList.remove('loading'); btn.textContent = 'ğŸš€ Execute';
        }
    </script>
</body>
</html>
