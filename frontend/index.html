<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulLink - AI Companion</title>

    <!-- Google Sign-In SDK -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #7c3aed;
            --primary-light: #a78bfa;
            --bg-dark: #0f0f1a;
            --bg-card: #1a1a2e;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --border-color: #2a2a3e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        /* ==================== 登录页面 ==================== */
        #login-page {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-image: url('images/bg.png');
            background-size: cover;
            background-position: center;
            z-index: 1000;
        }

        #login-page::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: -1;
        }

        #login-page.hidden {
            display: none;
        }

        .login-container {
            text-align: center;
            width: 440px;
            max-width: 92vw;
            padding: 40px 50px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }

        .login-container:hover {
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }

        .login-container::-webkit-scrollbar {
            width: 6px;
        }

        .login-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .login-container::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 3px;
            transition: background 0.3s;
        }

        .login-container:hover::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
        }

        .login-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .login-lang-toggle {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 5px 12px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.85);
            border-radius: 6px;
            font-size: 0.78rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Poppins', sans-serif;
            letter-spacing: 0.3px;
        }
        .login-lang-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            color: #fff;
        }

        .login-container {
            position: relative;
        }

        .login-logo {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .login-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: rgba(255, 255, 255, 0.85);
            margin-bottom: 40px;
            font-size: 1.1rem;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }

        .google-login-btn {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 14px 28px;
            background: white;
            color: #333;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .google-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .google-login-btn svg {
            width: 20px;
            height: 20px;
        }

        /* 登录页社群链接 */
        .login-community-link {
            margin-top: 16px; text-align: center; cursor: pointer;
            font-size: 0.78rem; color: rgba(255,255,255,0.7);
            transition: color 0.2s;
        }
        .login-community-link:hover { color: #fff; }
        .login-community-qr {
            display: none; margin: 10px auto 0; width: 180px;
            border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.2);
        }
        .login-community-qr.show { display: block; }

        /* 聊天公告栏 */
        .announcement-bar {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 14px; margin: 0;
            background: rgba(255,255,255,0.45);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            font-size: 0.72rem; color: #5a6070;
        }
        .announcement-bar.hidden { display: none; }
        .announcement-text { flex: 1; }
        .announcement-link {
            color: #667eea; font-weight: 600; cursor: pointer;
            white-space: nowrap; font-size: 0.7rem;
        }
        .announcement-link:hover { text-decoration: underline; }
        .announcement-dismiss {
            background: none; border: none; color: #a0aec0; cursor: pointer;
            font-size: 0.8rem; padding: 0 2px; line-height: 1;
        }
        .announcement-dismiss:hover { color: #4a5568; }
        .announcement-never {
            background: none; border: none; color: #a0aec0; cursor: pointer;
            font-size: 0.62rem; white-space: nowrap;
        }
        .announcement-never:hover { color: #667eea; }

        /* Google One Tap 容器 */
        #g_id_onload {
            position: fixed;
            top: 20px;
            right: 20px;
        }

        /* ==================== 主应用 ==================== */
        #app {
            display: none;
            height: 100vh;
            position: relative;
            background: #1a1a2e;
        }

        #app .bg-layer {
            position: fixed;
            inset: 0;
            background-size: cover;
            background-position: center;
            z-index: 1;
            transition: opacity 0.6s ease;
            pointer-events: none;
        }
        #app .bg-layer.old {
            opacity: 0;
        }

        #app::before {
            content: '';
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.15);
            pointer-events: none;
            z-index: 2;
        }

        #app.active {
            display: flex;
        }

        /* 侧边栏 */
        .sidebar {
            width: 280px;
            background: rgba(60, 50, 80, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-logo {
            font-size: 1.5rem;
        }

        .lang-toggle-btn {
            margin-left: auto;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary);
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .lang-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffffff;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .new-chat-btn {
            margin: 16px;
            padding: 12px;
            background: linear-gradient(135deg, #9ca3db 0%, #b8a4d4 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(156, 163, 219, 0.3);
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 163, 219, 0.4);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }
        .conversations-list::-webkit-scrollbar {
            width: 4px;
        }
        .conversations-list::-webkit-scrollbar-track {
            background: transparent;
        }
        .conversations-list::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 4px;
            transition: background 0.3s;
        }
        .conversations-list.scrolling {
            scrollbar-color: rgba(0, 0, 0, 0.25) transparent;
        }
        .conversations-list.scrolling::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.25);
        }

        .conversation-item {
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: all 0.2s;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .conversation-item.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .conversation-content {
            flex: 1;
            min-width: 0;
        }

        .conversation-title {
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        .conversation-title-input {
            width: 100%;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 2px 6px;
            border: 1px solid rgba(100, 149, 237, 0.5);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.9);
            color: #4a5568;
            outline: none;
        }

        .conversation-time {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
        }

        .conversation-actions {
            display: none;
            gap: 4px;
            flex-shrink: 0;
        }

        .conversation-item:hover .conversation-actions {
            display: flex;
        }

        .conv-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
            color: rgba(255, 255, 255, 0.8);
        }

        .conv-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            color: #fff;
        }

        .conv-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }

        .conv-action-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            fill: none;
        }

        /* 用户信息 */
        .user-section {
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #ffffff;
        }

        .user-email {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .logout-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            color: #ffffff;
        }

        /* 主内容区 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            z-index: 10;
            min-height: 0;
            overflow: hidden;
        }

        /* 聊天头部 */
        .chat-header {
            padding: 16px 24px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
        }

        .companion-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s;
        }
        .companion-avatar:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        /* Companion Avatar Modal */
        .companion-avatar-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000;
            opacity: 0; pointer-events: none;
            transition: opacity 0.25s;
        }
        .companion-avatar-modal-overlay.active {
            opacity: 1; pointer-events: auto;
        }
        .companion-avatar-modal {
            background: white; border-radius: 20px; padding: 28px;
            width: 90%; max-width: 380px;
            transform: scale(0.9); transition: transform 0.25s;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .companion-avatar-modal-overlay.active .companion-avatar-modal {
            transform: scale(1);
        }
        .companion-avatar-modal h3 {
            font-size: 1.15rem; font-weight: 600; margin-bottom: 6px; color: #2d3748;
        }
        .companion-avatar-modal p {
            font-size: 0.85rem; color: #718096; margin-bottom: 18px;
        }
        .companion-avatar-preview-section {
            display: flex; align-items: center; gap: 20px; margin-bottom: 22px;
        }
        .companion-avatar-preview-img {
            width: 90px; height: 90px; border-radius: 50%; object-fit: cover;
            border: 3px solid #e2e8f0; flex-shrink: 0;
        }
        .companion-avatar-actions {
            display: flex; flex-direction: column; gap: 10px;
        }
        .companion-avatar-upload-btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 10px 18px; border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; font-size: 0.85rem; font-weight: 500;
            cursor: pointer; transition: opacity 0.2s;
        }
        .companion-avatar-upload-btn:hover { opacity: 0.85; }
        .companion-avatar-reset-btn {
            background: none; border: none; color: #a0aec0;
            font-size: 0.8rem; cursor: pointer; text-align: left;
            padding: 0; transition: color 0.2s;
        }
        .companion-avatar-reset-btn:hover { color: #718096; }
        .companion-avatar-modal-btns {
            display: flex; gap: 10px; justify-content: flex-end;
        }
        .companion-avatar-modal-btns button {
            padding: 8px 20px; border-radius: 10px; border: none;
            font-size: 0.9rem; cursor: pointer; font-weight: 500;
        }
        .companion-avatar-btn-cancel {
            background: #edf2f7; color: #4a5568;
        }
        .companion-avatar-btn-save {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .companion-info h2 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.8);
        }

        .companion-name-clickable {
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .companion-name-clickable:hover {
            color: var(--primary-color);
        }
        .companion-name-clickable:hover::after {
            content: '✏️';
            font-size: 0.7rem;
            margin-left: 6px;
            vertical-align: middle;
        }

        /* 改名弹窗 */
        .rename-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s;
        }
        .rename-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .rename-modal {
            background: rgba(40, 30, 60, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 32px;
            width: 360px;
            max-width: 90vw;
            transform: scale(0.9);
            transition: transform 0.25s;
        }
        .rename-modal-overlay.active .rename-modal {
            transform: scale(1);
        }
        .rename-modal h3 {
            color: #fff;
            font-size: 1.2rem;
            margin-bottom: 6px;
        }
        .rename-modal p {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            margin-bottom: 20px;
        }
        .rename-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }
        .rename-input:focus {
            border-color: var(--primary-light);
        }
        .rename-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }
        .rename-btns {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .rename-btn-cancel {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .rename-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        .rename-btn-save {
            flex: 1;
            padding: 10px;
            background: linear-gradient(135deg, #9c6aff, #7c3aed);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .rename-btn-save:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .companion-status {
            font-size: 0.9rem;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #4ade80;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.8);
        }

        /* 消息区域 */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        .message {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            max-width: 70%;
        }

        .message.user {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        .message-content {
            padding: 16px 20px;
            border-radius: 25px;
            line-height: 1.6;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .message.assistant .message-content {
            background: rgba(255, 255, 255, 0.92);
            color: #2d3748;
            border-bottom-left-radius: 8px;
        }

        .message.user .message-content {
            background: rgba(100, 149, 237, 0.85);
            color: white;
            border-bottom-right-radius: 8px;
        }

        /* Markdown 渲染样式 — AI消息气泡内 */
        .message.assistant .message-content p {
            margin: 0 0 8px 0;
        }
        .message.assistant .message-content p:last-child {
            margin-bottom: 0;
        }
        .message.assistant .message-content strong {
            font-weight: 700;
        }
        .message.assistant .message-content em {
            font-style: italic;
        }
        .message.assistant .message-content h1,
        .message.assistant .message-content h2,
        .message.assistant .message-content h3 {
            font-weight: 700;
            margin: 12px 0 6px 0;
            line-height: 1.3;
        }
        .message.assistant .message-content h1:first-child,
        .message.assistant .message-content h2:first-child,
        .message.assistant .message-content h3:first-child {
            margin-top: 0;
        }
        .message.assistant .message-content h1 { font-size: 1.15em; }
        .message.assistant .message-content h2 { font-size: 1.08em; }
        .message.assistant .message-content h3 { font-size: 1.02em; }
        .message.assistant .message-content ul,
        .message.assistant .message-content ol {
            margin: 6px 0;
            padding-left: 20px;
        }
        .message.assistant .message-content li {
            margin-bottom: 3px;
        }
        .message.assistant .message-content code {
            background: rgba(120, 90, 200, 0.08);
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.9em;
            font-family: 'Menlo', 'Consolas', monospace;
        }
        .message.assistant .message-content hr {
            border: none;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin: 10px 0;
        }
        .message.assistant .message-content blockquote {
            border-left: 3px solid rgba(120, 90, 200, 0.3);
            margin: 6px 0;
            padding: 2px 0 2px 10px;
            color: rgba(45, 55, 72, 0.7);
        }

        /* Thinking Toggle — 输入框上方的开关 */
        /* Thinking Bubble — AI消息气泡上方的折叠思考卡片，与AI气泡风格统一 */
        .thinking-bubble {
            /* 对齐：头像45px + gap12px + 左边距padding = 57px，与.message一致 */
            margin: -10px 0 6px 57px;
            max-width: calc(70% - 57px);
            border-radius: 16px;
            border-bottom-left-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.06);
        }

        .thinking-bubble .thinking-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 10px;
            font-size: 11px;
            font-weight: 500;
            color: rgba(120, 90, 200, 0.85);
            user-select: none;
        }

        .thinking-header-left {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .thinking-header-left .thinking-icon-brain {
            font-size: 11px;
        }

        .thinking-chevron {
            font-size: 8px;
            transition: transform 0.25s ease;
            color: rgba(120, 90, 200, 0.5);
        }

        .thinking-bubble:not(.collapsed) .thinking-chevron {
            transform: rotate(180deg);
        }

        .thinking-bubble .thinking-text {
            padding: 0 10px 8px;
            color: rgba(60, 50, 90, 0.7);
            font-size: 11px;
            line-height: 1.5;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        padding 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.2s ease;
        }

        .thinking-bubble .thinking-text p {
            margin: 0 0 4px 0;
        }
        .thinking-bubble .thinking-text p:last-child {
            margin-bottom: 0;
        }
        .thinking-bubble .thinking-text strong {
            color: rgba(60, 50, 90, 0.85);
            font-weight: 600;
        }
        .thinking-bubble .thinking-text em {
            color: rgba(120, 90, 200, 0.8);
        }
        .thinking-bubble .thinking-text ul,
        .thinking-bubble .thinking-text ol {
            margin: 3px 0;
            padding-left: 14px;
        }
        .thinking-bubble .thinking-text li {
            margin-bottom: 1px;
        }
        .thinking-bubble .thinking-text code {
            background: rgba(120, 90, 200, 0.08);
            color: rgba(100, 70, 180, 0.85);
            padding: 0 3px;
            border-radius: 2px;
            font-size: 10px;
        }

        .thinking-bubble .thinking-text::-webkit-scrollbar {
            width: 2px;
        }
        .thinking-bubble .thinking-text::-webkit-scrollbar-thumb {
            background: rgba(120, 90, 200, 0.15);
            border-radius: 2px;
        }

        .thinking-bubble.collapsed .thinking-text {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
        }

        .thinking-bubble:hover {
            background: rgba(255, 255, 255, 0.72);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* 微信风格时间分隔符 */
        .time-separator {
            display: flex;
            justify-content: center;
            padding: 8px 0 12px;
        }
        .time-separator span {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 10px;
            border-radius: 10px;
            letter-spacing: 0.02em;
        }

        /* 输入框 */
        .input-container {
            padding: 16px 24px 24px;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 24px;
            padding: 10px 10px 10px 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: border-radius 0.2s;
        }

        .input-wrapper:focus-within {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
        }

        #message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #2d3748;
            font-size: 1rem;
            outline: none;
            resize: none;
            max-height: 150px;
            min-height: 22px;
            height: 22px;
            line-height: 22px;
            font-family: 'Poppins', sans-serif;
            padding: 8px 0;
            margin: 0;
            overflow-y: hidden;
        }

        #message-input::placeholder {
            color: #a0aec0;
            line-height: 24px;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            background: linear-gradient(135deg, #9ca3db 0%, #b8a4d4 100%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 2px 10px rgba(156, 163, 219, 0.3);
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(156, 163, 219, 0.4);
        }

        .send-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        /* 附件上传按钮 */
        .attach-btn {
            width: 32px;
            height: 32px;
            min-width: 32px;
            background: none;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: #a0aec0;
            flex-shrink: 0;
            padding: 0;
        }
        .attach-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #718096;
        }
        .attach-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        /* 文件预览区 */
        .file-preview-bar {
            display: none;
            padding: 8px 12px 4px;
            gap: 8px;
            flex-wrap: wrap;
        }
        .file-preview-bar.has-files {
            display: flex;
        }
        .file-preview-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 12px;
            color: #4a5568;
            max-width: 180px;
            position: relative;
        }
        .file-preview-item img {
            width: 28px;
            height: 28px;
            object-fit: cover;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .file-preview-item .file-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(120, 90, 200, 0.1);
            border-radius: 4px;
            font-size: 14px;
            flex-shrink: 0;
        }
        .file-preview-item .file-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
        }
        .file-preview-item .file-remove {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.15);
            border: none;
            cursor: pointer;
            font-size: 10px;
            line-height: 16px;
            text-align: center;
            color: #4a5568;
            padding: 0;
            flex-shrink: 0;
            transition: background 0.15s;
        }
        .file-preview-item .file-remove:hover {
            background: rgba(220, 60, 60, 0.3);
            color: #c53030;
        }

        /* 拖拽上传覆盖层 */
        .drag-overlay {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(120, 90, 200, 0.12);
            border: 2px dashed rgba(120, 90, 200, 0.4);
            border-radius: 28px;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: rgba(120, 90, 200, 0.8);
            font-weight: 500;
            z-index: 10;
            pointer-events: none;
        }
        .input-wrapper.dragging .drag-overlay {
            display: flex;
        }

        /* 消息气泡中的附件 */
        .message-attachments {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }
        .message-attachments img {
            max-width: 180px;
            max-height: 140px;
            border-radius: 8px;
            object-fit: cover;
        }
        .message-attachment-file {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(0, 0, 0, 0.06);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            color: inherit;
            opacity: 0.8;
        }

        /* 加载动画 - typing indicator 带头像 */
        .typing-indicator {
            display: none;
            gap: 12px;
            margin-bottom: 20px;
            max-width: 70%;
        }

        .typing-indicator.visible {
            display: flex;
            align-items: flex-start;
        }

        .typing-indicator .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        .typing-bubble {
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.92);
            border-radius: 25px;
            border-bottom-left-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .typing-dots {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #a0aec0;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* 打字机效果的光标 */
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: #666;
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* 欢迎消息 */
        .welcome-message {
            text-align: center;
            padding: 60px 24px;
        }

        .welcome-emoji {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2d3748;
            text-shadow: 0 2px 10px rgba(255, 255, 255, 0.8);
        }

        .welcome-subtitle {
            color: #4a5568;
            max-width: 400px;
            margin: 0 auto;
            text-shadow: 0 1px 5px rgba(255, 255, 255, 0.5);
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            gap: 20px;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            text-align: center;
            max-width: 300px;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #9ca3db 0%, #b8a4d4 100%);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
            animation: progressPulse 2s ease-in-out infinite;
        }

        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== 移动端汉堡菜单按钮 ==================== */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: #4a5568;
            cursor: pointer;
            padding: 4px;
            flex-shrink: 0;
        }

        /* 侧边栏关闭按钮（仅手机端显示） */
        .sidebar-close-btn {
            display: none;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 4px;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .sidebar-close-btn:hover {
            color: #fff;
        }

        /* 侧边栏遮罩层 */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9;
        }

        /* ==================== 响应式 - 平板 ==================== */
        @media (max-width: 1024px) {
            .message {
                max-width: 80%;
            }

            .companion-info h2 {
                font-size: 1.15rem;
            }
        }

        /* ==================== 响应式 - 手机 ==================== */
        @media (max-width: 768px) {
            /* 修复手机浏览器100vh问题（地址栏高度） */
            #app {
                height: 100vh;
                height: 100dvh;
            }

            /* 汉堡菜单按钮 */
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* 侧边栏关闭按钮 */
            .sidebar-close-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* 侧边栏：默认隐藏，从左侧滑入 */
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 280px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 100;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .sidebar-overlay.active {
                display: block;
            }

            /* 登录页面 */
            .login-container {
                padding: 28px 24px;
                margin: 0 16px;
                max-width: 100%;
                border-radius: 20px;
            }

            .login-logo {
                font-size: 2.4rem;
            }

            .login-title {
                font-size: 1.8rem;
            }

            .login-subtitle {
                font-size: 0.95rem;
                margin-bottom: 28px;
            }

            .google-login-btn {
                padding: 12px 24px;
                font-size: 0.95rem;
            }

            .auth-form {
                max-width: 100%;
            }

            .auth-divider {
                margin: 18px 0;
            }

            /* 验证码输入框 */
            .verify-code-input {
                font-size: 1.3rem !important;
                letter-spacing: 6px !important;
            }

            /* 聊天头部 */
            .chat-header {
                padding: 12px 16px;
                gap: 10px;
            }

            .companion-avatar {
                width: 38px;
                height: 38px;
                border-width: 2px;
            }

            .companion-info h2 {
                font-size: 1.05rem;
            }

            .bg-picker-btn {
                padding: 6px;
            }

            .bg-picker-btn svg {
                width: 18px;
                height: 18px;
            }

            .bg-picker-panel {
                width: 260px;
                right: 4px;
                top: 64px;
            }

            .companion-status {
                font-size: 0.8rem;
            }

            .model-indicator {
                font-size: 0.6rem;
                padding: 1px 6px;
            }

            /* 消息区域 */
            .messages-container {
                padding: 16px 12px;
            }

            .message {
                max-width: 88%;
                gap: 8px;
                margin-bottom: 14px;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
            }

            .message-content {
                padding: 12px 16px;
                font-size: 0.92rem;
                border-radius: 20px;
            }

            .message.assistant .message-content {
                border-bottom-left-radius: 6px;
            }

            .message.user .message-content {
                border-bottom-right-radius: 6px;
            }

            .typing-indicator .message-avatar {
                width: 32px;
                height: 32px;
            }

            .typing-bubble {
                padding: 12px 16px;
                border-radius: 20px;
                border-bottom-left-radius: 6px;
            }

            /* 欢迎消息 */
            .welcome-message {
                padding: 40px 16px;
            }

            .welcome-emoji {
                font-size: 3rem;
            }

            .welcome-title {
                font-size: 1.2rem;
            }

            .welcome-subtitle {
                font-size: 0.9rem;
            }

            /* 输入框 */
            .input-container {
                padding: 10px 12px 16px;
            }

            .input-wrapper {
                padding: 8px 8px 8px 18px;
                gap: 8px;
                border-radius: 24px;
            }

            #message-input {
                font-size: 0.92rem;
            }

            .send-btn {
                width: 36px;
                height: 36px;
                min-width: 36px;
                min-height: 36px;
            }

            .send-btn svg {
                width: 17px;
                height: 17px;
            }

            /* 模态框 */
            .modal-content {
                width: 94%;
                max-width: 400px;
                border-radius: 16px;
            }

            .modal-header {
                padding: 16px 18px;
            }

            .modal-header h3 {
                font-size: 1.1rem;
            }

            .modal-body {
                padding: 18px;
            }

            .modal-footer {
                padding: 14px 18px;
            }

            /* 模型选择器 */
            .model-option {
                padding: 12px 14px;
                gap: 10px;
            }

            .model-option-icon {
                width: 36px;
                height: 36px;
                border-radius: 8px;
            }

            .model-option-icon img,
            .model-option-icon svg {
                width: 24px;
                height: 24px;
            }

            .model-option-name {
                font-size: 0.9rem;
            }

            /* 头像设置 */
            .settings-avatar-preview img {
                width: 64px;
                height: 64px;
            }

            .avatar-preset-grid {
                gap: 8px;
            }

            .avatar-preset {
                width: 42px;
                height: 42px;
            }

            /* 性格测试 */
            .question-container {
                max-width: 100%;
                width: 92%;
                padding: 16px;
            }

            .question-text {
                font-size: 18px;
                margin-bottom: 24px;
            }

            .question-option {
                padding: 14px 18px;
                font-size: 14px;
            }

            .question-progress {
                margin-bottom: 24px;
            }

            .progress-dot {
                width: 8px;
                height: 8px;
            }

            /* MBTI 网格 */
            .mbti-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }

            .mbti-option {
                padding: 10px 4px;
                font-size: 12px;
            }

            /* 塔罗牌 */
            .tarot-draw-container {
                padding: 16px;
            }

            .tarot-draw-title {
                font-size: 20px;
            }

            .tarot-draw-subtitle {
                font-size: 13px;
                margin-bottom: 24px;
            }

            .tarot-cards-row {
                gap: 14px;
                margin-bottom: 24px;
            }

            .tarot-card-slot {
                width: 120px;
                height: 200px;
            }

            .tarot-card-back .card-back-symbol {
                font-size: 36px;
            }

            .tarot-card-numeral {
                font-size: 16px;
                margin-bottom: 10px;
            }

            .tarot-card-icon {
                font-size: 36px;
                margin-bottom: 10px;
            }

            .tarot-card-name {
                font-size: 12px;
            }

            .tarot-card-name-zh {
                font-size: 10px;
            }

            .tarot-card-traits {
                font-size: 10px;
            }

            .view-results-btn {
                padding: 12px 36px;
                font-size: 15px;
            }

            /* 结果页面 */
            .results-container {
                width: 94%;
                padding: 16px 12px 32px;
            }

            .results-title {
                font-size: 22px;
                margin-bottom: 24px;
            }

            .results-cards-row {
                gap: 12px;
            }

            .result-card {
                width: 140px;
                padding: 16px 10px;
            }

            .result-card-name {
                font-size: 14px;
            }

            .results-profile {
                padding: 18px;
            }

            .results-profile h3 {
                font-size: 15px;
            }

            .results-profile p {
                font-size: 13px;
            }

            .start-chat-btn {
                padding: 14px 40px;
                font-size: 15px;
            }

            /* 提醒弹窗 */
            .reminder-content {
                padding: 28px 20px;
                max-width: 340px;
            }
        }

        /* ==================== 响应式 - 小屏手机 ==================== */
        @media (max-width: 400px) {
            .login-container {
                padding: 24px 18px;
                margin: 0 10px;
            }

            .login-title {
                font-size: 1.5rem;
            }

            .login-subtitle {
                font-size: 0.88rem;
            }

            .verify-code-input {
                font-size: 1.1rem !important;
                letter-spacing: 4px !important;
            }

            .chat-header {
                padding: 10px 12px;
                gap: 8px;
            }

            .companion-avatar {
                width: 34px;
                height: 34px;
            }

            .companion-info h2 {
                font-size: 0.95rem;
            }

            .messages-container {
                padding: 12px 8px;
            }

            .message {
                max-width: 92%;
            }

            .message-content {
                padding: 10px 14px;
                font-size: 0.88rem;
            }

            .input-container {
                padding: 8px 8px 12px;
            }

            .input-wrapper {
                padding: 6px 6px 6px 14px;
            }

            /* 塔罗牌 - 小屏 */
            .tarot-card-slot {
                width: 100px;
                height: 170px;
            }

            .tarot-card-icon {
                font-size: 28px;
            }

            .result-card {
                width: 100%;
                max-width: 280px;
            }

            .results-cards-row {
                flex-direction: column;
                align-items: center;
            }

            /* MBTI 小屏 */
            .mbti-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 4px;
            }

            .mbti-option {
                padding: 8px 2px;
                font-size: 11px;
                border-radius: 8px;
            }
        }

        /* ==================== 安全区域 (刘海屏) ==================== */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .input-container {
                padding-bottom: calc(16px + env(safe-area-inset-bottom));
            }

            @media (max-width: 768px) {
                .input-container {
                    padding-bottom: calc(12px + env(safe-area-inset-bottom));
                }
            }
        }

        /* ==================== 邮箱登录表单 ==================== */
        .auth-form {
            width: 100%;
            max-width: 400px;
            margin: 20px auto 0;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-tab.active {
            color: white;
            border-bottom: 2px solid rgba(255, 255, 255, 0.8);
        }

        .auth-tab:hover {
            color: white;
        }

        .form-group {
            margin-bottom: 16px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s;
        }

        .form-group input:focus {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.2);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .auth-submit-btn {
            width: 100%;
            padding: 14px;
            background: #e8b4b8;
            color: #5a4a4a;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .auth-submit-btn:hover {
            background: #d9a5a9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .auth-submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
        }

        .auth-divider span {
            padding: 0 16px;
        }

        .auth-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            display: none;
        }

        .auth-error.visible {
            display: block;
        }

        /* Verification Form */
        .verification-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .verification-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .verification-header h3 {
            color: white;
            font-size: 1.3rem;
            margin: 0 0 8px 0;
        }

        .verification-subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.88rem;
            margin: 0;
        }

        .verification-email {
            color: #e8b4b8;
            font-weight: 600;
            font-size: 0.95rem;
            margin: 4px 0 0 0;
        }

        .verify-code-input {
            text-align: center !important;
            font-size: 1.6rem !important;
            letter-spacing: 10px !important;
            font-family: 'Courier New', monospace !important;
            font-weight: 700 !important;
        }

        .verification-actions {
            margin-top: 20px;
            text-align: center;
        }

        .verification-resend-text {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            margin: 0 0 8px 0;
        }

        .resend-link {
            background: none;
            border: none;
            color: #e8b4b8;
            cursor: pointer;
            font-size: 0.85rem;
            text-decoration: underline;
            padding: 0;
        }

        .resend-link:disabled {
            color: rgba(255, 255, 255, 0.3);
            cursor: default;
            text-decoration: none;
        }

        .resend-timer {
            color: rgba(255, 255, 255, 0.35);
            font-size: 0.8rem;
            margin: 0 0 12px 0;
            display: none;
        }

        .back-link {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.45);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
        }

        .back-link:hover {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .login-container {
            animation: fadeInUp 0.6s ease-out;
        }

        .login-logo {
            animation: pulse 2s ease-in-out infinite;
        }

        /* Message animations */
        .message {
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Status indicator pulse */
        .status-dot {
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 10px 2px rgba(74, 222, 128, 0.5);
            }
        }

        /* 表单提示和必填标记 */
        .required {
            color: #f87171;
        }

        .form-hint {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
        }

        .modal-body .form-hint {
            color: rgba(0, 0, 0, 0.5);
        }

        /* 用户头像编辑 */
        .user-avatar-wrapper {
            position: relative;
            cursor: pointer;
        }

        .avatar-edit-icon {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background: rgba(156, 163, 219, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .avatar-edit-icon svg {
            stroke: white;
        }

        .user-avatar-wrapper:hover .avatar-edit-icon {
            opacity: 1;
        }

        /* 模态框样式 */
        .modal {
            position: fixed;
            inset: 0;
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal.hidden {
            display: none;
        }

        .modal-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
            scrollbar-width: none;
        }

        .modal-content::-webkit-scrollbar {
            display: none;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        .modal-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #718096;
            transition: color 0.2s;
        }

        .modal-close-btn:hover {
            color: #2d3748;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-body .form-group {
            margin-bottom: 16px;
        }

        .modal-body .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: #4a5568;
            font-weight: 500;
        }

        .modal-body .form-group input {
            width: 100%;
            padding: 10px 14px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #2d3748;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s;
        }

        .modal-body .form-group input:focus {
            border-color: #9ca3db;
            box-shadow: 0 0 0 3px rgba(156, 163, 219, 0.2);
        }

        .modal-body .form-group input:disabled {
            background: #edf2f7;
            color: #a0aec0;
            cursor: not-allowed;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.secondary {
            background: #edf2f7;
            border: none;
            color: #4a5568;
        }

        .modal-btn.secondary:hover {
            background: #e2e8f0;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #9ca3db 0%, #b8a4d4 100%);
            border: none;
            color: white;
            box-shadow: 0 2px 10px rgba(156, 163, 219, 0.3);
        }

        .modal-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(156, 163, 219, 0.4);
        }

        /* 模型选择器 */
        .model-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .model-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: #ffffff;
            border: 2px solid #e8ecf1;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .model-option:hover {
            border-color: #b8c0ff;
            background: #f8f8ff;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.08);
            transform: translateY(-1px);
        }

        .model-option.selected {
            border-color: #7c3aed;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.06), rgba(124, 58, 237, 0.02));
            box-shadow: 0 2px 12px rgba(124, 58, 237, 0.15);
        }

        .model-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .model-option-icon img,
        .model-option-icon svg {
            width: 28px;
            height: 28px;
        }

        .model-option-icon.gemini-icon {
            background: linear-gradient(135deg, #e8f0fe, #d2e3fc);
        }

        .model-option-icon.openai-icon {
            background: #202123;
        }

        .model-option-icon.grok-icon {
            background: #1a1a2e;
        }

        .model-option-info {
            flex: 1;
        }

        .model-option-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1a202c;
        }

        .model-option-desc {
            font-size: 0.75rem;
            color: #8895a7;
            margin-top: 2px;
        }

        .model-option-badge {
            font-size: 0.7rem;
            padding: 3px 10px;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.15), rgba(56, 161, 105, 0.1));
            color: #2f855a;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        /* 聊天头部模型标识 */
        .model-indicator {
            font-size: 0.7rem;
            padding: 2px 8px;
            background: rgba(124, 58, 237, 0.12);
            color: #7c3aed;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .model-indicator:hover {
            background: rgba(124, 58, 237, 0.22);
        }

        /* 头像设置区域 */
        .settings-avatar-section {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #eee;
        }

        .settings-avatar-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .settings-avatar-preview img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e2e8f0;
        }

        .avatar-upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #4a5568;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .avatar-upload-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .avatar-presets {
            margin-top: 16px;
        }

        .avatar-presets p {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 10px;
        }

        .avatar-preset-grid {
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .avatar-preset {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .avatar-preset:hover {
            border-color: #9ca3db;
            transform: scale(1.1);
        }

        .avatar-preset.selected {
            border-color: #9ca3db;
            box-shadow: 0 0 0 3px rgba(156, 163, 219, 0.3);
        }

        .avatar-color-preset {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .avatar-color-preset:hover {
            transform: scale(1.15);
            border-color: #9ca3db;
        }

        .avatar-color-preset.selected {
            border-color: #9ca3db;
            box-shadow: 0 0 0 3px rgba(156, 163, 219, 0.3);
        }

        /* ==================== 性格测试页面 ==================== */
        .personality-page {
            position: fixed;
            inset: 0;
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a0a2e 50%, #0a0a1a 100%);
            overflow-y: auto;
        }

        .personality-page.active {
            display: flex;
        }

        /* 星空背景 */
        .personality-page::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,0.4), transparent),
                radial-gradient(2px 2px at 40% 70%, rgba(255,255,255,0.3), transparent),
                radial-gradient(1px 1px at 60% 20%, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 80% 60%, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 10% 80%, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 50% 50%, rgba(255,255,255,0.4), transparent),
                radial-gradient(1px 1px at 70% 40%, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 90% 10%, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 30% 90%, rgba(255,255,255,0.4), transparent),
                radial-gradient(1px 1px at 15% 50%, rgba(255,255,255,0.3), transparent);
            pointer-events: none;
            animation: twinkle 4s ease-in-out infinite alternate;
        }

        @keyframes twinkle {
            0% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* 问题页面 */
        .question-container {
            position: relative;
            z-index: 1;
            max-width: 560px;
            width: 90%;
            text-align: center;
            padding: 20px;
        }

        .question-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s;
        }

        .progress-dot.filled {
            background: #a78bfa;
            box-shadow: 0 0 8px rgba(167,139,250,0.5);
        }

        .progress-dot.current {
            background: #c4b5fd;
            box-shadow: 0 0 12px rgba(196,181,253,0.6);
            transform: scale(1.3);
        }

        .progress-text {
            color: rgba(255,255,255,0.5);
            font-size: 14px;
            margin-left: 12px;
        }

        .question-text {
            font-size: 22px;
            font-weight: 500;
            color: #e8e0ff;
            margin-bottom: 36px;
            line-height: 1.5;
        }

        .question-options {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .skip-test-btn {
            display: block;
            margin: 28px auto 0;
            background: none;
            border: none;
            color: rgba(255,255,255,0.4);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 8px 16px;
            transition: color 0.2s;
        }
        .skip-test-btn:hover {
            color: rgba(255,255,255,0.7);
        }

        .question-option {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 18px 24px;
            color: #d4c8f0;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.25s;
            text-align: left;
        }

        .question-option:hover {
            background: rgba(167,139,250,0.15);
            border-color: rgba(167,139,250,0.4);
            transform: translateX(4px);
        }

        .question-option.selected {
            background: rgba(167,139,250,0.25);
            border-color: #a78bfa;
        }

        /* MBTI 网格 */
        .mbti-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .mbti-option {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 12px;
            padding: 12px 8px;
            color: #d4c8f0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s;
            text-align: center;
        }

        .mbti-option:hover {
            background: rgba(167,139,250,0.15);
            border-color: rgba(167,139,250,0.4);
        }

        .mbti-option.selected {
            background: rgba(167,139,250,0.25);
            border-color: #a78bfa;
        }

        .mbti-hint {
            color: rgba(255,255,255,0.4);
            font-size: 13px;
            margin-bottom: 16px;
        }

        .skip-btn {
            background: none;
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.5);
            padding: 10px 32px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .skip-btn:hover {
            border-color: rgba(255,255,255,0.4);
            color: rgba(255,255,255,0.7);
        }

        /* 塔罗牌抽取页面 */
        .tarot-draw-container {
            position: relative;
            z-index: 1;
            text-align: center;
            padding: 20px;
        }

        .tarot-draw-title {
            font-size: 24px;
            color: #e8e0ff;
            margin-bottom: 8px;
        }

        .tarot-draw-subtitle {
            color: rgba(255,255,255,0.5);
            font-size: 14px;
            margin-bottom: 40px;
        }

        .tarot-cards-row {
            display: flex;
            gap: 24px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 40px;
        }

        .tarot-card-slot {
            perspective: 800px;
            width: 160px;
            height: 260px;
        }

        .tarot-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .tarot-card-inner.flipped {
            transform: rotateY(180deg);
        }

        .tarot-card-inner.locked {
            cursor: default;
            opacity: 0.5;
        }

        .tarot-card-face {
            position: absolute;
            inset: 0;
            backface-visibility: hidden;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.15);
        }

        /* 牌背面 */
        .tarot-card-back {
            background: linear-gradient(135deg, #2d1b69 0%, #11001c 50%, #2d1b69 100%);
            box-shadow: 0 4px 24px rgba(100, 50, 200, 0.3);
        }

        .tarot-card-back .card-back-symbol {
            font-size: 48px;
            opacity: 0.6;
        }

        .tarot-card-back .card-back-text {
            color: rgba(255,255,255,0.3);
            font-size: 12px;
            margin-top: 12px;
        }

        /* 牌正面 */
        .tarot-card-front {
            transform: rotateY(180deg);
            padding: 16px;
            text-align: center;
        }

        .tarot-card-numeral {
            font-size: 20px;
            font-weight: 300;
            color: rgba(255,255,255,0.6);
            margin-bottom: 16px;
        }

        .tarot-card-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .tarot-card-name {
            font-size: 14px;
            font-weight: 600;
            color: #e8e0ff;
            margin-bottom: 4px;
        }

        .tarot-card-name-zh {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 12px;
        }

        .tarot-card-traits {
            font-size: 11px;
            color: rgba(255,255,255,0.4);
            line-height: 1.4;
        }

        .tarot-position-label {
            color: rgba(255,255,255,0.5);
            font-size: 13px;
            margin-top: 12px;
            font-weight: 500;
        }

        /* 22种卡牌渐变色 */
        .tarot-gradient-0  { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .tarot-gradient-1  { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .tarot-gradient-2  { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .tarot-gradient-3  { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .tarot-gradient-4  { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .tarot-gradient-5  { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
        .tarot-gradient-6  { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .tarot-gradient-7  { background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%); }
        .tarot-gradient-8  { background: linear-gradient(135deg, #fdcbf1 0%, #e6dee9 100%); }
        .tarot-gradient-9  { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); }
        .tarot-gradient-10 { background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); }
        .tarot-gradient-11 { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .tarot-gradient-12 { background: linear-gradient(135deg, #cfd9df 0%, #e2ebf0 100%); }
        .tarot-gradient-13 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .tarot-gradient-14 { background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); }
        .tarot-gradient-15 { background: linear-gradient(135deg, #f5576c 0%, #ff6f91 100%); }
        .tarot-gradient-16 { background: linear-gradient(135deg, #e8198b 0%, #c7eafd 100%); }
        .tarot-gradient-17 { background: linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%); }
        .tarot-gradient-18 { background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); }
        .tarot-gradient-19 { background: linear-gradient(135deg, #fddb92 0%, #d1fdff 100%); }
        .tarot-gradient-20 { background: linear-gradient(135deg, #9890e3 0%, #b1f4cf 100%); }
        .tarot-gradient-21 { background: linear-gradient(135deg, #ebc0fd 0%, #d9ded8 100%); }

        /* 查看结果按钮 */
        .view-results-btn {
            display: none;
            background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
            color: white;
            border: none;
            padding: 14px 48px;
            border-radius: 28px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
        }

        .view-results-btn.visible {
            display: inline-block;
            animation: fadeInUp 0.5s ease;
        }

        .view-results-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(124, 58, 237, 0.4);
        }

        /* 结果页面 */
        .results-container {
            position: relative;
            z-index: 1;
            max-width: 700px;
            width: 90%;
            text-align: center;
            padding: 20px 20px 40px;
        }

        .results-title {
            font-size: 26px;
            color: #e8e0ff;
            margin-bottom: 32px;
        }

        .results-cards-row {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 32px;
        }

        .result-card {
            width: 180px;
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .result-card-numeral {
            font-size: 16px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 8px;
        }

        .result-card-name {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 2px;
        }

        .result-card-name-zh {
            font-size: 13px;
            color: rgba(26,26,46,0.7);
            margin-bottom: 10px;
        }

        .result-card-position {
            font-size: 12px;
            color: rgba(26,26,46,0.6);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .result-card-traits {
            font-size: 12px;
            color: rgba(26,26,46,0.6);
            line-height: 1.5;
        }

        .results-profile {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            text-align: left;
        }

        .results-profile h3 {
            color: #c4b5fd;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .results-profile p {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            line-height: 1.7;
        }

        .start-chat-btn {
            background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
            color: white;
            border: none;
            padding: 16px 56px;
            border-radius: 28px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
        }

        .start-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(124, 58, 237, 0.4);
        }

        /* ===== 伴侣风格选择页面 ===== */
        .style-selection-container {
            text-align: center;
            padding: 40px 20px;
            max-width: 600px;
            width: 100%;
            z-index: 1;
        }
        .style-selection-title {
            font-size: 24px;
            color: #e2d5f3;
            margin-bottom: 8px;
        }
        .style-selection-subtitle {
            font-size: 15px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 36px;
        }
        .gender-cards {
            display: flex;
            gap: 24px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .gender-card {
            width: 200px;
            padding: 40px 24px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        .gender-card:hover {
            transform: translateY(-4px);
            border-color: rgba(124,58,237,0.5);
            box-shadow: 0 8px 32px rgba(124,58,237,0.2);
            background: rgba(124,58,237,0.1);
        }
        .gender-icon {
            font-size: 56px;
            margin-bottom: 16px;
        }
        .gender-card h3 {
            font-size: 18px;
            color: #e2d5f3;
            margin: 0;
        }
        .subtype-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            max-width: 520px;
            margin: 0 auto;
        }
        .subtype-card {
            padding: 28px 16px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        .subtype-card:hover {
            transform: translateY(-3px);
            border-color: rgba(124,58,237,0.5);
            box-shadow: 0 6px 24px rgba(124,58,237,0.2);
            background: rgba(124,58,237,0.1);
        }
        .subtype-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        .subtype-card h3 {
            font-size: 15px;
            color: #e2d5f3;
            margin: 0 0 6px 0;
        }
        .subtype-card p {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin: 0;
            line-height: 1.4;
        }

        /* 设置中的伴侣风格选择器 */
        .settings-style-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .settings-gender-row {
            display: flex;
            gap: 10px;
        }
        .gender-btn {
            flex: 1;
            padding: 12px 16px;
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            color: #4a5568;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
        }
        .gender-btn:hover {
            border-color: #b8c0ff;
            background: #f8f8ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.08);
        }
        .gender-btn.active {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(124, 58, 237, 0.03));
            border-color: #7c3aed;
            color: #7c3aed;
            box-shadow: 0 2px 12px rgba(124, 58, 237, 0.15);
        }
        .settings-subtype-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .subtype-btn {
            padding: 10px 14px;
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            color: #4a5568;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
            white-space: nowrap;
        }
        .subtype-btn:hover {
            border-color: #b8c0ff;
            background: #f8f8ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.08);
        }
        .subtype-btn.active {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(124, 58, 237, 0.03));
            border-color: #7c3aed;
            color: #7c3aed;
            box-shadow: 0 2px 12px rgba(124, 58, 237, 0.15);
            font-weight: 600;
        }

        /* ===== Background Picker ===== */
        .bg-picker-btn {
            margin-left: auto;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 10px;
            padding: 8px;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .bg-picker-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.05);
        }

        .bg-picker-btn svg {
            width: 20px;
            height: 20px;
        }

        .bg-picker-panel {
            position: fixed;
            right: 8px;
            top: 80px;
            width: 280px;
            max-height: 70vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 100;
            overflow: hidden;
            transform: translateX(110%);
            transition: transform 0.3s ease-out;
        }

        .bg-picker-panel.open {
            transform: translateX(0);
        }

        .bg-picker-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px 10px;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .bg-picker-header button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
            padding: 2px 6px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .bg-picker-header button:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #333;
        }

        .bg-thumb-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 12px;
            max-height: calc(70vh - 50px);
            overflow-y: auto;
        }

        .bg-thumb-grid::-webkit-scrollbar {
            width: 4px;
        }

        .bg-thumb-grid::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 4px;
        }

        .bg-thumb-item {
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 3/2;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .bg-thumb-item:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        }

        .bg-thumb-item.active {
            border-color: #7c3aed;
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.3);
        }

        .bg-thumb-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .bg-thumb-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 2px 4px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 9px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bg-thumb-item.active .bg-thumb-label {
            background: rgba(124, 58, 237, 0.8);
        }

        @media (max-width: 480px) {
            .gender-cards { flex-direction: column; align-items: center; }
            .gender-card { width: 180px; padding: 30px 20px; }
            .subtype-cards { grid-template-columns: 1fr; max-width: 280px; }
            .settings-subtype-row { grid-template-columns: 1fr 1fr; }
            .subtype-btn { font-size: 12px; padding: 8px 10px; }
        }

        /* 性格测试关闭按钮 */
        .personality-close-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2001;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .personality-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* 提醒弹窗 */
        .reminder-popup {
            position: fixed;
            inset: 0;
            z-index: 1500;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .reminder-popup.active {
            display: flex;
        }

        .reminder-content {
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 36px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .reminder-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .reminder-title {
            font-size: 20px;
            font-weight: 600;
            color: #e8e0ff;
            margin-bottom: 12px;
        }

        .reminder-message {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 28px;
        }

        .reminder-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .reminder-btn {
            padding: 12px 28px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reminder-btn.secondary {
            background: none;
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.6);
        }

        .reminder-btn.secondary:hover {
            border-color: rgba(255,255,255,0.4);
            color: rgba(255,255,255,0.8);
        }

        .reminder-btn.primary {
            background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
            border: none;
            color: white;
            box-shadow: 0 2px 12px rgba(124, 58, 237, 0.3);
        }

        .reminder-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(124, 58, 237, 0.4);
        }

        /* 侧边栏测试链接 */
        /* ==================== About Modal ==================== */
        .about-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: flex;
            align-items: center; justify-content: center;
            z-index: 10000; opacity: 0; pointer-events: none;
            transition: opacity 0.25s;
        }
        .about-modal-overlay.active { opacity: 1; pointer-events: auto; }
        .about-modal {
            background: white; border-radius: 20px;
            width: 90%; max-width: 440px; max-height: 80vh;
            transform: scale(0.9); transition: transform 0.25s;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); position: relative;
            display: flex; flex-direction: column;
        }
        .about-modal-header {
            padding: 24px 30px 0; flex-shrink: 0; position: relative;
        }
        .about-modal-body {
            padding: 0 30px 24px; overflow-y: auto; flex: 1;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .about-modal-body::-webkit-scrollbar { display: none; }
        .about-modal-overlay.active .about-modal { transform: scale(1); }
        .about-modal-close {
            position: absolute; top: 16px; right: 16px; background: none;
            border: none; cursor: pointer; color: #a0aec0; padding: 4px;
            border-radius: 6px; transition: all 0.2s;
        }
        .about-modal-close:hover { background: #f7fafc; color: #4a5568; }

        .about-section { text-align: center; margin-bottom: 20px; }
        .about-logo { font-size: 2.5rem; margin-bottom: 4px; }
        .about-section h2 { font-size: 1.5rem; font-weight: 700; color: #2d3748; margin: 0; }
        .about-tagline { color: #718096; font-size: 0.9rem; margin: 4px 0 0; }
        .about-version { color: #a0aec0; font-size: 0.75rem; margin-top: 2px; }
        .about-description { color: #4a5568; font-size: 0.85rem; line-height: 1.6; margin-bottom: 20px; text-align: center; }

        .about-donate-section { margin-bottom: 20px; }
        .about-donate-section h4 { font-size: 0.85rem; color: #a0aec0; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
        .about-donate-text { font-size: 0.8rem; color: #718096; margin-bottom: 12px; }
        .about-donate-buttons { display: flex; gap: 8px; }
        .about-donate-btn {
            display: inline-flex; align-items: center; gap: 6px; flex: 1;
            padding: 8px 12px; border-radius: 10px; border: 2px solid #e2e8f0;
            background: white; color: #4a5568; font-size: 0.82rem; font-weight: 500;
            cursor: pointer; transition: all 0.2s; text-decoration: none;
            justify-content: center;
        }
        .about-donate-btn svg { flex-shrink: 0; }
        .about-donate-btn:hover { border-color: #667eea; color: #667eea; }
        .about-donate-btn.active { border-color: #667eea; background: #ebf4ff; color: #667eea; }
        .about-donate-qr-container {
            margin-top: 14px; text-align: center; padding: 12px;
            background: #f7fafc; border-radius: 14px;
        }
        .about-donate-qr-img {
            max-width: 200px; width: 100%; border-radius: 10px;
        }

        .about-divider { height: 1px; background: #e2e8f0; margin: 20px 0; }

        .about-feedback-section { margin-bottom: 20px; }
        .about-feedback-section h4 { font-size: 0.85rem; color: #a0aec0; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
        .about-feedback-desc { font-size: 0.8rem; color: #718096; margin-bottom: 12px; }
        .about-feedback-type { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .feedback-type-btn {
            padding: 6px 14px; border-radius: 20px; border: 2px solid #e2e8f0;
            background: white; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 4px; color: #718096;
        }
        .feedback-type-btn:hover { border-color: #cbd5e0; }
        .feedback-type-btn.active { border-color: #667eea; background: #ebf4ff; color: #667eea; }
        .about-feedback-textarea {
            width: 100%; border: 2px solid #e2e8f0; border-radius: 12px;
            padding: 12px; font-size: 0.85rem; resize: vertical; font-family: inherit;
            transition: border-color 0.2s; color: #2d3748; box-sizing: border-box;
            min-height: 80px;
        }
        .about-feedback-textarea:focus { outline: none; border-color: #667eea; }
        .about-feedback-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .feedback-char-count { font-size: 0.75rem; color: #a0aec0; }
        .about-feedback-submit {
            padding: 8px 20px; border-radius: 10px; border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; font-size: 0.85rem; font-weight: 500;
            cursor: pointer; transition: opacity 0.2s;
        }
        .about-feedback-submit:hover { opacity: 0.85; }
        .about-feedback-submit:disabled { opacity: 0.5; cursor: not-allowed; }
        .feedback-success {
            display: flex; align-items: center; gap: 8px; justify-content: center;
            padding: 12px; background: #f0fff4; border-radius: 10px;
            color: #38a169; font-size: 0.85rem; margin-top: 10px;
        }

        .about-survey-section { margin-bottom: 20px; }
        .about-survey-section h4 { font-size: 0.85rem; color: #a0aec0; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
        .about-survey-text { font-size: 0.8rem; color: #718096; margin-bottom: 12px; }
        .about-survey-img {
            width: 100%; border-radius: 12px; cursor: pointer;
            transition: transform 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .about-survey-img:hover { transform: scale(1.02); }

        .about-community-section { margin-bottom: 4px; }
        .about-community-text { font-size: 0.82rem; color: #718096; margin: 0 0 12px; }
        .about-community-qr {
            width: 100%; max-width: 260px; display: block; margin: 0 auto;
            border-radius: 12px; cursor: pointer;
            transition: transform 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .about-community-qr:hover { transform: scale(1.02); }

        /* 社群弹窗 */
        .community-popup-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 10000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .community-popup-overlay.active { opacity: 1; pointer-events: auto; }
        .community-popup {
            background: #fff; border-radius: 20px; padding: 28px 24px;
            max-width: 320px; width: 90%; text-align: center;
            transform: scale(0.9); transition: transform 0.3s;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        .community-popup-overlay.active .community-popup { transform: scale(1); }
        .community-popup h3 { margin: 0 0 6px; font-size: 1.1rem; color: #2d3748; }
        .community-popup p { margin: 0 0 16px; font-size: 0.82rem; color: #718096; line-height: 1.5; }
        .community-popup img {
            width: 80%; max-width: 240px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .community-popup-close {
            margin-top: 16px; padding: 8px 32px; border: none;
            background: linear-gradient(135deg, #667eea, #764ba2); color: #fff;
            border-radius: 20px; font-size: 0.85rem; cursor: pointer;
            transition: opacity 0.2s;
        }
        .community-popup-close:hover { opacity: 0.85; }

        .about-footer { text-align: center; color: #a0aec0; font-size: 0.75rem; margin-top: 10px; }
        .about-footer p { margin: 0 0 6px; }
        .about-links a { color: #667eea; text-decoration: none; font-size: 0.75rem; }
        .about-links a:hover { text-decoration: underline; }

        /* ==================== 版本日志模态框 ==================== */
        .changelog-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: flex;
            align-items: center; justify-content: center;
            z-index: 10000; opacity: 0; pointer-events: none;
            transition: opacity 0.25s;
        }
        .changelog-modal-overlay.active { opacity: 1; pointer-events: auto; }
        .changelog-modal {
            background: white; border-radius: 20px;
            width: 90%; max-width: 440px; max-height: 80vh;
            transform: scale(0.9); transition: transform 0.25s;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); position: relative;
            display: flex; flex-direction: column;
        }
        .changelog-modal-overlay.active .changelog-modal { transform: scale(1); }
        .changelog-header {
            padding: 24px 30px 16px; flex-shrink: 0; position: relative;
            border-bottom: 1px solid #f0f0f0;
        }
        .changelog-header h2 {
            font-size: 1.3rem; font-weight: 700; color: #2d3748; margin: 0;
        }
        .changelog-header p {
            font-size: 0.8rem; color: #a0aec0; margin: 4px 0 0;
        }
        .changelog-close {
            position: absolute; top: 16px; right: 16px; background: none;
            border: none; cursor: pointer; color: #a0aec0; padding: 4px;
            border-radius: 6px; transition: all 0.2s;
        }
        .changelog-close:hover { background: #f7fafc; color: #4a5568; }
        .changelog-body {
            padding: 20px 30px 24px; overflow-y: auto; flex: 1;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .changelog-body::-webkit-scrollbar { display: none; }
        .changelog-version {
            margin-bottom: 20px;
        }
        .changelog-version-tag {
            display: inline-flex; align-items: center; gap: 8px;
            margin-bottom: 8px;
        }
        .changelog-version-tag span.ver {
            background: linear-gradient(135deg, #7c3aed, #a78bfa);
            color: white; padding: 3px 10px; border-radius: 12px;
            font-size: 0.78rem; font-weight: 600;
        }
        .changelog-version-tag span.date {
            color: #a0aec0; font-size: 0.75rem;
        }
        .changelog-list {
            list-style: none; padding: 0; margin: 0;
        }
        .changelog-list li {
            position: relative; padding: 4px 0 4px 20px;
            font-size: 0.78rem; color: #4a5568; line-height: 1.6;
            display: flex; align-items: baseline;
        }
        .changelog-list li::before {
            content: ''; position: absolute; left: 4px; top: 12px;
            width: 6px; height: 6px; border-radius: 50%;
            background: #a78bfa;
        }
        .changelog-badge {
            display: inline-block; padding: 1px 0; border-radius: 4px;
            font-size: 0.65rem; font-weight: 600; margin-right: 8px;
            min-width: 36px; text-align: center; flex-shrink: 0;
        }
        .badge-feat { background: #e0e7ff; color: #4f46e5; }
        .badge-fix { background: #fef3c7; color: #d97706; }
        .badge-ui { background: #ede9fe; color: #7c3aed; }

        .hidden { display: none !important; }

        .sidebar-bottom-links {
            padding: 4px 12px;
        }
        .sidebar-test-link {
            display: block;
            padding: 8px 16px;
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        .sidebar-test-link:hover {
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.9);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text"></div>
        <div class="loading-progress" id="loading-progress" style="display: none;">
            <div class="loading-progress-bar" id="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="login-page">
        <div class="login-container">
            <button class="login-lang-toggle" id="login-lang-toggle" onclick="toggleLanguage()">中文</button>
            <div class="login-logo">💫</div>
            <h1 class="login-title">SoulLink</h1>
            <p class="login-subtitle" data-i18n="login.subtitle">Your AI Companion, Always Here</p>

            <!-- Email Login/Register Form -->
            <div class="auth-form">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')" data-i18n="login.tab.signin">Sign In</button>
                    <button class="auth-tab" onclick="switchAuthTab('register')" data-i18n="login.tab.signup">Sign Up</button>
                </div>

                <div id="auth-error" class="auth-error"></div>

                <!-- Login Form -->
                <form id="login-form" onsubmit="handleEmailLogin(event)">
                    <div class="form-group">
                        <label data-i18n="login.email">Email</label>
                        <input type="email" id="login-email" data-i18n="login.email.placeholder" data-i18n-attr="placeholder" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="login.password">Password</label>
                        <input type="password" id="login-password" data-i18n="login.password.placeholder" data-i18n-attr="placeholder" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="auth-submit-btn" id="login-submit-btn" data-i18n="login.submit">Sign In</button>
                </form>

                <!-- Register Form -->
                <form id="register-form" style="display: none;" onsubmit="handleEmailRegister(event)">
                    <div class="form-group">
                        <label><span data-i18n="register.nickname.label">What should Abigail call you?</span> <span class="required">*</span></label>
                        <input type="text" id="register-name" data-i18n="register.nickname.placeholder" data-i18n-attr="placeholder" placeholder="Your nickname" required minlength="2" maxlength="20">
                        <div class="form-hint" data-i18n="register.nickname.hint">This is how your AI companion will address you</div>
                    </div>
                    <div class="form-group">
                        <label><span data-i18n="register.email.label">Email</span> <span class="required">*</span></label>
                        <input type="email" id="register-email" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label><span data-i18n="register.password.label">Password</span> <span class="required">*</span></label>
                        <input type="password" id="register-password" data-i18n="register.password.placeholder" data-i18n-attr="placeholder" placeholder="At least 6 characters" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label><span data-i18n="register.confirm.label">Confirm Password</span> <span class="required">*</span></label>
                        <input type="password" id="register-password-confirm" data-i18n="register.confirm.placeholder" data-i18n-attr="placeholder" placeholder="Re-enter your password" required minlength="6">
                    </div>
                    <button type="submit" class="auth-submit-btn" id="register-submit-btn" data-i18n="register.submit">Create Account</button>
                </form>

                <!-- Email Verification Form -->
                <div id="verification-form" style="display: none;">
                    <div class="verification-header">
                        <div class="verification-icon">&#9993;</div>
                        <h3 data-i18n="verify.title">Check your email</h3>
                        <p class="verification-subtitle" data-i18n="verify.subtitle">We sent a 6-digit code to</p>
                        <p class="verification-email" id="verification-email-display"></p>
                    </div>

                    <div id="verify-error" class="auth-error"></div>

                    <div class="form-group">
                        <label data-i18n="verify.code.label">Verification Code</label>
                        <input type="text" id="verify-code-input"
                               maxlength="6" pattern="[0-9]{6}" inputmode="numeric"
                               placeholder="000000" autocomplete="one-time-code"
                               class="verify-code-input"
                               onkeydown="if(event.key==='Enter')handleVerifyCode()">
                    </div>

                    <button class="auth-submit-btn" id="verify-submit-btn" onclick="handleVerifyCode()">
                        <span data-i18n="verify.submit">Verify</span>
                    </button>

                    <div class="verification-actions">
                        <p class="verification-resend-text">
                            <span data-i18n="verify.no_code">Didn't receive the code?</span>
                            <button id="resend-btn" onclick="handleResendCode()" class="resend-link">
                                <span data-i18n="verify.resend">Resend</span>
                            </button>
                        </p>
                        <p id="resend-timer" class="resend-timer"></p>
                        <button onclick="backToRegister()" class="back-link">
                            &#8592; <span data-i18n="verify.back">Back to registration</span>
                        </button>
                    </div>
                </div>

                <div class="auth-divider">
                    <span data-i18n="login.divider">or</span>
                </div>
            </div>

            <button class="google-login-btn" onclick="signInWithGoogle()">
                <svg viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span data-i18n="login.google">Continue with Google</span>
            </button>

            <div class="login-community-link">
                <span data-i18n="login.community">💬 Join our WeChat community</span>
                <img src="images/wechat_group_qr.jpg" alt="WeChat Group" class="login-community-qr" id="login-community-qr">
            </div>
        </div>

        <!-- Google One Tap -->
        <div id="g_id_onload"
             data-client_id=""
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleGoogleCredential"
             data-auto_prompt="false">
        </div>
    </div>

    <!-- AI改名弹窗 -->
    <div class="rename-modal-overlay" id="rename-modal">
        <div class="rename-modal">
            <h3 data-i18n="rename.title">Rename your companion</h3>
            <p data-i18n="rename.subtitle">Give her a name you like</p>
            <input type="text" class="rename-input" id="rename-input"
                   maxlength="20" placeholder="Abigail"
                   onkeydown="if(event.key==='Enter')saveCompanionName()">
            <div class="rename-btns">
                <button class="rename-btn-cancel" onclick="closeRenameModal()" data-i18n="rename.cancel">Cancel</button>
                <button class="rename-btn-save" onclick="saveCompanionName()" data-i18n="rename.save">Save</button>
            </div>
        </div>
    </div>

    <!-- 版本日志模态框 -->
    <div class="changelog-modal-overlay" id="changelog-modal">
        <div class="changelog-modal">
            <div class="changelog-header">
                <button class="changelog-close" onclick="closeChangelogModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <h2 data-i18n="changelog.title">Changelog</h2>
                <p>SoulLink Release Notes</p>
            </div>
            <div class="changelog-body">

                <!-- v0.0.6-beta -->
                <div class="changelog-version">
                    <div class="changelog-version-tag">
                        <span class="ver">v0.0.6-beta</span>
                        <span class="date">2026-02-21</span>
                    </div>
                    <ul class="changelog-list">
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v160.1">Name your companion during registration — make them truly yours</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v160.2">Choose your AI model at signup — Gemini, GPT-4o, or Grok</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v160.3">Skip personality test — jump straight into chatting, take it later anytime</span></li>
                        <li><span class="changelog-badge badge-ui">UI</span> <span data-i18n="changelog.v160.4">Auto-resize chat input — expands as you type, like WeChat</span></li>
                        <li><span class="changelog-badge badge-ui">UI</span> <span data-i18n="changelog.v160.6">Redesigned model selector with official brand icons</span></li>
                        <li><span class="changelog-badge badge-fix">FIX</span> <span data-i18n="changelog.v160.5">Increased chat memory to 30 messages for deeper conversations</span></li>
                        <li><span class="changelog-badge badge-fix">FIX</span> <span data-i18n="changelog.v150.1">Fixed model switch losing memory & relationship data</span></li>
                        <li><span class="changelog-badge badge-fix">FIX</span> <span data-i18n="changelog.v150.2">Fixed new workspaces defaulting to wrong AI provider</span></li>
                        <li><span class="changelog-badge badge-fix">FIX</span> <span data-i18n="changelog.v150.3">Enhanced Gemini thinking content filter for edge cases</span></li>
                    </ul>
                </div>

                <!-- v0.0.5-beta -->
                <div class="changelog-version">
                    <div class="changelog-version-tag">
                        <span class="ver">v0.0.5-beta</span>
                        <span class="date">2026-02-20</span>
                    </div>
                    <ul class="changelog-list">
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v140.1">File upload in chat — send images & documents to AI</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v140.2">AI Thinking Process — see Gemini's reasoning before it replies (Gemini only)</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v140.3">Markdown rendering — AI replies now show bold, headings, lists & more</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v140.4">WeChat-style timestamps — time separators auto-appear between messages</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v140.5">Grok 4.1 — a more intimate & unfiltered companion experience</span></li>
                        <li><span class="changelog-badge badge-fix">FIX</span> <span data-i18n="changelog.v140.6">Fixed Gemini thinking content leaking into chat replies</span></li>
                        <li><span class="changelog-badge badge-ui">UI</span> <span data-i18n="changelog.v140.7">Optimized thinking bubble design</span></li>
                    </ul>
                </div>

                <!-- v0.0.4-beta -->
                <div class="changelog-version">
                    <div class="changelog-version-tag">
                        <span class="ver">v0.0.4-beta</span>
                        <span class="date">2026-02-19</span>
                    </div>
                    <ul class="changelog-list">
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v130.1">AI Memory (Basic) — your companion can now remember key facts about you</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v130.2">Trust Device — stay logged in for 90 days, no more repeated logins</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v130.3">Chat background picker — 15 curated wallpapers to choose from</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v130.4">Companion gender & personality — boyfriend or girlfriend with 4 unique styles</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v130.5">AI auto-generates conversation titles based on chat content</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v130.7">Web Search — AI can now search the internet for real-time weather, news & more</span></li>
                        <li><span class="changelog-badge badge-fix">FIX</span> <span data-i18n="changelog.v130.6">Smarter session handling & major stability improvements</span></li>
                    </ul>
                </div>

                <!-- v0.0.3-beta -->
                <div class="changelog-version">
                    <div class="changelog-version-tag">
                        <span class="ver">v0.0.3-beta</span>
                        <span class="date">2026-02-17</span>
                    </div>
                    <ul class="changelog-list">
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v120.1">About & Feedback page with donation support (Zelle / WeChat / Alipay)</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v120.2">Custom companion avatar — click to upload your own image</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v120.3">Smart companion rename — rename via chat conversation</span></li>
                        <li><span class="changelog-badge badge-ui">UI</span> <span data-i18n="changelog.v120.4">Personality test now has close button</span></li>
                        <li><span class="changelog-badge badge-ui">UI</span> <span data-i18n="changelog.v120.5">Sidebar layout & spacing improvements</span></li>
                    </ul>
                </div>

                <!-- v0.0.2-beta -->
                <div class="changelog-version">
                    <div class="changelog-version-tag">
                        <span class="ver">v0.0.2-beta</span>
                        <span class="date">2026-02-15</span>
                    </div>
                    <ul class="changelog-list">
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v110.1">AI model selection — switch between GPT-4o & Gemini</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v110.2">Email verification with 6-digit code</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v110.3">Comprehensive mobile responsive layout</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v110.4">Language toggle on login page</span></li>
                        <li><span class="changelog-badge badge-fix">FIX</span> <span data-i18n="changelog.v110.5">Model switch stability improvements</span></li>
                    </ul>
                </div>

                <!-- v0.0.1-beta -->
                <div class="changelog-version">
                    <div class="changelog-version-tag">
                        <span class="ver">v0.0.1-beta</span>
                        <span class="date">2026-02-04</span>
                    </div>
                    <ul class="changelog-list">
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v100.1">Personality test & tarot card feature</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v100.2">Google OAuth login</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v100.3">Real-time AI chat with personalized companion</span></li>
                        <li><span class="changelog-badge badge-feat">NEW</span> <span data-i18n="changelog.v100.4">Bilingual support (English / 中文)</span></li>
                    </ul>
                </div>

            </div>
        </div>
    </div>

    <!-- About & Feedback 模态框 -->
    <div class="about-modal-overlay" id="about-modal">
        <div class="about-modal">
            <div class="about-modal-header">
                <button class="about-modal-close" onclick="closeAboutModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
                <div class="about-section">
                    <h2>SoulLink</h2>
                    <p class="about-tagline" data-i18n="about.tagline">Your AI Soul Companion</p>
                    <p class="about-version">v0.0.6-beta</p>
                </div>
            </div>

            <div class="about-modal-body">
            <div class="about-description">
                <p data-i18n="about.description">SoulLink is an AI companion platform that creates meaningful connections through personalized conversations. Built with love by the SoulForge team.</p>
            </div>

            <!-- 社群 -->
            <div class="about-community-section">
                <h4 data-i18n="about.community">Join Our Community</h4>
                <p class="about-community-text" data-i18n="about.community.desc">Join our WeChat group for updates, feedback & discussion!</p>
                <img src="images/wechat_group_qr.jpg" alt="WeChat Group QR" class="about-community-qr" onclick="window.open(this.src, '_blank')">
            </div>

            <div class="about-divider"></div>

            <!-- 打赏 -->
            <div class="about-donate-section">
                <h4 data-i18n="about.support">Support Us</h4>
                <p class="about-donate-text" data-i18n="about.support.desc">If you enjoy SoulLink, consider buying us a coffee!</p>
                <div class="about-donate-buttons">
                    <button class="about-donate-btn" onclick="showDonateQR('zelle')" data-active="false">
                        <img src="paytous/zelle_icon.png" width="20" height="20" alt="Zelle" style="border-radius: 50%;">
                        Zelle
                    </button>
                    <button class="about-donate-btn" onclick="showDonateQR('wechat')" data-active="false">
                        <img src="paytous/wechat_pay_icon.png" width="20" height="20" alt="WeChat Pay">
                        <span data-i18n="about.wechat">WeChat</span>
                    </button>
                    <button class="about-donate-btn" onclick="showDonateQR('alipay')" data-active="false">
                        <img src="paytous/alipay_icon.png" width="20" height="20" alt="Alipay" style="border-radius: 4px;">
                        <span data-i18n="about.alipay">Alipay</span>
                    </button>
                </div>
                <div class="about-donate-qr-container hidden" id="donate-qr-container">
                    <img id="donate-qr-img" class="about-donate-qr-img" src="" alt="QR Code">
                </div>
            </div>

            <div class="about-divider"></div>

            <!-- 意见反馈 -->
            <div class="about-feedback-section">
                <h4 data-i18n="about.feedback">Feedback</h4>
                <div class="about-feedback-type">
                    <button class="feedback-type-btn active" data-type="suggestion" onclick="selectFeedbackType(this)">
                        <span>💡</span> <span data-i18n="about.feedback.suggestion">Suggestion</span>
                    </button>
                    <button class="feedback-type-btn" data-type="bug" onclick="selectFeedbackType(this)">
                        <span>🐛</span> <span data-i18n="about.feedback.bug">Bug Report</span>
                    </button>
                    <button class="feedback-type-btn" data-type="other" onclick="selectFeedbackType(this)">
                        <span>💬</span> <span data-i18n="about.feedback.other">Other</span>
                    </button>
                </div>
                <textarea id="feedback-text" class="about-feedback-textarea" rows="3" maxlength="1000" data-i18n="about.feedback.placeholder" data-i18n-attr="placeholder" placeholder="Tell us what you think..."></textarea>
                <div class="about-feedback-footer">
                    <span class="feedback-char-count" id="feedback-char-count">0/1000</span>
                    <button class="about-feedback-submit" onclick="submitFeedback()" data-i18n="about.feedback.submit">Submit Feedback</button>
                </div>
                <div class="feedback-success hidden" id="feedback-success">
                    <span>✅</span> <span data-i18n="about.feedback.thanks">Thank you for your feedback!</span>
                </div>
            </div>

            <div class="about-divider"></div>

            <!-- 调查问卷 -->
            <div class="about-survey-section">
                <h4 data-i18n="about.survey">Survey</h4>
                <p class="about-survey-text" data-i18n="about.survey.desc">Help us improve — take our quick 4-5 min survey!</p>
                <img src="images/survey.png" alt="Survey QR Code" class="about-survey-img" onclick="window.open(this.src, '_blank')">
            </div>

            <div class="about-footer">
                <p><a href="https://www.soulforgetech.com" target="_blank" style="color: inherit; text-decoration: none;">© 2026 SoulForge Tech</a></p>
                <a href="mailto:contact@soulforgetech.com">contact@soulforgetech.com</a>
            </div>
            </div><!-- /about-modal-body -->
        </div><!-- /about-modal -->
    </div><!-- /about-modal-overlay -->

    <!-- 社群弹窗 -->
    <div class="community-popup-overlay" id="community-popup">
        <div class="community-popup">
            <h3 data-i18n="community.popup.title">Join Our Community</h3>
            <p data-i18n="community.popup.desc">Scan to join our WeChat group for updates & feedback!</p>
            <img src="images/wechat_group_qr.jpg" alt="WeChat Group QR">
            <br>
            <button class="community-popup-close" onclick="closeCommunityPopup()" data-i18n="community.popup.close">Got it</button>
        </div>
    </div>

    <!-- Companion 头像修改模态框 -->
    <div class="companion-avatar-modal-overlay" id="companion-avatar-modal">
        <div class="companion-avatar-modal">
            <h3 data-i18n="companion.avatar.title">Change Companion Avatar</h3>
            <div class="companion-avatar-preview-section">
                <img id="companion-avatar-preview" class="companion-avatar-preview-img" src="images/avatar.png" alt="Preview">
                <div class="companion-avatar-actions">
                    <label class="companion-avatar-upload-btn" for="companion-avatar-upload">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <span data-i18n="companion.avatar.upload">Upload Image</span>
                    </label>
                    <input type="file" id="companion-avatar-upload" accept="image/*" style="display:none;" onchange="handleCompanionAvatarUpload(event)">
                    <button class="companion-avatar-reset-btn" onclick="resetCompanionAvatar()" data-i18n="companion.avatar.reset">Reset to Default</button>
                </div>
            </div>
            <div class="companion-avatar-modal-btns">
                <button class="companion-avatar-btn-cancel" onclick="closeCompanionAvatarModal()" data-i18n="rename.cancel">Cancel</button>
                <button class="companion-avatar-btn-save" onclick="saveCompanionAvatar()" data-i18n="rename.save">Save</button>
            </div>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-overlay" onclick="closeSettingsModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="settings.title">Profile Settings</h3>
                <button class="modal-close-btn" onclick="closeSettingsModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-avatar-section">
                    <div class="settings-avatar-preview">
                        <img id="settings-avatar-img" src="images/avatar.png" alt="Avatar">
                        <label class="avatar-upload-btn" for="avatar-upload">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <span data-i18n="settings.upload">Upload</span>
                        </label>
                        <input type="file" id="avatar-upload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                    </div>
                    <div class="avatar-presets">
                        <p data-i18n="settings.color">Or choose a color:</p>
                        <div class="avatar-preset-grid">
                            <div class="avatar-color-preset" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="selectColorAvatar('#667eea')"></div>
                            <div class="avatar-color-preset" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" onclick="selectColorAvatar('#f093fb')"></div>
                            <div class="avatar-color-preset" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);" onclick="selectColorAvatar('#4facfe')"></div>
                            <div class="avatar-color-preset" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);" onclick="selectColorAvatar('#43e97b')"></div>
                            <div class="avatar-color-preset" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);" onclick="selectColorAvatar('#fa709a')"></div>
                            <div class="avatar-color-preset" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);" onclick="selectColorAvatar('#a8edea')"></div>
                        </div>
                    </div>
                </div>
                <div class="settings-form">
                    <div class="form-group">
                        <label data-i18n="settings.nickname">Nickname (How Abigail calls you)</label>
                        <input type="text" id="settings-name" data-i18n="settings.nickname.placeholder" data-i18n-attr="placeholder" placeholder="Your nickname" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label data-i18n="settings.email">Email</label>
                        <input type="email" id="settings-email" disabled>
                        <div class="form-hint" data-i18n="settings.email.hint">Email cannot be changed</div>
                    </div>
                    <div class="form-group">
                        <label data-i18n="settings.model">AI Model</label>
                        <div class="model-selector" id="model-selector">
                            <!-- 由 JS 动态填充 -->
                        </div>
                        <div class="form-hint" data-i18n="settings.model.hint">Choose the AI model that powers Abigail</div>
                    </div>
                    <div class="form-group">
                        <label data-i18n="settings.companion.style">Companion Style</label>
                        <div class="settings-style-selector">
                            <div class="settings-gender-row">
                                <button class="gender-btn" data-gender="female" onclick="toggleSettingsGender('female')">💃 <span data-i18n="companion.gender.her">Her</span></button>
                                <button class="gender-btn" data-gender="male" onclick="toggleSettingsGender('male')">🕺 <span data-i18n="companion.gender.him">Him</span></button>
                            </div>
                            <div class="settings-subtype-row" id="settings-subtype-row">
                                <!-- 由 JS 动态填充 -->
                            </div>
                        </div>
                        <div class="form-hint" data-i18n="settings.companion.hint">Changes will update your companion's personality</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeSettingsModal()" data-i18n="settings.cancel">Cancel</button>
                <button class="modal-btn primary" onclick="saveSettings()" data-i18n="settings.save">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- 性格测试 - 问题页面 -->
    <div id="personality-test-page" class="personality-page">
        <button class="personality-close-btn" onclick="closePersonalityTest()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        <div class="question-container">
            <div class="question-progress" id="question-progress"></div>
            <div class="question-text" id="question-text"></div>
            <div class="question-options" id="question-options"></div>
            <button class="skip-test-btn" onclick="skipPersonalityTest()" data-i18n="test.skip">Skip for now →</button>
        </div>
    </div>

    <!-- 性格测试 - 塔罗牌抽取页面 -->
    <div id="tarot-draw-page" class="personality-page">
        <button class="personality-close-btn" onclick="closePersonalityTest()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        <div class="tarot-draw-container">
            <h2 class="tarot-draw-title" id="tarot-draw-title"></h2>
            <p class="tarot-draw-subtitle" id="tarot-draw-subtitle"></p>
            <div class="tarot-cards-row" id="tarot-cards-row"></div>
            <button class="view-results-btn" id="view-results-btn" onclick="showTarotResults()"></button>
        </div>
    </div>

    <!-- 性格测试 - 结果页面 -->
    <div id="tarot-results-page" class="personality-page">
        <button class="personality-close-btn" onclick="closePersonalityTest()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        <div class="results-container">
            <h2 class="results-title" id="results-title"></h2>
            <div class="results-cards-row" id="results-cards-row"></div>
            <div class="results-profile" id="results-profile"></div>
            <button class="start-chat-btn" onclick="showGenderSelection()"></button>
        </div>
    </div>

    <!-- 伴侣风格选择 - 第1步：性别 -->
    <div id="gender-selection-page" class="personality-page">
        <div class="style-selection-container">
            <h2 class="style-selection-title" id="gender-selection-title">选择你的伴侣类型</h2>
            <p class="style-selection-subtitle" id="gender-selection-subtitle">你希望你的灵魂伴侣是...？</p>
            <div class="gender-cards">
                <div class="gender-card" onclick="selectGender('female')">
                    <div class="gender-icon">💃</div>
                    <h3 data-i18n="companion.gender.her">Her</h3>
                </div>
                <div class="gender-card" onclick="selectGender('male')">
                    <div class="gender-icon">🕺</div>
                    <h3 data-i18n="companion.gender.him">Him</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- 伴侣风格选择 - 第2步：子类型 -->
    <div id="subtype-selection-page" class="personality-page">
        <div class="style-selection-container">
            <h2 class="style-selection-title" id="subtype-title">选择她的性格</h2>
            <div class="subtype-cards" id="subtype-cards">
                <!-- 由 JS 动态填充 -->
            </div>
        </div>
    </div>

    <!-- 伴侣取名 + 模型选择页面 -->
    <div id="companion-naming-page" class="personality-page" style="background: url('images/bg.png') center/cover no-repeat; position: fixed; inset: 0;">
        <!-- 暗色遮罩层 -->
        <div style="position: absolute; inset: 0; background: rgba(10, 10, 26, 0.65); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 0;"></div>
        <div class="style-selection-container" style="text-align: center; position: relative; z-index: 1;">
            <h2 class="style-selection-title" data-i18n="naming.title">Give your companion a name</h2>
            <p style="color: #8a94a6; font-size: 0.9rem; margin-bottom: 24px;" data-i18n="naming.subtitle">You can always change it later in settings</p>
            <input type="text" id="companion-name-input"
                   style="width: 80%; max-width: 280px; padding: 12px 16px; border: 2px solid rgba(255,255,255,0.15); border-radius: 12px; font-size: 1.1rem; text-align: center; outline: none; transition: border-color 0.2s; background: rgba(255,255,255,0.08); color: #fff; backdrop-filter: blur(10px);"
                   onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='rgba(255,255,255,0.15)'"
                   placeholder="Abigail" maxlength="20">

            <!-- 模型选择 -->
            <h3 style="color: #c4c9d4; font-size: 0.95rem; margin: 28px 0 14px; font-weight: 500;" data-i18n="naming.model.title">Choose an AI model</h3>
            <div id="onboarding-model-selector" style="display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 360px; margin: 0 auto;"></div>

            <div style="margin-top: 24px;">
                <button onclick="confirmCompanionName()"
                        style="padding: 12px 40px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 12px; font-size: 1rem; cursor: pointer; font-weight: 600; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);"
                        data-i18n="naming.confirm">Start Chatting ✨</button>
            </div>
        </div>
    </div>

    <!-- 性格测试提醒弹窗 -->
    <div id="test-reminder-popup" class="reminder-popup">
        <div class="reminder-content">
            <div class="reminder-icon">🔮</div>
            <h3 class="reminder-title" data-i18n="reminder.title">Discover Your Soul Match</h3>
            <p class="reminder-message" data-i18n="reminder.message">Take a quick personality test so Abigail can truly understand you.</p>
            <div class="reminder-buttons">
                <button class="reminder-btn secondary" onclick="dismissReminder()" data-i18n="reminder.later">Maybe Later</button>
                <button class="reminder-btn primary" onclick="startPersonalityTest()" data-i18n="reminder.start">Take the Test</button>
            </div>
        </div>
    </div>

    <!-- 主应用 -->
    <div id="app">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-logo">💫</span>
                <span class="sidebar-title">SoulLink</span>
                <button class="lang-toggle-btn" id="lang-toggle" onclick="toggleLanguage()">中文</button>
                <button class="sidebar-close-btn" onclick="closeMobileSidebar()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <button class="new-chat-btn" onclick="createNewConversation()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span data-i18n="sidebar.newchat">New Chat</span>
            </button>

            <div class="conversations-list" id="conversations-list">
                <!-- 动态填充 -->
            </div>

            <div class="sidebar-bottom-links">
                <button class="sidebar-test-link" onclick="startPersonalityTest()" data-i18n="sidebar.test">Personality Test</button>
                <button class="sidebar-test-link" onclick="openChangelogModal()" data-i18n="sidebar.changelog">Changelog</button>
                <button class="sidebar-test-link" onclick="openAboutModal()" data-i18n="sidebar.about">About & Feedback</button>
            </div>

            <div class="user-section">
                <div class="user-avatar-wrapper" onclick="openSettingsModal()">
                    <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
                    <div class="avatar-edit-icon">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </div>
                </div>
                <div class="user-info" onclick="openSettingsModal()" style="cursor: pointer;">
                    <div id="user-name" class="user-name"></div>
                    <div id="user-email" class="user-email"></div>
                </div>
                <button class="logout-btn" onclick="logout()" data-i18n="sidebar.logout">Logout</button>
            </div>
        </aside>
        <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 聊天头部 -->
            <header class="chat-header">
                <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <img class="companion-avatar" id="header-companion-avatar" src="images/avatar.png" alt="Companion" onclick="openCompanionAvatarModal()" title="Click to change avatar">
                <div class="companion-info">
                    <h2 id="companion-name-display" class="companion-name-clickable" onclick="openRenameModal()" title="Click to rename">Abigail</h2>
                    <div class="companion-status">
                        <span class="status-dot"></span>
                        <span data-i18n="chat.online">Online</span>
                        <span class="model-indicator" id="model-indicator" onclick="openSettingsModal()">Gemini 2.5 Flash</span>
                    </div>
                </div>
                <button class="bg-picker-btn" onclick="toggleBgPicker()" title="Change background">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                </button>
            </header>

            <!-- 公告栏 -->
            <div class="announcement-bar" id="announcement-bar">
                <span class="announcement-text" data-i18n="announcement.community">💬 Join our WeChat community for updates & feedback!</span>
                <span class="announcement-link" onclick="openCommunityFromBanner()" data-i18n="announcement.view">View</span>
                <button class="announcement-never" onclick="dismissAnnouncement(true)" data-i18n="announcement.never">Don't show again</button>
            </div>

            <!-- 背景选择面板 -->
            <div class="bg-picker-panel" id="bg-picker-panel">
                <div class="bg-picker-header">
                    <span data-i18n="bg.picker.title">Background</span>
                    <button onclick="toggleBgPicker()">✕</button>
                </div>
                <div class="bg-thumb-grid" id="bg-thumb-grid">
                    <!-- JS 动态生成 -->
                </div>
            </div>

            <!-- 消息区域 -->
            <div class="messages-container" id="messages-container">
                <div class="welcome-message" id="welcome-message">
                    <div class="welcome-emoji">👋</div>
                    <h2 class="welcome-title" data-i18n="chat.welcome.title">Welcome back!</h2>
                    <p class="welcome-subtitle" data-i18n="chat.welcome.subtitle">Start a conversation with your AI companion. I'm here to chat, help, and keep you company.</p>
                </div>

                <div class="typing-indicator" id="typing-indicator">
                    <img class="message-avatar" src="images/avatar.png" alt="Abigail">
                    <div class="typing-bubble">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thinking toggle removed — thinking bubbles always shown with collapse/expand -->

            <!-- 输入框 -->
            <div class="input-container">
                <input type="file" id="file-input" multiple accept="image/png,image/jpeg,image/gif,image/webp,.pdf,.txt,.md,.csv,.json" style="display:none" onchange="handleFileSelect(event)">
                <div class="file-preview-bar" id="file-preview-bar"></div>
                <div class="input-wrapper" id="input-wrapper">
                    <div class="drag-overlay" data-i18n="chat.drop.hint">Drop files here</div>
                    <button class="attach-btn" onclick="document.getElementById('file-input').click()" title="Attach file">
                        <svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6h-1.5v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6H16.5z"/></svg>
                    </button>
                    <textarea
                        id="message-input"
                        data-i18n="chat.input.placeholder" data-i18n-attr="placeholder"
                        placeholder="Type a message..."
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                    <button class="send-btn" id="send-btn" onclick="sendMessage()">
                        <svg viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ==================== 配置 ====================
        const CONFIG = {
            // 后端 API 地址 - 部署时需要修改
            API_BASE_URL: 'https://api.soulforgetech.com',
            // Google Client ID - 部署时需要修改
            GOOGLE_CLIENT_ID: '594679782289-12l51teae0va12nhe406ogs5jteui9ga.apps.googleusercontent.com'
        };

        // ==================== 国际化 ====================
        const TRANSLATIONS = {
            en: {
                'login.subtitle': 'Your AI Companion, Always Here',
                'login.tab.signin': 'Sign In',
                'login.tab.signup': 'Sign Up',
                'login.email': 'Email',
                'login.password': 'Password',
                'login.email.placeholder': 'your@email.com',
                'login.password.placeholder': 'Enter your password',
                'login.submit': 'Sign In',
                'register.nickname.label': 'What should your companion call you?',
                'register.nickname.placeholder': 'Your nickname',
                'register.nickname.hint': 'You can name your AI companion after registration',
                'register.email.label': 'Email',
                'register.password.label': 'Password',
                'register.password.placeholder': 'At least 6 characters',
                'register.confirm.label': 'Confirm Password',
                'register.confirm.placeholder': 'Re-enter your password',
                'register.submit': 'Create Account',
                'verify.title': 'Check your email',
                'verify.subtitle': 'We sent a 6-digit code to',
                'verify.code.label': 'Verification Code',
                'verify.submit': 'Verify',
                'verify.no_code': "Didn't receive the code?",
                'verify.resend': 'Resend',
                'verify.back': 'Back to registration',
                'login.divider': 'or',
                'login.google': 'Continue with Google',
                'settings.title': 'Profile Settings',
                'settings.upload': 'Upload',
                'settings.color': 'Or choose a color:',
                'settings.nickname': 'Nickname (How {companion} calls you)',
                'settings.nickname.placeholder': 'Your nickname',
                'settings.email': 'Email',
                'settings.email.hint': 'Email cannot be changed',
                'settings.model': 'AI Model',
                'settings.model.hint': 'Choose the AI model that powers {companion}',
                'settings.cancel': 'Cancel',
                'settings.save': 'Save Changes',
                'sidebar.newchat': 'New Chat',
                'sidebar.logout': 'Logout',
                'sidebar.test': 'Personality Test',
                'chat.online': 'Online',
                'chat.welcome.title': 'Welcome back!',
                'chat.welcome.subtitle': 'Start a conversation with your AI companion. I\'m here to chat, help, and keep you company.',
                'chat.input.placeholder': 'Type a message...',
                'chat.drop.hint': 'Drop files here',
                'chat.file.too_large': 'File too large (max 10MB)',
                'chat.file.unsupported': 'Unsupported file type. Supported: images, PDF, TXT, MD, CSV, JSON',
                'loading.workspace': 'Preparing your personal AI companion...',
                'loading.workspace.init': 'Initializing workspace...',
                'loading.workspace.config': 'Configuring AI companion...',
                'loading.workspace.almost': 'Almost ready...',
                'loading.workspace.done': 'All set! Welcome!',
                'error.send': 'Error: Failed to send message',
                'error.network': 'Connection error. Please check your network.',
                'error.login': 'Login failed. Please try again.',
                'error.register.password.length': 'Password must be at least 6 characters',
                'error.register.password.match': 'Passwords do not match',
                'error.register.name.length': 'Nickname must be 2-20 characters',
                'reminder.title': 'Discover Your Soul Match',
                'reminder.message': 'Take a quick personality test so your companion can truly understand you.',
                'reminder.later': 'Maybe Later',
                'reminder.start': 'Take the Test',
                'test.skip': 'Skip for now →',
                'tarot.draw.title': 'Your Soul Reading',
                'tarot.draw.subtitle': 'Click each card to reveal your destiny',
                'tarot.position.past': 'Past',
                'tarot.position.present': 'Present',
                'tarot.position.future': 'Future Companion',
                'tarot.view.results': 'View Your Reading',
                'tarot.results.title': 'Your Soul Cards',
                'tarot.start.chat': 'Start Chatting →',
                'tarot.profile.title': 'Your Companion\'s Personality',
                'rename.title': 'Rename your companion',
                'rename.subtitle': 'Give her a name you like',
                'rename.cancel': 'Cancel',
                'rename.save': 'Save',
                'companion.gender.her': 'Her',
                'companion.gender.him': 'Him',
                'naming.title': 'Give your companion a name',
                'naming.subtitle': 'You can always change it later in settings',
                'naming.confirm': 'Start Chatting ✨',
                'naming.model.title': 'Choose an AI model',
                'naming.model.recommended': 'Recommended',
                'settings.companion.style': 'Companion Style',
                'settings.companion.hint': 'Changes will update your companion\'s personality',
                'companion.avatar.title': 'Change Companion Avatar',
                'companion.avatar.upload': 'Upload Image',
                'companion.avatar.reset': 'Reset to Default',
                'sidebar.about': 'About & Feedback',
                'sidebar.changelog': 'Changelog',
                'changelog.title': 'Changelog',
                'changelog.v160.1': 'Name your companion during registration — make them truly yours',
                'changelog.v160.2': 'Choose your AI model at signup — Gemini, GPT-4o, or Grok',
                'changelog.v160.3': 'Skip personality test — jump straight into chatting, take it later anytime',
                'changelog.v160.4': 'Auto-resize chat input — expands as you type, like WeChat',
                'changelog.v160.5': 'Increased chat memory to 30 messages for deeper conversations',
                'changelog.v160.6': 'Redesigned model selector with official brand icons',
                'changelog.v140.1': 'File upload in chat — send images & documents to AI',
                'changelog.v140.2': 'AI Thinking Process — see Gemini\'s reasoning before it replies (Gemini only)',
                'changelog.v140.3': 'Markdown rendering — AI replies now show bold, headings, lists & more',
                'changelog.v140.4': 'WeChat-style timestamps — time separators auto-appear between messages',
                'changelog.v140.5': 'Grok 4.1 — a more intimate & unfiltered companion experience',
                'changelog.v150.1': 'Fixed model switch losing memory & relationship data',
                'changelog.v150.2': 'Fixed new workspaces defaulting to wrong AI provider',
                'changelog.v150.3': 'Enhanced Gemini thinking content filter for edge cases',
                'changelog.v140.6': 'Fixed Gemini thinking content leaking into chat replies',
                'changelog.v140.7': 'Optimized thinking bubble design',
                'changelog.v130.1': 'AI Memory (Basic) — your companion can now remember key facts about you',
                'changelog.v130.2': 'Trust Device — stay logged in for 90 days, no more repeated logins',
                'changelog.v130.3': 'Chat background picker — 15 curated wallpapers to choose from',
                'changelog.v130.4': 'Companion gender & personality — boyfriend or girlfriend with 4 unique styles',
                'changelog.v130.5': 'AI auto-generates conversation titles based on chat content',
                'changelog.v130.7': 'Web Search — AI can now search the internet for real-time weather, news & more',
                'changelog.v130.6': 'Smarter session handling & major stability improvements',
                'changelog.v120.1': 'About & Feedback page with donation support (Zelle / WeChat / Alipay)',
                'changelog.v120.2': 'Custom companion avatar — click to upload your own image',
                'changelog.v120.3': 'Smart companion rename — rename via chat conversation',
                'changelog.v120.4': 'Personality test now has close button',
                'changelog.v120.5': 'Sidebar layout & spacing improvements',
                'changelog.v110.1': 'AI model selection — switch between GPT-4o & Gemini',
                'changelog.v110.2': 'Email verification with 6-digit code',
                'changelog.v110.3': 'Comprehensive mobile responsive layout',
                'changelog.v110.4': 'Language toggle on login page',
                'changelog.v110.5': 'Model switch stability improvements',
                'changelog.v100.1': 'Personality test & tarot card feature',
                'changelog.v100.2': 'Google OAuth login',
                'changelog.v100.3': 'Real-time AI chat with personalized companion',
                'changelog.v100.4': 'Bilingual support (English / 中文)',
                'about.tagline': 'Your AI Soul Companion',
                'about.description': 'SoulLink is an AI companion platform that creates meaningful connections through personalized conversations. Built with love by the SoulForge team.',
                'about.team': 'Our Team',
                'about.role.founder': 'Founder & Developer',
                'about.support': 'Support Us',
                'about.support.desc': 'If you enjoy SoulLink, consider buying us a coffee!',
                'about.wechat': 'WeChat',
                'about.alipay': 'Alipay',
                'about.feedback': 'Feedback',
                'about.feedback.desc': "We'd love to hear your thoughts, suggestions, or bug reports!",
                'about.feedback.suggestion': 'Suggestion',
                'about.feedback.bug': 'Bug Report',
                'about.feedback.other': 'Other',
                'about.feedback.placeholder': 'Tell us what you think...',
                'about.feedback.submit': 'Submit Feedback',
                'about.feedback.thanks': 'Thank you for your feedback!',
                'about.community': 'Join Our Community',
                'about.community.desc': 'Join our WeChat group for updates, feedback & discussion!',
                'community.popup.title': 'Join Our Community',
                'community.popup.desc': 'Scan to join our WeChat group for updates & feedback!',
                'community.popup.close': 'Got it',
                'login.community': '💬 Join our WeChat community',
                'announcement.community': '💬 Join our WeChat community for updates & feedback!',
                'announcement.view': 'View',
                'announcement.never': "Don't show again",
                'about.survey': 'Survey',
                'about.survey.desc': 'Help us improve — take our quick 4-5 min survey!',
                'bg.picker.title': 'Background',
                'thinking.header': 'Thought Process',
            },
            'zh-CN': {
                'login.subtitle': '你的AI灵魂伴侣，始终在这里',
                'login.tab.signin': '登录',
                'login.tab.signup': '注册',
                'login.email': '邮箱',
                'login.password': '密码',
                'login.email.placeholder': 'your@email.com',
                'login.password.placeholder': '输入密码',
                'login.submit': '登录',
                'register.nickname.label': '你的AI伴侣该怎么称呼你？',
                'register.nickname.placeholder': '你的昵称',
                'register.nickname.hint': '注册后可以给你的AI伴侣取名字哦',
                'register.email.label': '邮箱',
                'register.password.label': '密码',
                'register.password.placeholder': '至少6个字符',
                'register.confirm.label': '确认密码',
                'register.confirm.placeholder': '再次输入密码',
                'register.submit': '创建账号',
                'verify.title': '验证你的邮箱',
                'verify.subtitle': '我们发送了一个6位验证码到',
                'verify.code.label': '验证码',
                'verify.submit': '验证',
                'verify.no_code': '没有收到验证码？',
                'verify.resend': '重新发送',
                'verify.back': '返回注册',
                'login.divider': '或',
                'login.google': '使用Google登录',
                'settings.title': '个人设置',
                'settings.upload': '上传',
                'settings.color': '或选择一个颜色：',
                'settings.nickname': '昵称（{companion}怎么称呼你）',
                'settings.nickname.placeholder': '你的昵称',
                'settings.email': '邮箱',
                'settings.email.hint': '邮箱不能修改',
                'settings.model': 'AI 模型',
                'settings.model.hint': '选择驱动 {companion} 的AI模型',
                'settings.cancel': '取消',
                'settings.save': '保存修改',
                'sidebar.newchat': '新对话',
                'sidebar.logout': '退出',
                'sidebar.test': '性格测试',
                'chat.online': '在线',
                'chat.welcome.title': '欢迎回来！',
                'chat.welcome.subtitle': '和你的AI伴侣开始聊天吧，我一直在这里陪你。',
                'chat.input.placeholder': '输入消息...',
                'chat.drop.hint': '拖放文件到这里',
                'chat.file.too_large': '文件过大（最大10MB）',
                'chat.file.unsupported': '不支持的文件类型。支持：图片、PDF、TXT、MD、CSV、JSON',
                'loading.workspace': '正在为你准备专属AI伴侣...',
                'loading.workspace.init': '初始化工作空间...',
                'loading.workspace.config': '配置AI伴侣...',
                'loading.workspace.almost': '即将就绪...',
                'loading.workspace.done': '一切准备就绪！欢迎！',
                'error.send': '错误：发送消息失败',
                'error.network': '网络错误，请检查你的网络连接。',
                'error.login': '登录失败，请重试。',
                'error.register.password.length': '密码至少需要6个字符',
                'error.register.password.match': '两次输入的密码不一致',
                'error.register.name.length': '昵称需要2-20个字符',
                'reminder.title': '探索你的灵魂匹配',
                'reminder.message': '做一个简短的性格测试，让你的AI伴侣真正了解你。',
                'reminder.later': '稍后再说',
                'reminder.start': '开始测试',
                'test.skip': '先跳过 →',
                'tarot.draw.title': '灵魂占卜',
                'tarot.draw.subtitle': '点击每张牌揭示你的命运',
                'tarot.position.past': '过去',
                'tarot.position.present': '现在',
                'tarot.position.future': '未来伴侣',
                'tarot.view.results': '查看你的占卜结果',
                'tarot.results.title': '你的灵魂之牌',
                'tarot.start.chat': '开始聊天 →',
                'tarot.profile.title': '你的伴侣性格',
                'rename.title': '给她起个名字',
                'rename.subtitle': '取一个你喜欢的昵称吧',
                'rename.cancel': '取消',
                'rename.save': '保存',
                'companion.gender.her': '她',
                'companion.gender.him': '他',
                'naming.title': '给你的伴侣取个名字吧',
                'naming.subtitle': '之后可以随时在设置中修改',
                'naming.confirm': '开始聊天 ✨',
                'naming.model.title': '选择AI模型',
                'naming.model.recommended': '推荐',
                'settings.companion.style': '伴侣风格',
                'settings.companion.hint': '更改将更新伴侣的性格风格',
                'companion.avatar.title': '修改伴侣头像',
                'companion.avatar.upload': '上传图片',
                'companion.avatar.reset': '恢复默认头像',
                'sidebar.about': '关于与反馈',
                'sidebar.changelog': '版本日志',
                'changelog.title': '版本日志',
                'changelog.v160.1': '注册时可给伴侣取名 — 让TA真正属于你',
                'changelog.v160.2': '注册时选择AI模型 — Gemini、GPT-4o、Grok任选',
                'changelog.v160.3': '性格测试可跳过 — 直接开聊，随时补测',
                'changelog.v160.4': '输入框自动增高 — 多行输入更舒适',
                'changelog.v160.5': '聊天记忆增至30条，对话更深入',
                'changelog.v160.6': '模型选择界面优化，使用官方品牌图标',
                'changelog.v140.1': '聊天文件上传 — 发送图片和文档给AI',
                'changelog.v140.2': 'AI思考过程 — 查看回复前的推理过程（仅Gemini）',
                'changelog.v140.3': 'Markdown渲染 — AI回复支持粗体、标题、列表等格式',
                'changelog.v140.4': '微信风格时间戳 — 消息间自动显示时间分隔',
                'changelog.v140.5': '新增Grok 4.1 — 更亲密、更无拘束的陪伴体验',
                'changelog.v150.1': '修复切换模型时丢失记忆和亲密度数据',
                'changelog.v150.2': '修复部分用户AI模型未正确设置的问题',
                'changelog.v150.3': '增强Gemini思考内容过滤，处理更多边界情况',
                'changelog.v140.6': '修复Gemini思考内容泄露到聊天回复中',
                'changelog.v140.7': '优化思考气泡设计',
                'changelog.v130.1': '基础记忆 — AI伴侣现在能记住你的关键信息',
                'changelog.v130.2': '信任设备 — 登录一次保持90天，告别反复登录',
                'changelog.v130.3': '聊天背景切换 — 15张精选壁纸随心换',
                'changelog.v130.4': '伴侣性别与性格 — 男友/女友 x 4种独特风格任你挑',
                'changelog.v130.5': 'AI智能生成对话标题 — 聊天内容自动提取主题',
                'changelog.v130.7': '联网搜索 — AI现在能搜索实时天气、新闻等最新信息',
                'changelog.v130.6': '更智能的会话管理，稳定性大幅提升',
                'changelog.v120.1': '关于与反馈页面，支持打赏（Zelle / 微信 / 支付宝）',
                'changelog.v120.2': '自定义AI头像 — 点击上传你喜欢的图片',
                'changelog.v120.3': '智能改名 — 聊天中直接给AI起新名字',
                'changelog.v120.4': '性格测试新增关闭按钮',
                'changelog.v120.5': '侧边栏布局优化',
                'changelog.v110.1': 'AI模型选择 — GPT-4o 与 Gemini 自由切换',
                'changelog.v110.2': '邮箱验证码注册',
                'changelog.v110.3': '全面适配移动端',
                'changelog.v110.4': '登录页语言切换',
                'changelog.v110.5': '模型切换稳定性优化',
                'changelog.v100.1': '性格测试与塔罗牌功能',
                'changelog.v100.2': 'Google 账号登录',
                'changelog.v100.3': 'AI实时聊天，个性化陪伴',
                'changelog.v100.4': '中英双语支持',
                'about.tagline': '你的AI灵魂伴侣',
                'about.description': 'SoulLink 是一个AI伴侣平台，通过个性化对话创造有意义的连接。由 SoulForge 团队用心打造。',
                'about.team': '我们的团队',
                'about.role.founder': '创始人 & 开发者',
                'about.support': '支持我们',
                'about.support.desc': '如果你喜欢 SoulLink，可以请我们喝杯咖啡！',
                'about.wechat': '微信',
                'about.alipay': '支付宝',
                'about.feedback': '意见反馈',
                'about.feedback.desc': '我们非常期待听到你的想法、建议或问题反馈！',
                'about.feedback.suggestion': '建议',
                'about.feedback.bug': 'Bug 反馈',
                'about.feedback.other': '其他',
                'about.feedback.placeholder': '说说你的想法...',
                'about.feedback.submit': '提交反馈',
                'about.feedback.thanks': '感谢你的反馈！',
                'about.community': '加入社群',
                'about.community.desc': '扫码加入微信群，获取更新通知、反馈建议！',
                'community.popup.title': '加入社群',
                'community.popup.desc': '扫码加入微信群，获取最新动态和交流反馈！',
                'community.popup.close': '知道了',
                'login.community': '💬 加入微信社群',
                'announcement.community': '💬 加入微信社群，获取更新通知和交流反馈！',
                'announcement.view': '查看',
                'announcement.never': '不再提示',
                'about.survey': '调查问卷',
                'about.survey.desc': '帮助我们做得更好 — 仅需4-5分钟！',
                'bg.picker.title': '背景',
                'thinking.header': '思考过程',
            }
        };

        function t(key) {
            const lang = state.language || 'en';
            let text = TRANSLATIONS[lang]?.[key] || TRANSLATIONS['en']?.[key] || key;
            // 动态替换 AI 昵称
            const cname = state.user?.settings?.companion_name || 'Abigail';
            text = text.replace(/\{companion\}/g, cname);
            return text;
        }

        function applyLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const attr = el.getAttribute('data-i18n-attr');
                if (attr) {
                    el.setAttribute(attr, t(key));
                } else {
                    el.textContent = t(key);
                }
            });
            localStorage.setItem('soullink_language', state.language);
            // Update language toggle button text
            const langBtn = document.getElementById('lang-toggle');
            if (langBtn) {
                langBtn.textContent = state.language === 'zh-CN' ? 'EN' : '中文';
            }
            const loginLangBtn = document.getElementById('login-lang-toggle');
            if (loginLangBtn) {
                loginLangBtn.textContent = state.language === 'zh-CN' ? 'EN' : '中文';
            }
        }

        // ==================== 移动端侧边栏 ====================
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const isOpen = sidebar.classList.contains('mobile-open');
            if (isOpen) {
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('mobile-open');
                overlay.classList.add('active');
            }
        }

        function closeMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }

        function toggleLanguage() {
            state.language = state.language === 'zh-CN' ? 'en' : 'zh-CN';
            applyLanguage();
            // Sync to server if logged in
            if (state.token) {
                authFetch(`${CONFIG.API_BASE_URL}/api/user/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ language: state.language })
                }).catch(err => console.warn('Failed to sync language:', err));
            }
        }

        // ==================== 状态管理 ====================
        let state = {
            token: localStorage.getItem('soullink_token'),
            refreshToken: localStorage.getItem('soullink_refresh_token'),
            user: JSON.parse(localStorage.getItem('soullink_user') || 'null'),
            language: localStorage.getItem('soullink_language') || (navigator.language.startsWith('zh') ? 'zh-CN' : 'en'),
            currentConversationId: null,
            conversations: [],
            messages: [],
            isLoading: false
        };

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', async () => {
            // 应用语言设置
            applyLanguage();

            // 设置 Google Client ID
            const onloadDiv = document.getElementById('g_id_onload');
            if (onloadDiv) {
                onloadDiv.setAttribute('data-client_id', CONFIG.GOOGLE_CLIENT_ID);
            }

            if (state.token) {
                // 验证 token
                const isValid = await verifyToken();
                if (isValid) {
                    showApp();
                    await loadConversations(true);  // autoSelect: 恢复到最近对话
                    checkPersonalityTestStatus();
                } else {
                    showLogin();
                }
            } else {
                showLogin();
            }

            hideLoading();
        });

        // ==================== UI 显示控制 ====================
        function showLoading(text = '', showProgress = false) {
            const overlay = document.getElementById('loading-overlay');
            const textEl = document.getElementById('loading-text');
            const progressEl = document.getElementById('loading-progress');

            overlay.classList.remove('hidden');
            textEl.textContent = text;
            progressEl.style.display = showProgress ? 'block' : 'none';
        }

        function updateLoadingProgress(percent, text = null) {
            const progressBar = document.getElementById('loading-progress-bar');
            const textEl = document.getElementById('loading-text');

            progressBar.style.width = `${percent}%`;
            if (text) {
                textEl.textContent = text;
            }
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('loading-progress-bar').style.width = '0%';
        }

        function showLogin() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('app').classList.remove('active');
        }

        function showApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app').classList.add('active');
            updateUserInfo();
            // Load saved background
            if (typeof loadBackground === 'function') loadBackground();
            // 社群弹窗（每用户只弹一次）
            showCommunityPopupOnce();
            // 版本更新弹窗
            showChangelogIfNewVersion();
            // 公告栏
            initAnnouncement();
        }

        function showCommunityPopupOnce() {
            const key = 'community_popup_shown';
            if (localStorage.getItem(key)) return;
            localStorage.setItem(key, '1');
            setTimeout(() => {
                document.getElementById('community-popup').classList.add('active');
            }, 1500);
        }

        function closeCommunityPopup() {
            document.getElementById('community-popup').classList.remove('active');
        }
        document.getElementById('community-popup')?.addEventListener('click', function(e) {
            if (e.target === this) closeCommunityPopup();
        });

        // 登录页社群二维码 toggle
        document.querySelector('.login-community-link')?.addEventListener('click', function() {
            document.getElementById('login-community-qr').classList.toggle('show');
        });

        // 公告栏
        function initAnnouncement() {
            if (localStorage.getItem('announcement_never')) {
                document.getElementById('announcement-bar').classList.add('hidden');
            }
        }
        function dismissAnnouncement(never) {
            document.getElementById('announcement-bar').classList.add('hidden');
            if (never) localStorage.setItem('announcement_never', '1');
        }
        function openCommunityFromBanner() {
            document.getElementById('community-popup').classList.add('active');
        }

        function updateUserInfo() {
            if (state.user) {
                document.getElementById('user-name').textContent = state.user.name;
                document.getElementById('user-email').textContent = state.user.email;
                document.getElementById('user-avatar').src = state.user.avatar_url || 'images/avatar.png';
                // 显示AI昵称
                const companionName = state.user.settings?.companion_name || 'Abigail';
                document.getElementById('companion-name-display').textContent = companionName;
                updateModelIndicator();
                // 更新 companion 头像
                if (typeof updateCompanionAvatars === 'function') updateCompanionAvatars();
            }
        }

        // ==================== 邮箱登录/注册 ====================
        function switchAuthTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const errorDiv = document.getElementById('auth-error');

            errorDiv.classList.remove('visible');

            if (tab === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = message;
            errorDiv.classList.add('visible');
        }

        function hideAuthError() {
            document.getElementById('auth-error').classList.remove('visible');
        }

        async function handleEmailLogin(event) {
            event.preventDefault();
            hideAuthError();

            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const submitBtn = document.getElementById('login-submit-btn');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Signing in...';

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.requires_verification) {
                    // 未验证用户 → 显示验证码输入界面
                    showVerificationScreen(data.email || email);
                } else if (data.success) {
                    // 重置状态（清除之前用户的数据）
                    state.currentConversationId = null;
                    state.conversations = [];
                    state.messages = [];

                    state.token = data.token;
                    state.refreshToken = data.refresh_token;
                    state.user = data.user;
                    localStorage.setItem('soullink_token', data.token);
                    if (data.refresh_token) localStorage.setItem('soullink_refresh_token', data.refresh_token);
                    localStorage.setItem('soullink_user', JSON.stringify(data.user));

                    showApp();

                    // 清空UI并显示欢迎信息
                    document.getElementById('conversations-list').innerHTML = '';
                    renderMessages();

                    // 初始化 workspace（新用户会显示加载进度）
                    await initializeWorkspace();
                    await loadConversations();
                    checkPersonalityTestStatus();
                } else {
                    showAuthError(data.error || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAuthError('Network error. Please try again.');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Sign In';
        }

        async function handleEmailRegister(event) {
            event.preventDefault();
            hideAuthError();

            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const submitBtn = document.getElementById('register-submit-btn');

            // 验证昵称
            if (!name || name.length < 2) {
                showAuthError('Please enter a nickname (at least 2 characters)');
                return;
            }

            if (name.length > 20) {
                showAuthError('Nickname must be 20 characters or less');
                return;
            }

            // 验证密码
            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
            }

            // 验证密码匹配
            if (password !== passwordConfirm) {
                showAuthError('Passwords do not match');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating account...';

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password, name })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.requires_verification) {
                        // 显示验证码输入界面
                        showVerificationScreen(email);
                    } else {
                        // 兜底（不应该走到这里了）
                        state.currentConversationId = null;
                        state.conversations = [];
                        state.messages = [];
                        state.token = data.token;
                        state.refreshToken = data.refresh_token;
                        state.user = data.user;
                        localStorage.setItem('soullink_token', data.token);
                        if (data.refresh_token) localStorage.setItem('soullink_refresh_token', data.refresh_token);
                        localStorage.setItem('soullink_user', JSON.stringify(data.user));
                        state.isFirstRegistration = true;
                        showApp();
                        document.getElementById('conversations-list').innerHTML = '';
                        renderMessages();
                        await initializeWorkspace();
                        await loadConversations();
                        startPersonalityTest();
                    }
                } else {
                    showAuthError(data.error || 'Registration failed');
                }
            } catch (error) {
                console.error('Register error:', error);
                showAuthError('Network error. Please try again.');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Account';
        }

        // ==================== 邮箱验证码 ====================
        let pendingVerificationEmail = null;
        let resendCooldownTimer = null;

        function showVerificationScreen(email) {
            pendingVerificationEmail = email;

            // 隐藏登录/注册表单，显示验证表单
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const verificationForm = document.getElementById('verification-form');
            const authTabs = document.querySelector('.auth-tabs');
            const authDivider = document.querySelector('.auth-divider');
            const googleBtn = document.querySelector('.google-login-btn');

            if (loginForm) loginForm.style.display = 'none';
            if (registerForm) registerForm.style.display = 'none';
            if (verificationForm) verificationForm.style.display = 'block';
            if (authTabs) authTabs.style.display = 'none';
            if (authDivider) authDivider.style.display = 'none';
            if (googleBtn) googleBtn.style.display = 'none';

            document.getElementById('verification-email-display').textContent = email;
            document.getElementById('verify-code-input').value = '';
            document.getElementById('verify-code-input').focus();

            hideVerifyError();
            startResendCooldown(60);
        }

        function backToRegister() {
            pendingVerificationEmail = null;

            const verificationForm = document.getElementById('verification-form');
            const registerForm = document.getElementById('register-form');
            const authTabs = document.querySelector('.auth-tabs');
            const authDivider = document.querySelector('.auth-divider');
            const googleBtn = document.querySelector('.google-login-btn');

            if (verificationForm) verificationForm.style.display = 'none';
            if (registerForm) registerForm.style.display = 'block';
            if (authTabs) authTabs.style.display = 'flex';
            if (authDivider) authDivider.style.display = 'flex';
            if (googleBtn) googleBtn.style.display = 'block';

            switchAuthTab('register');

            if (resendCooldownTimer) {
                clearInterval(resendCooldownTimer);
                resendCooldownTimer = null;
            }
        }

        function showVerifyError(message) {
            const errorDiv = document.getElementById('verify-error');
            errorDiv.textContent = message;
            errorDiv.classList.add('visible');
        }

        function hideVerifyError() {
            const errorDiv = document.getElementById('verify-error');
            if (errorDiv) errorDiv.classList.remove('visible');
        }

        async function handleVerifyCode() {
            hideVerifyError();

            const code = document.getElementById('verify-code-input').value.trim();
            const submitBtn = document.getElementById('verify-submit-btn');

            if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) {
                showVerifyError(state.language === 'zh-CN' ? '请输入6位数字验证码' : 'Please enter a valid 6-digit code');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = state.language === 'zh-CN' ? '验证中...' : 'Verifying...';

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/auth/verify-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: pendingVerificationEmail, code })
                });

                const data = await response.json();

                if (data.success) {
                    // 验证成功 → 拿到 token，进入应用
                    state.currentConversationId = null;
                    state.conversations = [];
                    state.messages = [];

                    state.token = data.token;
                    state.refreshToken = data.refresh_token;
                    state.user = data.user;
                    localStorage.setItem('soullink_token', data.token);
                    if (data.refresh_token) localStorage.setItem('soullink_refresh_token', data.refresh_token);
                    localStorage.setItem('soullink_user', JSON.stringify(data.user));

                    // 恢复 UI 元素显示状态
                    document.getElementById('verification-form').style.display = 'none';
                    const authTabs = document.querySelector('.auth-tabs');
                    const authDivider = document.querySelector('.auth-divider');
                    const googleBtn = document.querySelector('.google-login-btn');
                    if (authTabs) authTabs.style.display = 'flex';
                    if (authDivider) authDivider.style.display = 'flex';
                    if (googleBtn) googleBtn.style.display = 'block';

                    state.isFirstRegistration = true;
                    showApp();
                    document.getElementById('conversations-list').innerHTML = '';
                    renderMessages();
                    await initializeWorkspace();
                    await loadConversations();
                    startPersonalityTest();
                } else {
                    showVerifyError(data.error || (state.language === 'zh-CN' ? '验证失败' : 'Verification failed'));
                }
            } catch (error) {
                console.error('Verification error:', error);
                showVerifyError(state.language === 'zh-CN' ? '网络错误，请重试' : 'Network error. Please try again.');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = state.language === 'zh-CN' ? '验证' : 'Verify';
        }

        async function handleResendCode() {
            hideVerifyError();
            const resendBtn = document.getElementById('resend-btn');
            resendBtn.disabled = true;

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/auth/resend-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: pendingVerificationEmail })
                });

                const data = await response.json();

                if (data.success) {
                    startResendCooldown(60);
                } else {
                    showVerifyError(data.error || (state.language === 'zh-CN' ? '发送失败' : 'Failed to resend code'));
                    resendBtn.disabled = false;
                }
            } catch (error) {
                console.error('Resend error:', error);
                showVerifyError(state.language === 'zh-CN' ? '网络错误，请重试' : 'Network error. Please try again.');
                resendBtn.disabled = false;
            }
        }

        function startResendCooldown(seconds) {
            const resendBtn = document.getElementById('resend-btn');
            const timerEl = document.getElementById('resend-timer');

            resendBtn.disabled = true;
            timerEl.style.display = 'block';

            let remaining = seconds;
            const isZh = state.language === 'zh-CN';
            timerEl.textContent = isZh ? `${remaining}秒后可重新发送` : `Resend available in ${remaining}s`;

            if (resendCooldownTimer) clearInterval(resendCooldownTimer);

            resendCooldownTimer = setInterval(() => {
                remaining--;
                if (remaining <= 0) {
                    clearInterval(resendCooldownTimer);
                    resendCooldownTimer = null;
                    resendBtn.disabled = false;
                    timerEl.style.display = 'none';
                } else {
                    timerEl.textContent = isZh ? `${remaining}秒后可重新发送` : `Resend available in ${remaining}s`;
                }
            }, 1000);
        }

        // ==================== 认证相关 ====================

        // 用 refresh token 换取新 JWT（内部使用）
        async function _tryRefreshToken() {
            if (!state.refreshToken) return false;
            try {
                const resp = await fetch(`${CONFIG.API_BASE_URL}/api/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: state.refreshToken })
                });
                if (resp.ok) {
                    const data = await resp.json();
                    state.token = data.token;
                    state.user = data.user;
                    localStorage.setItem('soullink_token', data.token);
                    localStorage.setItem('soullink_user', JSON.stringify(data.user));
                    return true;
                }
            } catch (e) {
                console.error('Refresh token failed:', e);
            }
            return false;
        }

        // 带自动刷新的 fetch 封装 — 替代所有 authenticated API 调用
        async function authFetch(url, options = {}) {
            if (!options.headers) options.headers = {};

            // 同步检查：如果 localStorage 中 token 已被清除但内存中还有，主动刷新
            const storedToken = localStorage.getItem('soullink_token');
            if (!storedToken && state.token) {
                // token 被外部清除（如手动删除、其他 tab 登出），尝试用 refresh token 续期
                state.token = null;
            }

            if (state.token) {
                options.headers['Authorization'] = `Bearer ${state.token}`;
            }

            // 如果没有 token，直接尝试 refresh 而不是发一个必然 401 的请求
            if (!state.token && state.refreshToken) {
                const refreshed = await _tryRefreshToken();
                if (refreshed) {
                    options.headers['Authorization'] = `Bearer ${state.token}`;
                } else {
                    logout();
                    return new Response(JSON.stringify({error: 'Session expired'}), {status: 401});
                }
            }

            let response = await fetch(url, options);

            // 401 且有 refresh token → 尝试刷新后重试
            if (response.status === 401 && state.refreshToken) {
                const refreshed = await _tryRefreshToken();
                if (refreshed) {
                    options.headers['Authorization'] = `Bearer ${state.token}`;
                    response = await fetch(url, options);
                } else {
                    // refresh 也失败 → 强制登出
                    logout();
                }
            }
            return response;
        }

        async function verifyToken() {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/auth/verify`, {
                    headers: {
                        'Authorization': `Bearer ${state.token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    state.user = data.user;
                    localStorage.setItem('soullink_user', JSON.stringify(data.user));
                    return true;
                }

                // JWT 过期 → 尝试用 refresh token 续期
                if (response.status === 401 && state.refreshToken) {
                    return await _tryRefreshToken();
                }

                return false;
            } catch (error) {
                console.error('Token verification failed:', error);
                return false;
            }
        }

        function signInWithGoogle() {
            // 使用 Google Identity Services - Token 模式（更简单，无需后端 redirect_uri）
            google.accounts.id.initialize({
                client_id: CONFIG.GOOGLE_CLIENT_ID,
                callback: handleGoogleCredential,
                auto_select: false,
                cancel_on_tap_outside: true
            });

            // 直接显示登录弹窗（使用 renderButton 替代 prompt，更可靠）
            // 创建一个临时的隐藏按钮来触发登录
            const tempDiv = document.createElement('div');
            tempDiv.style.display = 'none';
            document.body.appendChild(tempDiv);

            google.accounts.id.renderButton(tempDiv, {
                type: 'standard',
                theme: 'outline',
                size: 'large'
            });

            // 点击隐藏的按钮触发登录
            setTimeout(() => {
                const btn = tempDiv.querySelector('div[role="button"]');
                if (btn) {
                    btn.click();
                } else {
                    // 备选：直接使用 prompt
                    google.accounts.id.prompt();
                }
                // 清理临时元素
                setTimeout(() => tempDiv.remove(), 100);
            }, 100);
        }

        async function handleGoogleCredential(response) {
            showLoading();
            try {
                const result = await fetch(`${CONFIG.API_BASE_URL}/api/auth/google/callback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        credential: response.credential
                    })
                });

                const data = await result.json();

                if (data.success) {
                    // 重置状态（清除之前用户的数据）
                    state.currentConversationId = null;
                    state.conversations = [];
                    state.messages = [];

                    state.token = data.token;
                    state.refreshToken = data.refresh_token;
                    state.user = data.user;
                    localStorage.setItem('soullink_token', data.token);
                    if (data.refresh_token) localStorage.setItem('soullink_refresh_token', data.refresh_token);
                    localStorage.setItem('soullink_user', JSON.stringify(data.user));

                    showApp();
                    hideLoading();

                    // 清空UI并显示欢迎信息
                    document.getElementById('conversations-list').innerHTML = '';
                    renderMessages();

                    // 初始化 workspace（新用户会显示加载进度）
                    await initializeWorkspace();
                    await loadConversations();
                    checkPersonalityTestStatus();
                } else {
                    hideLoading();
                    alert('Login failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Login error:', error);
                hideLoading();
                alert('Login failed. Please try again.');
            }
        }

        async function handleAuthCode(response) {
            showLoading();
            try {
                const result = await fetch(`${CONFIG.API_BASE_URL}/api/auth/google/callback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: response.code
                    })
                });

                const data = await result.json();

                if (data.success) {
                    // 重置状态（清除之前用户的数据）
                    state.currentConversationId = null;
                    state.conversations = [];
                    state.messages = [];

                    state.token = data.token;
                    state.refreshToken = data.refresh_token;
                    state.user = data.user;
                    localStorage.setItem('soullink_token', data.token);
                    if (data.refresh_token) localStorage.setItem('soullink_refresh_token', data.refresh_token);
                    localStorage.setItem('soullink_user', JSON.stringify(data.user));

                    showApp();
                    hideLoading();

                    // 清空UI并显示欢迎信息
                    document.getElementById('conversations-list').innerHTML = '';
                    renderMessages();

                    // 初始化 workspace（新用户会显示加载进度）
                    await initializeWorkspace();
                    await loadConversations();
                    checkPersonalityTestStatus();
                } else {
                    hideLoading();
                    alert('Login failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Login error:', error);
                hideLoading();
                alert('Login failed. Please try again.');
            }
        }

        function logout() {
            // 通知服务端吊销 refresh token（fire and forget）
            if (state.refreshToken) {
                fetch(`${CONFIG.API_BASE_URL}/api/auth/logout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: state.refreshToken })
                }).catch(() => {});
            }

            state.token = null;
            state.refreshToken = null;
            state.user = null;
            state.currentConversationId = null;
            state.conversations = [];
            state.messages = [];

            localStorage.removeItem('soullink_token');
            localStorage.removeItem('soullink_refresh_token');
            localStorage.removeItem('soullink_user');

            // 清空UI显示
            document.getElementById('conversations-list').innerHTML = '';
            renderMessages(); // 重置消息区域显示欢迎信息

            showLogin();
        }

        // ==================== Workspace 初始化 ====================
        async function initializeWorkspace() {
            // 检查用户是否已有 workspace
            if (state.user?.workspace_slug) {
                return true; // 已有 workspace，无需初始化
            }

            // 新用户，显示加载进度
            showLoading('Preparing your personal AI companion...', true);
            updateLoadingProgress(10, 'Creating your workspace...');

            try {
                // 模拟进度更新（实际创建在后端异步进行）
                const progressInterval = setInterval(() => {
                    const currentWidth = parseFloat(document.getElementById('loading-progress-bar').style.width) || 10;
                    if (currentWidth < 85) {
                        updateLoadingProgress(currentWidth + Math.random() * 5);
                    }
                }, 500);

                updateLoadingProgress(20, 'Setting up AI knowledge base...');

                // 调用 workspace 接口触发创建
                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/workspace`, {
                    headers: {}
                });

                clearInterval(progressInterval);

                if (response.ok) {
                    const data = await response.json();
                    updateLoadingProgress(90, 'Almost ready...');

                    // 更新本地用户状态
                    if (data.workspace) {
                        state.user.workspace_slug = data.workspace.slug;
                        localStorage.setItem('soullink_user', JSON.stringify(state.user));
                    }

                    updateLoadingProgress(100, 'Ready!');
                    await new Promise(resolve => setTimeout(resolve, 500)); // 短暂延迟让用户看到完成

                    hideLoading();
                    return true;
                } else {
                    hideLoading();
                    console.error('Failed to create workspace');
                    return false;
                }
            } catch (error) {
                hideLoading();
                console.error('Workspace initialization error:', error);
                return false;
            }
        }

        // ==================== 对话管理 ====================
        async function loadConversations(autoSelect = false) {
            try {
                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/conversations`, {
                    headers: {}
                });

                if (response.ok) {
                    const data = await response.json();
                    state.conversations = data.conversations;
                    renderConversationsList();

                    // 页面初始化时自动选中最近的对话（恢复上次状态）
                    if (autoSelect && !state.currentConversationId && state.conversations.length > 0) {
                        const latest = state.conversations[0]; // 已按 updated_at 降序排列
                        state.currentConversationId = latest.id;
                        renderConversationsList();
                        // 加载该对话的消息
                        const convResp = await authFetch(`${CONFIG.API_BASE_URL}/api/conversations/${latest.id}`, {
                            headers: {}
                        });
                        if (convResp.ok) {
                            const convData = await convResp.json();
                            state.messages = convData.messages || [];
                            renderMessages();
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
            }
        }

        function renderConversationsList() {
            const container = document.getElementById('conversations-list');
            container.innerHTML = '';

            state.conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conversation-item' + (conv.id === state.currentConversationId ? ' active' : '');
                item.dataset.convId = conv.id;

                const date = conv.updated_at ? new Date(conv.updated_at).toLocaleDateString() : '';

                item.innerHTML = `
                    <div class="conversation-content" onclick="selectConversation('${conv.id}')">
                        <div class="conversation-title">${escapeHtml(conv.title || 'New Chat')}</div>
                        <div class="conversation-time">${date}</div>
                    </div>
                    <div class="conversation-actions">
                        <button class="conv-action-btn" onclick="event.stopPropagation(); startRenameConversation('${conv.id}')" title="Rename">
                            <svg viewBox="0 0 24 24" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="conv-action-btn delete" onclick="event.stopPropagation(); deleteConversation('${conv.id}')" title="Delete">
                            <svg viewBox="0 0 24 24" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                `;

                container.appendChild(item);
            });
        }

        async function selectConversation(convId) {
            state.currentConversationId = convId;
            renderConversationsList();
            closeMobileSidebar();

            // 加载对话消息
            try {
                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/conversations/${convId}`, {
                    headers: {}
                });

                if (response.ok) {
                    const data = await response.json();
                    state.messages = data.messages || [];
                    renderMessages();
                }
            } catch (error) {
                console.error('Failed to load conversation:', error);
            }
        }

        async function createNewConversation() {
            closeMobileSidebar();
            try {
                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/conversations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: 'New Chat' })
                });

                if (response.ok) {
                    const data = await response.json();
                    state.currentConversationId = data.conversation.id;
                    state.messages = [];
                    await loadConversations();
                    renderMessages();
                }
            } catch (error) {
                console.error('Failed to create conversation:', error);
            }
        }

        // ==================== 对话重命名和删除 ====================
        function startRenameConversation(convId) {
            const item = document.querySelector(`.conversation-item[data-conv-id="${convId}"]`);
            if (!item) return;

            const titleDiv = item.querySelector('.conversation-title');
            const currentTitle = titleDiv.textContent;

            // 替换为输入框
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'conversation-title-input';
            input.value = currentTitle;

            input.onblur = () => finishRenameConversation(convId, input.value);
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.blur();
                } else if (e.key === 'Escape') {
                    input.value = currentTitle;
                    input.blur();
                }
            };

            titleDiv.replaceWith(input);
            input.focus();
            input.select();
        }

        async function finishRenameConversation(convId, newTitle) {
            newTitle = newTitle.trim();
            if (!newTitle) newTitle = 'New Chat';

            try {
                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/conversations/${convId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: newTitle })
                });

                if (response.ok) {
                    // 更新本地状态
                    const conv = state.conversations.find(c => c.id === convId);
                    if (conv) conv.title = newTitle;
                }
            } catch (error) {
                console.error('Failed to rename conversation:', error);
            }

            // 重新渲染列表
            renderConversationsList();
        }

        async function deleteConversation(convId) {
            if (!confirm('Are you sure you want to delete this conversation?')) {
                return;
            }

            try {
                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/conversations/${convId}`, {
                    method: 'DELETE',
                    headers: {}
                });

                if (response.ok) {
                    // 如果删除的是当前对话，清空消息
                    if (convId === state.currentConversationId) {
                        state.currentConversationId = null;
                        state.messages = [];
                        renderMessages();
                    }

                    // 重新加载对话列表
                    await loadConversations();
                } else {
                    alert('Failed to delete conversation');
                }
            } catch (error) {
                console.error('Failed to delete conversation:', error);
                alert('Failed to delete conversation');
            }
        }

        function generateSimpleTitle() {
            // 生成简洁的日期时间标题
            const now = new Date();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                           'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = months[now.getMonth()];
            const day = now.getDate();
            const hour = now.getHours();
            const minute = now.getMinutes().toString().padStart(2, '0');

            // 12小时制
            const hour12 = hour % 12 || 12;
            const ampm = hour < 12 ? 'AM' : 'PM';

            return `${month} ${day}, ${hour12}:${minute} ${ampm}`;
        }

        async function autoGenerateTitle(convId, firstMessage) {
            // 先用临时时间标题，立即显示在侧边栏
            const tempTitle = generateSimpleTitle();
            const conv = state.conversations.find(c => c.id === convId);
            if (conv) {
                conv.title = tempTitle;
                renderConversationsList();
            }

            // 后端异步用 Gemini 生成标题（约2-4秒），轮询拉取
            // 第一次 3 秒后尝试，失败则 6 秒后再试一次
            const delays = [3000, 6000];
            for (const delay of delays) {
                await new Promise(r => setTimeout(r, delay));
                try {
                    const resp = await authFetch(`${CONFIG.API_BASE_URL}/api/conversations/${convId}`, {
                        headers: {}
                    });
                    if (resp.ok) {
                        const data = await resp.json();
                        const aiTitle = data.title;
                        if (aiTitle && aiTitle !== 'New Chat' && aiTitle !== '新对话') {
                            // 找到 AI 标题，更新本地状态和侧边栏
                            const c = state.conversations.find(c => c.id === convId);
                            if (c) c.title = aiTitle;
                            renderConversationsList();
                            return; // 成功，退出轮询
                        }
                    }
                } catch (e) {
                    // 静默失败，继续下一次尝试
                }
            }
        }

        // ==================== 消息渲染 ====================
        // 微信风格时间格式化
        function formatMessageTime(dateInput) {
            if (!dateInput) return '';
            const date = (typeof dateInput === 'string') ? new Date(dateInput) : dateInput;
            if (isNaN(date.getTime())) return '';

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const msgDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const diffDays = Math.floor((today - msgDay) / 86400000);

            const hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const isZh = state.language === 'zh-CN';

            let timeStr;
            if (isZh) {
                const period = hours < 6 ? '凌晨' : hours < 12 ? '上午' : hours < 13 ? '中午' : hours < 18 ? '下午' : '晚上';
                const h12 = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
                timeStr = `${period}${h12}:${minutes}`;
            } else {
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const h12 = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
                timeStr = `${h12}:${minutes} ${ampm}`;
            }

            if (diffDays === 0) return timeStr;
            if (diffDays === 1) return isZh ? `昨天 ${timeStr}` : `Yesterday ${timeStr}`;
            if (diffDays < 7) {
                const weekdays = isZh
                    ? ['周日', '周一', '周二', '周三', '周四', '周五', '周六']
                    : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return `${weekdays[date.getDay()]} ${timeStr}`;
            }
            const month = date.getMonth() + 1;
            const day = date.getDate();
            if (date.getFullYear() === now.getFullYear()) {
                return isZh ? `${month}月${day}日 ${timeStr}` : `${month}/${day} ${timeStr}`;
            }
            return isZh
                ? `${date.getFullYear()}年${month}月${day}日 ${timeStr}`
                : `${month}/${day}/${date.getFullYear()} ${timeStr}`;
        }

        // 判断两条消息之间是否需要插入时间分隔（间隔 > 5分钟）
        function shouldShowTimeSeparator(prevMsg, currMsg) {
            if (!prevMsg || !currMsg) return !!currMsg;
            const prevTime = prevMsg.timestamp ? new Date(prevMsg.timestamp) : null;
            const currTime = currMsg.timestamp ? new Date(currMsg.timestamp) : null;
            if (!prevTime || !currTime) return false;
            return (currTime - prevTime) > 5 * 60 * 1000;
        }

        function addTimeSeparator(container, typingIndicator, timestamp) {
            const sep = document.createElement('div');
            sep.className = 'time-separator';
            sep.innerHTML = `<span>${formatMessageTime(timestamp)}</span>`;
            container.insertBefore(sep, typingIndicator);
        }

        function renderMessages() {
            const container = document.getElementById('messages-container');
            const welcomeMsg = document.getElementById('welcome-message');
            const typingIndicator = document.getElementById('typing-indicator');

            // 清除现有消息、thinking bubbles 和时间分隔符（保留 welcome 和 typing indicator）
            const existingElements = container.querySelectorAll('.message, .thinking-bubble, .time-separator');
            existingElements.forEach(el => el.remove());

            if (state.messages.length === 0) {
                welcomeMsg.style.display = 'block';
            } else {
                welcomeMsg.style.display = 'none';

                let prevMsg = null;
                state.messages.forEach((msg, idx) => {
                    // 微信风格：间隔超过5分钟显示时间分隔
                    if (idx === 0 && msg.timestamp) {
                        addTimeSeparator(container, typingIndicator, msg.timestamp);
                    } else if (shouldShowTimeSeparator(prevMsg, msg)) {
                        addTimeSeparator(container, typingIndicator, msg.timestamp);
                    }

                    // 如果是 AI 回复且有 thinking 内容，先显示 thinking bubble
                    if (msg.role === 'assistant' && msg.thinking) {
                        addThinkingBubble(msg.thinking);
                    }
                    addMessageToUI(msg.content, msg.role === 'user', false, msg.attachments || []);
                    prevMsg = msg;
                });
            }

            // 确保 typing indicator 在最后
            container.appendChild(typingIndicator);

            // 滚动到底部
            container.scrollTop = container.scrollHeight;
        }

        function addMessageToUI(text, isUser, useTypewriter = false, attachments = []) {
            const container = document.getElementById('messages-container');
            const typingIndicator = document.getElementById('typing-indicator');
            const welcomeMsg = document.getElementById('welcome-message');

            welcomeMsg.style.display = 'none';

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;

            const avatarSrc = isUser
                ? (state.user?.avatar_url || 'images/avatar.png')
                : (state.user?.settings?.companion_avatar || 'images/avatar.png');

            messageDiv.innerHTML = `
                <img class="message-avatar" src="${avatarSrc}" alt="Avatar">
                <div class="message-content"></div>
            `;

            const contentDiv = messageDiv.querySelector('.message-content');

            // 渲染附件（图片缩略图 / 文件名标签）
            if (attachments && attachments.length > 0) {
                const attDiv = document.createElement('div');
                attDiv.className = 'message-attachments';
                attachments.forEach(att => {
                    if (att.isImage && att.dataUrl) {
                        const img = document.createElement('img');
                        img.src = att.dataUrl;
                        img.alt = att.name;
                        attDiv.appendChild(img);
                    } else {
                        const tag = document.createElement('span');
                        tag.className = 'message-attachment-file';
                        tag.textContent = '📄 ' + att.name;
                        attDiv.appendChild(tag);
                    }
                });
                contentDiv.appendChild(attDiv);
            }

            container.insertBefore(messageDiv, typingIndicator);

            if (useTypewriter && !isUser) {
                // 打字机效果：先逐字显示，完成后转为markdown渲染
                typewriterEffect(contentDiv, text, () => {
                    // 保留附件div，只替换文本部分
                    const attEl = contentDiv.querySelector('.message-attachments');
                    contentDiv.innerHTML = renderMarkdown(text);
                    if (attEl) contentDiv.insertBefore(attEl, contentDiv.firstChild);
                    container.scrollTop = container.scrollHeight;
                });
            } else if (!isUser) {
                // AI 历史消息：直接 markdown 渲染
                const attEl = contentDiv.querySelector('.message-attachments');
                contentDiv.innerHTML = renderMarkdown(text);
                if (attEl) contentDiv.insertBefore(attEl, contentDiv.firstChild);
                container.scrollTop = container.scrollHeight;
            } else {
                // 用户消息：纯文本
                const textNode = document.createTextNode(text);
                contentDiv.appendChild(textNode);
                container.scrollTop = container.scrollHeight;
            }
        }

        // 打字机效果函数
        function typewriterEffect(element, text, onComplete) {
            let index = 0;
            const speed = 25; // 每个字符的延迟（毫秒）
            const container = document.getElementById('messages-container');

            // 添加光标
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            element.appendChild(cursor);

            function type() {
                if (index < text.length) {
                    // 在光标前插入字符
                    const char = text.charAt(index);
                    const textNode = document.createTextNode(char);
                    element.insertBefore(textNode, cursor);

                    index++;

                    // 滚动到底部
                    container.scrollTop = container.scrollHeight;

                    // 根据字符调整速度（标点符号稍慢）
                    let delay = speed;
                    if ('，。！？、：；'.includes(char)) {
                        delay = speed * 4;
                    } else if (',.!?:;'.includes(char)) {
                        delay = speed * 3;
                    } else if (char === '\n') {
                        delay = speed * 2;
                    }

                    setTimeout(type, delay);
                } else {
                    // 完成后移除光标
                    cursor.remove();
                    if (onComplete) onComplete();
                }
            }

            type();
        }

        function showTyping() {
            document.getElementById('typing-indicator').classList.add('visible');
            document.getElementById('messages-container').scrollTop =
                document.getElementById('messages-container').scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typing-indicator').classList.remove('visible');
        }

        // ==================== 消息发送 ====================
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const message = input.value.trim();

            // Wait for any in-progress file reads to finish
            if (filesReading > 0) {
                await new Promise(resolve => {
                    const check = setInterval(() => {
                        if (filesReading === 0) { clearInterval(check); resolve(); }
                    }, 50);
                });
            }

            const hasFiles = pendingFiles.length > 0;
            if ((!message && !hasFiles) || state.isLoading) return;

            state.isLoading = true;
            input.disabled = true;
            sendBtn.disabled = true;

            // 微信风格：如果距离上条消息超过5分钟，插入时间分隔
            const lastMsg = state.messages[state.messages.length - 1];
            const nowTs = new Date();
            if (!lastMsg || !lastMsg.timestamp || (nowTs - new Date(lastMsg.timestamp)) > 5 * 60 * 1000) {
                const container = document.getElementById('messages-container');
                const typingIndicator = document.getElementById('typing-indicator');
                addTimeSeparator(container, typingIndicator, nowTs);
            }

            // 收集附件 base64 数据
            const attachmentsToSend = pendingFiles.map(f => ({
                name: f.name,
                mime: f.isImage ? f.mime : 'application/anythingllm-document',
                contentString: f.dataUrl
            }));
            const attachmentsForUI = pendingFiles.map(f => ({
                name: f.name,
                isImage: f.isImage,
                dataUrl: f.dataUrl
            }));
            pendingFiles = [];
            renderFilePreview();

            // 添加用户消息到 UI（含附件）
            addMessageToUI(message, true, false, attachmentsForUI);
            input.value = '';
            input.style.height = '22px';
            input.style.overflowY = 'hidden';
            const wrapper = document.getElementById('input-wrapper');
            if (wrapper) wrapper.style.borderRadius = '24px';

            // 显示加载状态
            showTyping();

            try {
                // 如果没有当前对话 ID，先显式创建一个新对话
                // 避免后端隐式使用 get_active_conversation 导致消息跑到旧对话
                let createdNewConv = false;
                if (!state.currentConversationId) {
                    try {
                        const createResp = await authFetch(`${CONFIG.API_BASE_URL}/api/conversations`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title: 'New Chat' })
                        });
                        if (createResp.ok) {
                            const createData = await createResp.json();
                            state.currentConversationId = createData.conversation.id;
                            createdNewConv = true;
                        }
                    } catch (e) {
                        console.error('Failed to pre-create conversation:', e);
                    }
                }

                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message || '',
                        conversation_id: state.currentConversationId,
                        show_thinking: true,
                        attachments: attachmentsToSend.length > 0 ? attachmentsToSend : undefined
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // 更新当前对话 ID（后端可能返回不同的 ID）
                    if (data.conversation_id) {
                        state.currentConversationId = data.conversation_id;
                    }

                    // 隐藏 typing indicator
                    hideTyping();

                    // 如果有 thinking 内容，先显示思考过程
                    if (data.thinking) {
                        addThinkingBubble(data.thinking);
                    }

                    // 添加 AI 回复（使用打字机效果）
                    addMessageToUI(data.reply, false, true);

                    // 检测 AI 是否接受了改名
                    if (data.companionNameChanged) {
                        if (!state.user.settings) state.user.settings = {};
                        state.user.settings.companion_name = data.companionNameChanged;
                        localStorage.setItem('soullink_user', JSON.stringify(state.user));
                        document.getElementById('companion-name-display').textContent = data.companionNameChanged;
                        applyLanguage(); // 同步更新设置页面等处的名字
                    }

                    // 更新本地消息记录（带时间戳供时间分隔符使用）
                    const now = new Date().toISOString();
                    const userMsg = { role: 'user', content: message, timestamp: now };
                    if (attachmentsForUI.length > 0) {
                        userMsg.attachments = attachmentsForUI.map(a => ({ name: a.name, isImage: a.isImage }));
                    }
                    state.messages.push(
                        userMsg,
                        { role: 'assistant', content: data.reply, thinking: data.thinking || null, timestamp: now }
                    );

                    // 新对话：先刷新侧边栏列表，再异步等 AI 标题更新
                    if (createdNewConv || state.messages.length <= 2) {
                        await loadConversations();
                        // autoGenerateTitle 内部会轮询等待后端 Gemini 生成标题并更新侧边栏
                        autoGenerateTitle(state.currentConversationId, message);
                    }
                } else {
                    hideTyping();
                    addMessageToUI('Sorry, something went wrong. Please try again.', false);
                }
            } catch (error) {
                console.error('Send message error:', error);
                hideTyping();
                addMessageToUI('Connection error. Please check your network.', false);
            }
            state.isLoading = false;
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // 输入框自动增高（类似微信/ChatGPT）
        function autoResizeInput() {
            const textarea = document.getElementById('message-input');
            if (!textarea) return;
            textarea.style.height = '22px'; // 先重置到单行
            const scrollH = textarea.scrollHeight - 16; // 减去上下padding 8+8
            const newHeight = Math.max(22, Math.min(scrollH, 150));
            textarea.style.height = newHeight + 'px';
            textarea.style.overflowY = scrollH > 150 ? 'auto' : 'hidden';
            // 多行时调整圆角
            const wrapper = document.getElementById('input-wrapper');
            if (wrapper) {
                wrapper.style.borderRadius = newHeight > 28 ? '16px' : '24px';
            }
        }

        // 绑定事件
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('message-input');
            if (input) {
                input.addEventListener('input', autoResizeInput);
            }
        });

        // ==================== 文件上传 ====================
        let pendingFiles = []; // {file, name, mime, dataUrl, isImage}
        let filesReading = 0; // track in-progress FileReader operations
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        const IMAGE_TYPES = ['image/png', 'image/jpeg', 'image/gif', 'image/webp'];
        const ALLOWED_DOC_EXTS = ['.pdf', '.txt', '.md', '.csv', '.json'];

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(addPendingFile);
            event.target.value = ''; // reset so same file can be re-selected
        }

        function isFileAllowed(file) {
            if (IMAGE_TYPES.includes(file.type)) return true;
            const ext = '.' + file.name.split('.').pop().toLowerCase();
            return ALLOWED_DOC_EXTS.includes(ext);
        }

        function addPendingFile(file) {
            if (!isFileAllowed(file)) {
                alert(t('chat.file.unsupported'));
                return;
            }
            if (file.size > MAX_FILE_SIZE) {
                alert(t('chat.file.too_large'));
                return;
            }
            filesReading++;
            const reader = new FileReader();
            reader.onload = (e) => {
                filesReading--;
                const isImage = IMAGE_TYPES.includes(file.type);
                pendingFiles.push({
                    file,
                    name: file.name,
                    mime: file.type || 'application/octet-stream',
                    dataUrl: e.target.result,
                    isImage
                });
                renderFilePreview();
            };
            reader.onerror = () => { filesReading--; };
            reader.readAsDataURL(file);
        }

        function removePendingFile(index) {
            pendingFiles.splice(index, 1);
            renderFilePreview();
        }

        function renderFilePreview() {
            const bar = document.getElementById('file-preview-bar');
            if (pendingFiles.length === 0) {
                bar.className = 'file-preview-bar';
                bar.innerHTML = '';
                return;
            }
            bar.className = 'file-preview-bar has-files';
            bar.innerHTML = pendingFiles.map((f, i) => {
                const thumb = f.isImage
                    ? `<img src="${f.dataUrl}" alt="${escapeHtml(f.name)}">`
                    : `<span class="file-icon">📄</span>`;
                return `<div class="file-preview-item">
                    ${thumb}
                    <span class="file-name">${escapeHtml(f.name)}</span>
                    <button class="file-remove" onclick="removePendingFile(${i})">✕</button>
                </div>`;
            }).join('');
        }

        // 拖拽上传
        (function initDragDrop() {
            document.addEventListener('DOMContentLoaded', () => {
                const wrapper = document.getElementById('input-wrapper');
                if (!wrapper) return;
                let dragCounter = 0;
                wrapper.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    dragCounter++;
                    wrapper.classList.add('dragging');
                });
                wrapper.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dragCounter--;
                    if (dragCounter <= 0) {
                        dragCounter = 0;
                        wrapper.classList.remove('dragging');
                    }
                });
                wrapper.addEventListener('dragover', (e) => e.preventDefault());
                wrapper.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dragCounter = 0;
                    wrapper.classList.remove('dragging');
                    const files = Array.from(e.dataTransfer.files);
                    files.forEach(addPendingFile);
                });
            });
        })();

        // ==================== 工具函数 ====================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== AI 模型选择 ====================
        const MODEL_DEFINITIONS = [
            {
                id: 'gemini',
                name: 'Gemini 2.5 Flash',
                iconClass: 'gemini-icon',
                svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 0C12 6.627 6.627 12 0 12c6.627 0 12 5.373 12 12 0-6.627 5.373-12 12-12-6.627 0-12-5.373-12-12Z" fill="url(#gemini-grad)"/><defs><linearGradient id="gemini-grad" x1="0" y1="0" x2="24" y2="24" gradientUnits="userSpaceOnUse"><stop stop-color="#4285F4"/><stop offset=".5" stop-color="#9B72CB"/><stop offset="1" stop-color="#D96570"/></linearGradient></defs></svg>`,
                desc_en: 'Fast · Thinking · Multimodal',
                desc_zh: '快速 · 思考 · 多模态',
                badge_en: 'Free',
                badge_zh: '免费',
                hasThinking: true,
            },
            {
                id: 'gpt4o',
                name: 'GPT-4o',
                iconClass: 'openai-icon',
                svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494zM3.6 18.304a4.47 4.47 0 0 1-.535-3.014l.142.085 4.783 2.759a.771.771 0 0 0 .78 0l5.843-3.369v2.332a.08.08 0 0 1-.033.062L9.74 19.95a4.5 4.5 0 0 1-6.14-1.646zM2.34 7.896a4.485 4.485 0 0 1 2.366-1.973V11.6a.766.766 0 0 0 .388.676l5.815 3.355-2.02 1.168a.076.076 0 0 1-.071 0l-4.83-2.786A4.504 4.504 0 0 1 2.34 7.872zm16.597 3.855l-5.833-3.387L15.119 7.2a.076.076 0 0 1 .071 0l4.83 2.791a4.494 4.494 0 0 1-.676 8.105v-5.678a.79.79 0 0 0-.407-.667zm2.01-3.023l-.141-.085-4.774-2.782a.776.776 0 0 0-.785 0L9.409 9.23V6.897a.066.066 0 0 1 .028-.061l4.83-2.787a4.5 4.5 0 0 1 6.68 4.66zm-12.64 4.135l-2.02-1.164a.08.08 0 0 1-.038-.057V6.075a4.5 4.5 0 0 1 7.375-3.453l-.142.08L8.704 5.46a.795.795 0 0 0-.393.681zm1.097-2.365l2.602-1.5 2.607 1.5v2.999l-2.597 1.5-2.607-1.5z" fill="#fff"/></svg>`,
                desc_en: 'Heartfelt · Emotionally aware',
                desc_zh: '更走心 · 懂情绪',
                badge_en: 'Limited Free',
                badge_zh: '限时免费',
                hasThinking: false,
            },
            {
                id: 'grok',
                name: 'Grok 4.1 Fast Reasoning',
                iconClass: 'grok-icon',
                svg: `<svg viewBox="0 0 512 510" xmlns="http://www.w3.org/2000/svg"><path d="M213.2 306l179-180v.2l51.7-51.8c-.9 1.3-1.9 2.6-2.8 3.9-39.3 54.2-58.5 80.6-43.1 146.9l-.1-.1c10.6 45.1-.7 95.1-37.4 131.8-46.2 46.3-120.2 56.6-181.1 14.9l42.5-19.7c38.9 15.3 81.4 8.6 111.9-22 30.6-30.6 37.4-75.2 22.1-112.3-2.9-7-11.7-8.8-17.8-4.3L213.2 306zm-25.8 22.4l-.03.03L68.1 435.2c7.6-10.4 17-20.3 26.3-30.1 26.4-27.8 52.7-55.4 36.7-94.3-21.4-52.1-9-113.2 30.7-152.9 41.2-41.3 102-51.7 152.7-30.8 11.2 4.2 21 10.1 28.6 15.6l-42.4 19.6c-39.4-16.6-84.6-5.3-112.2 22.3-37.3 37.3-44.8 102-1.1 143.8z" fill="#fff"/></svg>`,
                desc_en: 'Intimate · Open',
                desc_zh: '更亲密 · 更开放',
                badge_en: 'Limited Free',
                badge_zh: '限时免费',
                hasThinking: false,
            },
        ];

        let selectedModel = null;
        // ==================== Markdown 渲染 ====================
        function renderMarkdown(text) {
            if (!text) return '';
            let html = escapeHtml(text);
            // Headings: ### heading (h1-h3)
            html = html.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');
            // Horizontal rule: --- or ***
            html = html.replace(/^[\-\*]{3,}\s*$/gm, '<hr>');
            // Blockquote: > text
            html = html.replace(/^&gt;\s*(.+)$/gm, '<blockquote>$1</blockquote>');
            // Bold: **text**
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Italic: *text*
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            // Inline code: `code`
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Ordered list items: 1. item (must come before unordered)
            html = html.replace(/^\d+\.\s+(.+)$/gm, '<ol-li>$1</ol-li>');
            // Unordered list items: - item
            html = html.replace(/^[\-\•]\s+(.+)$/gm, '<li>$1</li>');
            // Wrap consecutive <li> in <ul>
            html = html.replace(/((?:<li>.*?<\/li>\n?)+)/g, '<ul>$1</ul>');
            // Wrap consecutive <ol-li> in <ol>
            html = html.replace(/((?:<ol-li>.*?<\/ol-li>\n?)+)/g, (match) => {
                return '<ol>' + match.replace(/<\/?ol-li>/g, (t) => t.replace('ol-li', 'li')) + '</ol>';
            });
            // Paragraphs: double newline (but not around block elements)
            html = html.replace(/\n\n+/g, '</p><p>');
            // Single newline to <br> (but not right after block elements)
            html = html.replace(/\n/g, '<br>');
            html = '<p>' + html + '</p>';
            // Clean up: remove <p> wrapping around block elements
            html = html.replace(/<p>(<(?:h[1-3]|ul|ol|hr|blockquote)[\s>])/g, '$1');
            html = html.replace(/(<\/(?:h[1-3]|ul|ol|hr|blockquote)>)<\/p>/g, '$1');
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p><br>/g, '<p>');
            // Merge consecutive blockquotes
            html = html.replace(/<\/blockquote><br><blockquote>/g, '<br>');
            return html;
        }

        function addThinkingBubble(thinkingText) {
            if (!thinkingText) return;
            const container = document.getElementById('messages-container');
            const typingIndicator = document.getElementById('typing-indicator');
            const bubble = document.createElement('div');
            bubble.className = 'thinking-bubble collapsed';

            bubble.innerHTML = `
                <div class="thinking-header">
                    <span class="thinking-header-left">
                        <span class="thinking-icon-brain">💭</span>
                        <span data-i18n="thinking.header">${t('thinking.header')}</span>
                    </span>
                    <span class="thinking-chevron">▾</span>
                </div>
                <div class="thinking-text">${renderMarkdown(thinkingText)}</div>
            `;
            bubble.onclick = () => bubble.classList.toggle('collapsed');
            container.insertBefore(bubble, typingIndicator);
        }

        function renderModelSelector() {
            const container = document.getElementById('model-selector');
            if (!container) return;

            const currentModel = state.user?.settings?.model || 'gemini';
            selectedModel = currentModel;

            container.innerHTML = MODEL_DEFINITIONS.map(model => {
                const isSelected = model.id === currentModel;
                const badge = state.language === 'zh-CN' ? model.badge_zh : model.badge_en;
                const desc = state.language === 'zh-CN' ? model.desc_zh : model.desc_en;
                return `
                    <div class="model-option ${isSelected ? 'selected' : ''}"
                         onclick="selectModel('${model.id}')"
                         data-model="${model.id}">
                        <div class="model-option-icon ${model.iconClass}">${model.svg}</div>
                        <div class="model-option-info">
                            <div class="model-option-name">${model.name}</div>
                            <div class="model-option-desc">${desc}</div>
                        </div>
                        ${badge ? `<span class="model-option-badge">${badge}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        function selectModel(modelId) {
            selectedModel = modelId;
            document.querySelectorAll('.model-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.model === modelId);
            });
        }

        function updateModelIndicator() {
            const indicator = document.getElementById('model-indicator');
            if (!indicator) return;

            const modelId = state.user?.settings?.model || 'gemini';
            const model = MODEL_DEFINITIONS.find(m => m.id === modelId);
            indicator.textContent = model ? model.name : 'Gemini 2.5 Flash';
        }

        // ==================== 用户设置模态框 ====================
        let pendingAvatarData = null; // 临时存储待保存的头像

        // ==================== Companion 头像修改 ====================
        let pendingCompanionAvatar = null;

        function openCompanionAvatarModal() {
            const modal = document.getElementById('companion-avatar-modal');
            const preview = document.getElementById('companion-avatar-preview');
            const currentAvatar = state.user?.settings?.companion_avatar || 'images/avatar.png';
            preview.src = currentAvatar;
            pendingCompanionAvatar = null;
            modal.classList.add('active');
        }

        function closeCompanionAvatarModal() {
            document.getElementById('companion-avatar-modal').classList.remove('active');
            pendingCompanionAvatar = null;
        }

        function resetCompanionAvatar() {
            pendingCompanionAvatar = 'images/avatar.png';
            document.getElementById('companion-avatar-preview').src = 'images/avatar.png';
        }

        function handleCompanionAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) { alert('Please select an image file'); return; }
            if (file.size > 2 * 1024 * 1024) { alert('Image must be less than 2MB'); return; }

            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                document.getElementById('companion-avatar-preview').src = dataUrl;
                document.querySelectorAll('.companion-avatar-preset-item').forEach(el => el.classList.remove('selected'));
                pendingCompanionAvatar = dataUrl;
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        async function saveCompanionAvatar() {
            if (!pendingCompanionAvatar) {
                closeCompanionAvatarModal();
                return;
            }
            try {
                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/user/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ companion_avatar: pendingCompanionAvatar })
                });
                if (response.ok) {
                    if (!state.user.settings) state.user.settings = {};
                    state.user.settings.companion_avatar = pendingCompanionAvatar;
                    localStorage.setItem('soullink_user', JSON.stringify(state.user));
                    updateCompanionAvatars();
                    closeCompanionAvatarModal();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to save avatar');
                }
            } catch (err) {
                console.error('Save companion avatar error:', err);
                alert('Network error');
            }
        }

        function updateCompanionAvatars() {
            const avatarUrl = state.user?.settings?.companion_avatar || 'images/avatar.png';
            // Header avatar
            const headerAvatar = document.getElementById('header-companion-avatar');
            if (headerAvatar) headerAvatar.src = avatarUrl;
            // All message avatars for assistant messages
            document.querySelectorAll('.message.assistant .message-avatar').forEach(img => {
                img.src = avatarUrl;
            });
            // Typing indicator avatar
            const typingAvatar = document.querySelector('#typing-indicator .message-avatar');
            if (typingAvatar) typingAvatar.src = avatarUrl;
        }

        // Close on overlay click
        document.getElementById('companion-avatar-modal')?.addEventListener('click', function(e) {
            if (e.target === this) closeCompanionAvatarModal();
        });

        // ==================== 版本日志 ====================
        function openChangelogModal() {
            document.getElementById('changelog-modal').classList.add('active');
            closeMobileSidebar();
        }
        function closeChangelogModal() {
            document.getElementById('changelog-modal').classList.remove('active');
            if (window._changelogAutoPopped) {
                localStorage.setItem('last_seen_version', CURRENT_APP_VERSION);
                window._changelogAutoPopped = false;
            }
        }
        document.getElementById('changelog-modal')?.addEventListener('click', function(e) {
            if (e.target === this) closeChangelogModal();
        });

        // 版本更新弹窗：当用户上次看到的版本 < 当前版本时自动弹出 changelog
        const CURRENT_APP_VERSION = 'v0.0.6-beta';
        function showChangelogIfNewVersion() {
            const lastSeen = localStorage.getItem('last_seen_version');
            if (lastSeen === CURRENT_APP_VERSION) return;
            // 延迟弹出，等社群弹窗先走完
            setTimeout(() => {
                openChangelogModal();
                // 关闭时才标记已读（在 closeChangelogModal 里处理）
                window._changelogAutoPopped = true;
            }, 2500);
        }

        // ==================== About & Feedback ====================
        let selectedFeedbackType = 'suggestion';

        function openAboutModal() {
            document.getElementById('about-modal').classList.add('active');
            closeMobileSidebar();
        }
        function closeAboutModal() {
            document.getElementById('about-modal').classList.remove('active');
        }
        document.getElementById('about-modal')?.addEventListener('click', function(e) {
            if (e.target === this) closeAboutModal();
        });

        function selectFeedbackType(btn) {
            document.querySelectorAll('.feedback-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedFeedbackType = btn.dataset.type;
        }

        // Character counter
        document.getElementById('feedback-text')?.addEventListener('input', function() {
            document.getElementById('feedback-char-count').textContent = `${this.value.length}/1000`;
        });

        function showDonateQR(type) {
            const container = document.getElementById('donate-qr-container');
            const img = document.getElementById('donate-qr-img');
            const qrMap = {
                zelle: 'paytous/zelle.jpg?v=2',
                wechat: 'paytous/wechat.jpg?v=2',
                alipay: 'paytous/alipay.jpg?v=2'
            };
            // Toggle buttons
            document.querySelectorAll('.about-donate-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = event.currentTarget;

            if (img.dataset.current === type && !container.classList.contains('hidden')) {
                container.classList.add('hidden');
                img.dataset.current = '';
                return;
            }
            activeBtn.classList.add('active');
            img.src = qrMap[type];
            img.dataset.current = type;
            container.classList.remove('hidden');
        }

        async function submitFeedback() {
            const text = document.getElementById('feedback-text').value.trim();
            if (!text) { alert(state.language === 'zh-CN' ? '请输入反馈内容' : 'Please enter your feedback'); return; }

            const btn = document.querySelector('.about-feedback-submit');
            btn.disabled = true;
            btn.textContent = state.language === 'zh-CN' ? '提交中...' : 'Submitting...';

            try {
                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/feedback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: selectedFeedbackType,
                        content: text
                    })
                });

                if (response.ok) {
                    document.getElementById('feedback-text').value = '';
                    document.getElementById('feedback-char-count').textContent = '0/1000';
                    document.getElementById('feedback-success').classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('feedback-success').classList.add('hidden');
                    }, 3000);
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to submit feedback');
                }
            } catch (err) {
                console.error('Feedback submit error:', err);
                alert('Network error');
            } finally {
                btn.disabled = false;
                btn.textContent = state.language === 'zh-CN' ? '提交反馈' : 'Submit Feedback';
            }
        }

        // ==================== AI 改名 ====================
        function openRenameModal() {
            const modal = document.getElementById('rename-modal');
            const input = document.getElementById('rename-input');
            const currentName = state.user?.settings?.companion_name || 'Abigail';
            input.value = currentName;
            modal.classList.add('active');
            setTimeout(() => input.select(), 100);
        }

        function closeRenameModal() {
            document.getElementById('rename-modal').classList.remove('active');
        }

        async function saveCompanionName() {
            const input = document.getElementById('rename-input');
            const newName = input.value.trim();
            if (!newName || newName.length > 20) return;

            try {
                const res = await authFetch(`${CONFIG.API_BASE_URL}/api/user/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'

                    },
                    body: JSON.stringify({ companion_name: newName })
                });

                if (res.ok) {
                    // 更新本地状态
                    if (!state.user.settings) state.user.settings = {};
                    state.user.settings.companion_name = newName;
                    localStorage.setItem('soullink_user', JSON.stringify(state.user));

                    // 更新 UI
                    document.getElementById('companion-name-display').textContent = newName;
                    applyLanguage(); // 刷新所有含 {companion} 的文字

                    closeRenameModal();

                    // 静默通知 AI 名字已更改（不显示在聊天里）
                    const lang = state.language || 'en';
                    const silentMsg = lang === 'zh-CN'
                        ? `[系统通知：用户已将你的名字改为「${newName}」，从现在起你叫${newName}，请用新名字回应]`
                        : `[System notice: The user has renamed you to "${newName}". From now on your name is ${newName}. Please respond with your new name.]`;
                    try {
                        await authFetch(`${CONFIG.API_BASE_URL}/api/chat`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: silentMsg,
                                conversation_id: state.currentConversationId,
                                silent: true
                            })
                        });
                    } catch (e) {
                        console.warn('Silent rename notification failed:', e);
                    }
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to update name');
                }
            } catch (e) {
                console.error('Error saving companion name:', e);
                alert('Network error');
            }
        }

        // 点击弹窗外部关闭
        document.getElementById('rename-modal').addEventListener('click', function(e) {
            if (e.target === this) closeRenameModal();
        });

        function openSettingsModal() {
            const modal = document.getElementById('settings-modal');
            modal.classList.remove('hidden');

            // 填充当前用户信息
            document.getElementById('settings-name').value = state.user?.name || '';
            document.getElementById('settings-email').value = state.user?.email || '';
            document.getElementById('settings-avatar-img').src = state.user?.avatar_url || 'images/avatar.png';

            // 清除之前的选中状态
            document.querySelectorAll('.avatar-preset').forEach(el => el.classList.remove('selected'));
            pendingAvatarData = null;

            // 渲染模型选择器
            renderModelSelector();

            // 初始化伴侣风格选择器
            settingsSelectedGender = state.user?.settings?.companion_gender || 'female';
            settingsSelectedSubtype = state.user?.settings?.companion_subtype || 'female_gentle';
            toggleSettingsGender(settingsSelectedGender);
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
            pendingAvatarData = null;
        }

        function selectPresetAvatar(src) {
            // 更新预览
            document.getElementById('settings-avatar-img').src = src;

            // 更新选中状态
            document.querySelectorAll('.avatar-preset').forEach(el => {
                el.classList.remove('selected');
                if (el.src.includes(src.split('/').pop())) {
                    el.classList.add('selected');
                }
            });
            document.querySelectorAll('.avatar-color-preset').forEach(el => el.classList.remove('selected'));

            // 存储选择（预设头像直接用路径）
            pendingAvatarData = { type: 'preset', url: src };
        }

        function selectColorAvatar(color) {
            // 生成带用户名首字母的颜色头像
            const name = document.getElementById('settings-name').value.trim() || state.user?.name || 'U';
            const initial = name.charAt(0).toUpperCase();
            const avatarDataUrl = generateColorAvatar(color, initial);

            // 更新预览
            document.getElementById('settings-avatar-img').src = avatarDataUrl;

            // 更新选中状态
            document.querySelectorAll('.avatar-preset').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.avatar-color-preset').forEach(el => {
                el.classList.remove('selected');
                if (el.style.background.includes(color)) {
                    el.classList.add('selected');
                }
            });

            // 存储选择
            pendingAvatarData = { type: 'upload', dataUrl: avatarDataUrl };
        }

        function generateColorAvatar(color, initial) {
            // 使用 Canvas 生成带首字母的颜色头像
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 200;
            const ctx = canvas.getContext('2d');

            // 绘制渐变背景
            const gradient = ctx.createLinearGradient(0, 0, 200, 200);
            gradient.addColorStop(0, color);
            gradient.addColorStop(1, adjustColor(color, -30));
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(100, 100, 100, 0, Math.PI * 2);
            ctx.fill();

            // 绘制文字
            ctx.fillStyle = 'white';
            ctx.font = 'bold 80px Poppins, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(initial, 100, 105);

            return canvas.toDataURL('image/png');
        }

        function adjustColor(color, amount) {
            // 简单调整颜色亮度
            const hex = color.replace('#', '');
            const r = Math.max(0, Math.min(255, parseInt(hex.substr(0, 2), 16) + amount));
            const g = Math.max(0, Math.min(255, parseInt(hex.substr(2, 2), 16) + amount));
            const b = Math.max(0, Math.min(255, parseInt(hex.substr(4, 2), 16) + amount));
            return `rgb(${r}, ${g}, ${b})`;
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 验证文件类型
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // 验证文件大小（最大 2MB）
            if (file.size > 2 * 1024 * 1024) {
                alert('Image size must be less than 2MB');
                return;
            }

            // 读取并预览
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                document.getElementById('settings-avatar-img').src = dataUrl;

                // 清除预设选中状态
                document.querySelectorAll('.avatar-preset').forEach(el => el.classList.remove('selected'));

                // 存储上传的图片数据
                pendingAvatarData = { type: 'upload', dataUrl: dataUrl };
            };
            reader.readAsDataURL(file);
        }

        async function saveSettings() {
            const newName = document.getElementById('settings-name').value.trim();

            if (!newName || newName.length < 2) {
                alert('Nickname must be at least 2 characters');
                return;
            }

            if (newName.length > 20) {
                alert('Nickname must be 20 characters or less');
                return;
            }

            // 准备更新数据
            const updates = {};
            let hasChanges = false;

            if (newName !== state.user.name) {
                updates.name = newName;
                hasChanges = true;
            }

            if (pendingAvatarData) {
                if (pendingAvatarData.type === 'preset') {
                    updates.avatar_url = pendingAvatarData.url;
                } else if (pendingAvatarData.type === 'upload') {
                    updates.avatar_url = pendingAvatarData.dataUrl;
                }
                hasChanges = true;
            }

            // 检测模型变化
            const currentModel = state.user?.settings?.model || 'gemini';
            const modelChanged = selectedModel && selectedModel !== currentModel;
            if (modelChanged) hasChanges = true;

            // 检测伴侣风格变化
            const currentGender = state.user?.settings?.companion_gender || 'female';
            const currentSubtype = state.user?.settings?.companion_subtype || 'female_gentle';
            const styleChanged = (settingsSelectedGender && settingsSelectedGender !== currentGender) ||
                                 (settingsSelectedSubtype && settingsSelectedSubtype !== currentSubtype);
            if (styleChanged) hasChanges = true;

            if (!hasChanges) {
                closeSettingsModal();
                return;
            }

            try {
                // 1. 保存头像/昵称变化
                if (updates.name || updates.avatar_url) {
                    const response = await authFetch(`${CONFIG.API_BASE_URL}/api/user/profile`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updates)
                    });

                    if (response.ok) {
                        if (updates.name) state.user.name = updates.name;
                        if (updates.avatar_url) state.user.avatar_url = updates.avatar_url;
                        localStorage.setItem('soullink_user', JSON.stringify(state.user));
                        updateUserInfo();
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to save settings');
                        return;
                    }
                }

                // 2. 保存模型变化 + 伴侣风格变化
                const settingsPayload = {};
                if (modelChanged) settingsPayload.model = selectedModel;
                if (styleChanged) {
                    settingsPayload.companion_gender = settingsSelectedGender;
                    settingsPayload.companion_subtype = settingsSelectedSubtype;
                }

                if (Object.keys(settingsPayload).length > 0) {
                    const settingsResponse = await authFetch(`${CONFIG.API_BASE_URL}/api/user/settings`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(settingsPayload)
                    });

                    if (settingsResponse.ok) {
                        if (!state.user.settings) state.user.settings = {};
                        if (modelChanged) {
                            state.user.settings.model = selectedModel;
                            updateModelIndicator();
                        }
                        if (styleChanged) {
                            state.user.settings.companion_gender = settingsSelectedGender;
                            state.user.settings.companion_subtype = settingsSelectedSubtype;
                            // 从API响应获取可能更新的companion_name
                            const respData = await settingsResponse.clone().json().catch(() => null);
                            if (respData && respData.companion_name) {
                                state.user.settings.companion_name = respData.companion_name;
                            }
                        }
                        localStorage.setItem('soullink_user', JSON.stringify(state.user));
                    } else {
                        const errData = await settingsResponse.json();
                        alert(errData.error || 'Failed to save settings');
                        return;
                    }
                }

                closeSettingsModal();
            } catch (error) {
                console.error('Save settings error:', error);
                alert('Network error. Please try again.');
            }
        }

        // ESC 键关闭模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('settings-modal');
                if (!modal.classList.contains('hidden')) {
                    closeSettingsModal();
                }
            }
        });

        // ==================== 性格测试 ====================
        let personalityTestState = {
            questions: [],
            currentQuestion: 0,
            answers: [],
            mbti: null,
            tarotCards: [],
            dimensions: {}
        };

        async function checkPersonalityTestStatus() {
            if (!state.token) return;
            try {
                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/personality-test/status`, {
                    headers: {  }
                });
                const data = await response.json();
                if (!data.completed) {
                    const dismissed = localStorage.getItem('soullink_reminder_dismissed');
                    if (!dismissed) {
                        document.getElementById('test-reminder-popup').classList.add('active');
                    }
                }
            } catch (err) {
                console.warn('Failed to check personality test status:', err);
            }
        }

        function dismissReminder() {
            document.getElementById('test-reminder-popup').classList.remove('active');
            localStorage.setItem('soullink_reminder_dismissed', 'true');
        }

        function closePersonalityTest() {
            document.getElementById('personality-test-page').classList.remove('active');
            document.getElementById('tarot-draw-page').classList.remove('active');
            document.getElementById('tarot-results-page').classList.remove('active');
            document.getElementById('gender-selection-page').classList.remove('active');
            document.getElementById('subtype-selection-page').classList.remove('active');
            document.getElementById('companion-naming-page').classList.remove('active');
        }

        function skipPersonalityTest() {
            document.getElementById('personality-test-page').classList.remove('active');
            if (state.isFirstRegistration) {
                // 首次注册：跳过问卷但仍需选性别/性格/取名
                showGenderSelection();
            } else {
                // 重新测试时跳过：直接关闭
                closePersonalityTest();
            }
        }

        async function startPersonalityTest() {
            closeMobileSidebar();
            // Hide reminder if visible
            document.getElementById('test-reminder-popup').classList.remove('active');

            // Reset state
            personalityTestState = {
                questions: [],
                currentQuestion: 0,
                answers: [],
                mbti: null,
                tarotCards: [],
                dimensions: {}
            };

            // Fetch questions
            try {
                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/personality-test/questions?lang=${state.language || 'en'}`, {
                    headers: {  }
                });
                const data = await response.json();
                personalityTestState.questions = data.questions;

                // Show first question
                document.getElementById('personality-test-page').classList.add('active');
                // 跳过按钮只在首次注册时显示
                const skipBtn = document.querySelector('.skip-test-btn');
                if (skipBtn) skipBtn.style.display = state.isFirstRegistration ? 'block' : 'none';
                renderQuestion();
            } catch (err) {
                console.error('Failed to load questions:', err);
                alert('Failed to load personality test. Please try again.');
            }
        }

        function renderQuestion() {
            const q = personalityTestState.questions[personalityTestState.currentQuestion];
            if (!q) return;

            const total = personalityTestState.questions.length;
            const current = personalityTestState.currentQuestion;
            const isMbti = q.type === 'mbti';

            // Progress dots
            const progressHtml = [];
            for (let i = 0; i < total; i++) {
                let cls = 'progress-dot';
                if (i < current) cls += ' filled';
                if (i === current) cls += ' current';
                progressHtml.push(`<div class="${cls}"></div>`);
            }
            progressHtml.push(`<span class="progress-text">${current + 1}/${total}</span>`);
            document.getElementById('question-progress').innerHTML = progressHtml.join('');

            // Question text
            document.getElementById('question-text').textContent = q.text;

            // Options
            const optionsContainer = document.getElementById('question-options');

            if (isMbti) {
                // MBTI grid layout
                let html = `<p class="mbti-hint">${q.hint || ''}</p>`;
                html += '<div class="mbti-grid">';
                q.options.forEach(opt => {
                    html += `<div class="mbti-option" onclick="selectMbti('${opt}')">${opt}</div>`;
                });
                html += '</div>';
                html += `<button class="skip-btn" onclick="selectMbti(null)">${q.skip_text || 'Skip'}</button>`;
                optionsContainer.innerHTML = html;
            } else {
                // Normal question
                let html = '';
                q.options.forEach((opt, i) => {
                    html += `<div class="question-option" onclick="selectAnswer(${q.id}, ${opt.score}, this)">${opt.text}</div>`;
                });
                optionsContainer.innerHTML = html;
            }
        }

        function selectAnswer(questionId, score, element) {
            // Visual feedback
            document.querySelectorAll('.question-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');

            // Save answer
            personalityTestState.answers.push({ question_id: questionId, score: score });

            // Auto-advance after brief delay
            setTimeout(() => {
                personalityTestState.currentQuestion++;
                if (personalityTestState.currentQuestion < personalityTestState.questions.length) {
                    renderQuestion();
                } else {
                    submitPersonalityTest();
                }
            }, 400);
        }

        function selectMbti(mbtiType) {
            personalityTestState.mbti = mbtiType;
            submitPersonalityTest();
        }

        async function submitPersonalityTest() {
            document.getElementById('personality-test-page').classList.remove('active');

            showLoading(t('loading.workspace'));

            try {
                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/personality-test/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        answers: personalityTestState.answers,
                        mbti: personalityTestState.mbti
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    personalityTestState.tarotCards = data.tarot_cards;
                    personalityTestState.dimensions = data.dimensions;

                    // Clear reminder dismissed flag
                    localStorage.removeItem('soullink_reminder_dismissed');

                    showTarotDraw();
                } else {
                    alert(data.error || 'Failed to submit test');
                }
            } catch (err) {
                hideLoading();
                console.error('Submit error:', err);
                alert('Network error. Please try again.');
            }
        }

        function showTarotDraw() {
            const page = document.getElementById('tarot-draw-page');
            page.classList.add('active');

            document.getElementById('tarot-draw-title').textContent = t('tarot.draw.title');
            document.getElementById('tarot-draw-subtitle').textContent = t('tarot.draw.subtitle');

            const positionLabels = {
                'past': t('tarot.position.past'),
                'present': t('tarot.position.present'),
                'future': t('tarot.position.future')
            };

            const row = document.getElementById('tarot-cards-row');
            let html = '';

            personalityTestState.tarotCards.forEach((card, i) => {
                const locked = i > 0 ? ' locked' : '';
                html += `
                    <div>
                        <div class="tarot-card-slot">
                            <div class="tarot-card-inner${locked}" id="tarot-card-${i}" onclick="flipCard(${i})">
                                <div class="tarot-card-face tarot-card-back">
                                    <div class="card-back-symbol">🔮</div>
                                    <div class="card-back-text">${positionLabels[card.position]}</div>
                                </div>
                                <div class="tarot-card-face tarot-card-front tarot-gradient-${card.card_id}">
                                    <div class="tarot-card-numeral">${card.card_numeral}</div>
                                    <div class="tarot-card-name">${card.card_name}</div>
                                    <div class="tarot-card-name-zh">${card.card_name_zh}</div>
                                    <div class="tarot-card-traits">${state.language === 'zh-CN' ? card.traits_zh : card.traits_en}</div>
                                </div>
                            </div>
                        </div>
                        <div class="tarot-position-label">${positionLabels[card.position]}</div>
                    </div>
                `;
            });

            row.innerHTML = html;

            const btn = document.getElementById('view-results-btn');
            btn.textContent = t('tarot.view.results');
            btn.classList.remove('visible');
        }

        function flipCard(index) {
            const card = document.getElementById(`tarot-card-${index}`);
            if (card.classList.contains('locked') || card.classList.contains('flipped')) return;

            card.classList.add('flipped');

            // Unlock next card
            const next = document.getElementById(`tarot-card-${index + 1}`);
            if (next) {
                setTimeout(() => next.classList.remove('locked'), 600);
            }

            // Check if all flipped
            const total = personalityTestState.tarotCards.length;
            const flipped = document.querySelectorAll('.tarot-card-inner.flipped').length + 1;
            if (flipped >= total) {
                setTimeout(() => {
                    document.getElementById('view-results-btn').classList.add('visible');
                }, 800);
            }
        }

        function showTarotResults() {
            document.getElementById('tarot-draw-page').classList.remove('active');
            const page = document.getElementById('tarot-results-page');
            page.classList.add('active');

            document.getElementById('results-title').textContent = t('tarot.results.title');

            const positionLabels = {
                'past': t('tarot.position.past'),
                'present': t('tarot.position.present'),
                'future': t('tarot.position.future')
            };

            // Render result cards
            const cardsRow = document.getElementById('results-cards-row');
            let cardsHtml = '';
            personalityTestState.tarotCards.forEach(card => {
                cardsHtml += `
                    <div class="result-card tarot-gradient-${card.card_id}">
                        <div class="result-card-position">${positionLabels[card.position]}</div>
                        <div class="result-card-numeral">${card.card_numeral}</div>
                        <div class="result-card-name">${card.card_name}</div>
                        <div class="result-card-name-zh">${card.card_name_zh}</div>
                        <div class="result-card-traits">${state.language === 'zh-CN' ? card.traits_zh : card.traits_en}</div>
                    </div>
                `;
            });
            cardsRow.innerHTML = cardsHtml;

            // Profile summary
            const profileDiv = document.getElementById('results-profile');
            const dims = personalityTestState.dimensions;
            const dimLabels = state.language === 'zh-CN'
                ? { social_energy: '社交能量', emotional_expression: '情绪风格', stress_response: '压力应对', life_approach: '生活态度', connection_style: '关系需求' }
                : { social_energy: 'Social Energy', emotional_expression: 'Emotional Style', stress_response: 'Stress Response', life_approach: 'Life Approach', connection_style: 'Connection Style' };

            let profileHtml = `<h3>${t('tarot.profile.title')}</h3>`;
            profileHtml += '<p>';
            Object.entries(dims).forEach(([key, val]) => {
                const label = dimLabels[key] || key;
                const bar = val > 0 ? '▓'.repeat(Math.min(val, 4)) + '░'.repeat(4 - Math.min(val, 4))
                           : '░'.repeat(4 - Math.min(Math.abs(val), 4)) + '▓'.repeat(Math.min(Math.abs(val), 4));
                profileHtml += `${label}: ${bar} (${val > 0 ? '+' : ''}${val})<br>`;
            });
            profileHtml += '</p>';
            profileDiv.innerHTML = profileHtml;

            // Start chat button
            const chatBtn = page.querySelector('.start-chat-btn');
            chatBtn.textContent = t('tarot.start.chat');
        }

        function finishPersonalityTest() {
            document.getElementById('tarot-results-page').classList.remove('active');
            // Already in app view, just ensure it's visible
            showApp();
        }

        // ==================== 伴侣风格选择 ====================

        const SUBTYPES = {
            female: [
                { id: 'female_gentle', icon: '🌸', name_zh: '温柔姐姐', name_en: 'Gentle Big Sis', desc_zh: '温柔体贴、包容成熟', desc_en: 'Warm, caring, mature' },
                { id: 'female_cute', icon: '🎀', name_zh: '元气少女', name_en: 'Energetic Girl', desc_zh: '活泼可爱、爱撒娇', desc_en: 'Lively, cute, playful' },
                { id: 'female_cool', icon: '💎', name_zh: '知性御姐', name_en: 'Cool Beauty', desc_zh: '独立知性、有主见', desc_en: 'Independent, intellectual' },
                { id: 'female_sweet', icon: '🐶', name_zh: '甜美小奶狗', name_en: 'Sweet Puppy', desc_zh: '黏人甜蜜、容易害羞', desc_en: 'Clingy, sweet, shy' },
            ],
            male: [
                { id: 'male_ceo', icon: '🏢', name_zh: '霸道总裁', name_en: 'Tsundere CEO', desc_zh: '冷酷外表、内心温柔', desc_en: 'Cool exterior, warm inside' },
                { id: 'male_warm', icon: '📚', name_zh: '温柔学长', name_en: 'Gentle Scholar', desc_zh: '温柔知性、耐心倾听', desc_en: 'Gentle, intellectual, patient' },
                { id: 'male_sunshine', icon: '☀️', name_zh: '阳光少年', name_en: 'Sunshine Boy', desc_zh: '开朗活泼、正能量', desc_en: 'Cheerful, energetic, positive' },
                { id: 'male_guardian', icon: '🛡️', name_zh: '忠犬男友', name_en: 'Loyal Guardian', desc_zh: '默默守护、安全感', desc_en: 'Silent protector, reliable' },
            ],
        };

        function showGenderSelection() {
            document.getElementById('tarot-results-page').classList.remove('active');
            const page = document.getElementById('gender-selection-page');
            page.classList.add('active');
            const isZh = state.language === 'zh-CN';
            document.getElementById('gender-selection-title').textContent = isZh ? '选择你的伴侣类型' : 'Choose Companion Type';
            document.getElementById('gender-selection-subtitle').textContent = isZh ? '你希望你的灵魂伴侣是...？' : 'You want your soulmate to be...?';
        }

        function selectGender(gender) {
            state.selectedGender = gender;
            document.getElementById('gender-selection-page').classList.remove('active');
            showSubtypeSelection(gender);
        }

        function showSubtypeSelection(gender) {
            const page = document.getElementById('subtype-selection-page');
            page.classList.add('active');
            const isZh = state.language === 'zh-CN';
            document.getElementById('subtype-title').textContent =
                gender === 'female'
                    ? (isZh ? '选择她的性格' : "Choose Her Personality")
                    : (isZh ? '选择他的性格' : "Choose His Personality");

            const container = document.getElementById('subtype-cards');
            const subtypes = SUBTYPES[gender];
            container.innerHTML = subtypes.map(s => `
                <div class="subtype-card" onclick="selectSubtype('${s.id}')">
                    <div class="subtype-icon">${s.icon}</div>
                    <h3>${isZh ? s.name_zh : s.name_en}</h3>
                    <p>${isZh ? s.desc_zh : s.desc_en}</p>
                </div>
            `).join('');
        }

        async function selectSubtype(subtypeId) {
            showLoading(state.language === 'zh-CN' ? '正在设置...' : 'Setting up...');
            try {
                const gender = state.selectedGender;
                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/user/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        companion_gender: gender,
                        companion_subtype: subtypeId
                    })
                });
                hideLoading();
                if (response.ok) {
                    if (!state.user.settings) state.user.settings = {};
                    state.user.settings.companion_gender = gender;
                    state.user.settings.companion_subtype = subtypeId;
                    localStorage.setItem('soullink_user', JSON.stringify(state.user));
                }
            } catch (err) {
                hideLoading();
                console.error('Style selection error:', err);
            }
            document.getElementById('subtype-selection-page').classList.remove('active');
            if (state.isFirstRegistration) {
                showCompanionNaming();
            } else {
                showApp();
            }
        }

        function showCompanionNaming() {
            const page = document.getElementById('companion-naming-page');
            page.classList.add('active');
            const input = document.getElementById('companion-name-input');
            // 根据性别设置默认 placeholder
            const isMale = state.selectedGender === 'male';
            const isZh = state.language === 'zh-CN';
            input.placeholder = isMale ? (isZh ? '例如：Gavin' : 'e.g. Gavin') : (isZh ? '例如：Abigail' : 'e.g. Abigail');
            input.value = '';
            setTimeout(() => input.focus(), 300);

            // 渲染模型选择卡片
            const recText = isZh ? '推荐' : 'Recommended';
            const container = document.getElementById('onboarding-model-selector');
            state._onboardingModel = 'grok'; // 默认选 Grok
            container.innerHTML = MODEL_DEFINITIONS.map(model => {
                const isSelected = model.id === 'grok';
                const desc = isZh ? model.desc_zh : model.desc_en;
                const badge = isZh ? model.badge_zh : model.badge_en;
                return `
                    <div class="onboarding-model-card ${isSelected ? 'selected' : ''}"
                         onclick="selectOnboardingModel('${model.id}')" data-model="${model.id}"
                         style="position:relative; display:flex; align-items:center; gap:12px; padding:12px 14px;
                                background:${isSelected ? 'rgba(124,58,237,0.25)' : 'rgba(20,20,40,0.55)'};
                                border:2px solid ${isSelected ? '#7c3aed' : 'rgba(255,255,255,0.15)'};
                                border-radius:12px; cursor:pointer; transition:all 0.2s;
                                backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);">
                        ${model.id === 'grok' ? `<span style="position:absolute;top:-8px;left:12px;padding:2px 8px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:6px;font-size:0.65rem;font-weight:600;">${recText}</span>` : ''}
                        <div style="width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;background:rgba(255,255,255,0.12);">
                            <div style="width:24px;height:24px;">${model.id === 'gemini' ? '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 0C12 6.627 6.627 12 0 12c6.627 0 12 5.373 12 12 0-6.627 5.373-12 12-12-6.627 0-12-5.373-12-12Z" fill="#fff"/></svg>' : model.svg}</div>
                        </div>
                        <div style="flex:1;text-align:left;">
                            <div style="color:#fff;font-size:0.9rem;font-weight:600;">${model.name}</div>
                            <div style="color:#a0a8b8;font-size:0.75rem;">${desc}</div>
                        </div>
                        ${badge ? `<span style="padding:2px 8px;background:rgba(255,255,255,0.1);color:#8a94a6;border-radius:6px;font-size:0.65rem;">${badge}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        function selectOnboardingModel(modelId) {
            state._onboardingModel = modelId;
            document.querySelectorAll('.onboarding-model-card').forEach(el => {
                const isSel = el.dataset.model === modelId;
                el.classList.toggle('selected', isSel);
                el.style.background = isSel ? 'rgba(124,58,237,0.25)' : 'rgba(20,20,40,0.55)';
                el.style.borderColor = isSel ? '#7c3aed' : 'rgba(255,255,255,0.15)';
            });
        }

        async function confirmCompanionName() {
            const input = document.getElementById('companion-name-input');
            const name = input.value.trim();
            // 如果用户没输入，用默认名
            const companionName = name || (state.selectedGender === 'male' ? 'Gavin' : 'Abigail');
            const chosenModel = state._onboardingModel || 'grok';

            showLoading(state.language === 'zh-CN' ? '正在设置...' : 'Setting up...');
            try {
                // 保存伴侣名 + 模型（一次请求）
                const response = await authFetch(`${CONFIG.API_BASE_URL}/api/user/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ companion_name: companionName, model: chosenModel })
                });
                hideLoading();
                if (response.ok) {
                    if (!state.user.settings) state.user.settings = {};
                    state.user.settings.companion_name = companionName;
                    state.user.settings.model = chosenModel;
                    localStorage.setItem('soullink_user', JSON.stringify(state.user));
                }
            } catch (err) {
                hideLoading();
                console.error('Companion naming error:', err);
            }
            document.getElementById('companion-naming-page').classList.remove('active');
            state.isFirstRegistration = false;
            showApp();
        }

        // ==================== 设置页伴侣风格 ====================

        let settingsSelectedGender = null;
        let settingsSelectedSubtype = null;

        function toggleSettingsGender(gender) {
            settingsSelectedGender = gender;
            document.querySelectorAll('.settings-style-selector .gender-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.settings-style-selector .gender-btn[data-gender="${gender}"]`);
            if (btn) btn.classList.add('active');
            renderSettingsSubtypes(gender);
        }

        function renderSettingsSubtypes(gender) {
            const row = document.getElementById('settings-subtype-row');
            if (!row) return;
            const subtypes = SUBTYPES[gender];
            const isZh = state.language === 'zh-CN';
            row.innerHTML = subtypes.map(s => `
                <button class="subtype-btn${s.id === settingsSelectedSubtype ? ' active' : ''}"
                        onclick="selectSettingsSubtype('${s.id}')">
                    ${s.icon} ${isZh ? s.name_zh : s.name_en}
                </button>
            `).join('');
        }

        function selectSettingsSubtype(subtypeId) {
            settingsSelectedSubtype = subtypeId;
            document.querySelectorAll('#settings-subtype-row .subtype-btn').forEach(b => {
                b.classList.toggle('active', b.textContent.includes(subtypeId.split('_').pop()) || false);
            });
            // 更简洁的方式：直接重新渲染
            renderSettingsSubtypes(settingsSelectedGender);
        }

        // ===== Background Picker =====
        const BACKGROUNDS = [
            { id: 'default', file: 'bg.png', path: 'images/bg.png', thumb: 'images/Background/thumbnails/bg.jpg', label: 'Default' },
            { id: 'bg01', file: 'aditya-anjagi-KZSDCocsOEE-unsplash.jpg', thumb: 'images/Background/thumbnails/aditya-anjagi-KZSDCocsOEE-unsplash.jpg' },
            { id: 'bg02', file: 'alex-mesmer-6h6O17NjZ_I-unsplash.jpg', thumb: 'images/Background/thumbnails/alex-mesmer-6h6O17NjZ_I-unsplash.jpg' },
            { id: 'bg03', file: 'ali-kazal-Vn7nOtD9DmQ-unsplash.jpg', thumb: 'images/Background/thumbnails/ali-kazal-Vn7nOtD9DmQ-unsplash.jpg' },
            { id: 'bg04', file: 'filiz-elaerts-J_C3_JpJMms-unsplash.jpg', thumb: 'images/Background/thumbnails/filiz-elaerts-J_C3_JpJMms-unsplash.jpg' },
            { id: 'bg05', file: 'florian-schindler-EYj2rSMGnU0-unsplash.jpg', thumb: 'images/Background/thumbnails/florian-schindler-EYj2rSMGnU0-unsplash.jpg' },
            { id: 'bg06', file: 'liana-s-RBLc00d72yo-unsplash.jpg', thumb: 'images/Background/thumbnails/liana-s-RBLc00d72yo-unsplash.jpg' },
            { id: 'bg07', file: 'marek-piwnicki-pE9RxXqGbd4-unsplash.jpg', thumb: 'images/Background/thumbnails/marek-piwnicki-pE9RxXqGbd4-unsplash.jpg' },
            { id: 'bg08', file: 'matt-liu-FT7J1SONJA8-unsplash.jpg', thumb: 'images/Background/thumbnails/matt-liu-FT7J1SONJA8-unsplash.jpg' },
            { id: 'bg09', file: 'mike-hindle-By65zuM4fAc-unsplash.jpg', thumb: 'images/Background/thumbnails/mike-hindle-By65zuM4fAc-unsplash.jpg' },
            { id: 'bg10', file: 'museum-of-new-zealand-te-papa-tongarewa-hFXKUCTWEMI-unsplash.jpg', thumb: 'images/Background/thumbnails/museum-of-new-zealand-te-papa-tongarewa-hFXKUCTWEMI-unsplash.jpg' },
            { id: 'bg11', file: 'pascal-debrunner-8xkImX3so8U-unsplash.jpg', thumb: 'images/Background/thumbnails/pascal-debrunner-8xkImX3so8U-unsplash.jpg' },
            { id: 'bg12', file: 'pexels-nolan-lee-109304063-10259638.jpg', thumb: 'images/Background/thumbnails/pexels-nolan-lee-109304063-10259638.jpg' },
            { id: 'bg13', file: 'pexels-pauldeetman-2695679.jpg', thumb: 'images/Background/thumbnails/pexels-pauldeetman-2695679.jpg' },
            { id: 'bg14', file: 'pic-kaca-unsplash.jpg', thumb: 'images/Background/thumbnails/pic-kaca-unsplash.jpg' },
            { id: 'bg15', file: 'robert-clark-XKaHnkxBc1w-unsplash.jpg', thumb: 'images/Background/thumbnails/robert-clark-XKaHnkxBc1w-unsplash.jpg' },
            { id: 'bg16', file: 'shubham-dhage-TXTmUUGuvpQ-unsplash.jpg', thumb: 'images/Background/thumbnails/shubham-dhage-TXTmUUGuvpQ-unsplash.jpg' },
            { id: 'bg17', file: 'tobias-reich-CI8UPpze-V4-unsplash.jpg', thumb: 'images/Background/thumbnails/tobias-reich-CI8UPpze-V4-unsplash.jpg' },
        ];

        let bgPickerRendered = false;

        function toggleBgPicker() {
            const panel = document.getElementById('bg-picker-panel');
            const isOpen = panel.classList.contains('open');
            if (isOpen) {
                panel.classList.remove('open');
            } else {
                if (!bgPickerRendered) {
                    renderBgGrid();
                    bgPickerRendered = true;
                }
                panel.classList.add('open');
            }
        }

        function renderBgGrid() {
            const grid = document.getElementById('bg-thumb-grid');
            const currentBg = state.user?.settings?.chat_background || 'default';

            grid.innerHTML = BACKGROUNDS.map(bg => {
                const isActive = (currentBg === bg.id) || (currentBg === 'default' && bg.id === 'default');
                const label = bg.label || '';
                return `
                    <div class="bg-thumb-item${isActive ? ' active' : ''}" data-bg-id="${bg.id}" onclick="selectBackground('${bg.id}')">
                        <img src="${bg.thumb}" alt="${bg.id}" loading="lazy">
                        ${label ? `<div class="bg-thumb-label">${label}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function initBgLayer() {
            const app = document.getElementById('app');
            if (app.querySelector('.bg-layer')) return;
            const layer = document.createElement('div');
            layer.className = 'bg-layer';
            layer.style.backgroundImage = "url('images/bg.png')";
            app.insertBefore(layer, app.firstChild);
        }

        function selectBackground(bgId) {
            const bg = BACKGROUNDS.find(b => b.id === bgId);
            if (!bg) return;

            const app = document.getElementById('app');
            const newUrl = bgId === 'default'
                ? "url('images/bg.png')"
                : `url('images/Background/${bg.file}')`;

            // Preload image then crossfade
            const img = new Image();
            const src = bgId === 'default' ? 'images/bg.png' : `images/Background/${bg.file}`;
            img.onload = function() {
                const oldLayer = app.querySelector('.bg-layer:not(.old)');
                const newLayer = document.createElement('div');
                newLayer.className = 'bg-layer';
                newLayer.style.backgroundImage = newUrl;
                newLayer.style.opacity = '0';
                app.insertBefore(newLayer, app.firstChild);
                // Force reflow then fade in
                void newLayer.offsetWidth;
                newLayer.style.opacity = '1';
                // Clean up inline opacity after transition so .old class can override later
                newLayer.addEventListener('transitionend', function handler() {
                    newLayer.style.opacity = '';
                    newLayer.removeEventListener('transitionend', handler);
                });
                if (oldLayer) {
                    oldLayer.style.opacity = '';
                    oldLayer.classList.add('old');
                    setTimeout(() => oldLayer.remove(), 700);
                }
            };
            img.src = src;

            // Update active state in grid
            document.querySelectorAll('.bg-thumb-item').forEach(item => {
                item.classList.toggle('active', item.dataset.bgId === bgId);
            });

            // Save to state
            if (!state.user.settings) state.user.settings = {};
            state.user.settings.chat_background = bgId;
            localStorage.setItem('soullink_user', JSON.stringify(state.user));

            // Persist to backend (fire-and-forget)
            if (state.token) {
                authFetch(`${CONFIG.API_BASE_URL}/api/user/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ chat_background: bgId })
                }).catch(err => console.error('Save background error:', err));
            }
        }

        function loadBackground() {
            const app = document.getElementById('app');
            initBgLayer();
            const bgId = state.user?.settings?.chat_background;
            if (!bgId || bgId === 'default') return;

            const bg = BACKGROUNDS.find(b => b.id === bgId);
            if (bg) {
                const layer = app.querySelector('.bg-layer');
                if (layer) {
                    layer.style.backgroundImage = `url('images/Background/${bg.file}')`;
                }
            }
        }

        // Close bg picker when clicking outside
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('bg-picker-panel');
            const btn = document.querySelector('.bg-picker-btn');
            if (panel && panel.classList.contains('open')) {
                if (!panel.contains(e.target) && !btn.contains(e.target)) {
                    panel.classList.remove('open');
                }
            }
        });

        // Show scrollbar only while scrolling
        (function() {
            let scrollTimer;
            const list = document.getElementById('conversations-list');
            if (!list) return;
            list.addEventListener('scroll', function() {
                list.classList.add('scrolling');
                clearTimeout(scrollTimer);
                scrollTimer = setTimeout(() => list.classList.remove('scrolling'), 800);
            });
        })();
    </script>
</body>
</html>
